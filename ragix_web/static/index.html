<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAGIX Web UI</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- D3.js for graph visualization (v0.33.1) -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 4px;
            padding: 0 20px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
        }
        .nav-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.05);
        }
        .nav-tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        /* v0.33: Fixed height chain for scrollable sidebar */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .tab-content {
            display: none;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        /* AST Panel */
        .ast-panel {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        .ast-header {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .ast-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .project-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .project-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
        }
        .viz-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .viz-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .viz-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }
        .viz-card h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .viz-card p {
            margin: 0;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .viz-icon {
            font-size: 24px;
        }
        .ast-status {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .ast-status.available {
            background: rgba(35, 134, 54, 0.2);
            border: 1px solid #238636;
            color: #3fb950;
        }
        .ast-status.unavailable {
            background: rgba(218, 54, 51, 0.2);
            border: 1px solid #da3633;
            color: #f85149;
        }
        /* =================================================================
           Audit Tab Styles (v0.4)
           ================================================================= */
        .audit-panel {
            padding: 20px;
            flex: 1;
            min-height: 0;
            display: block;  /* Block layout for natural scrolling */
            overflow-y: auto;
            overflow-x: hidden;
        }
        /* Ensure scrollbar is always visible when content overflows */
        .audit-panel::-webkit-scrollbar {
            width: 12px;
        }
        .audit-panel::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 6px;
        }
        .audit-panel::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 6px;
            border: 2px solid var(--bg-secondary);
        }
        .audit-panel::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }
        /* Give sections min-height so panel has content to scroll */
        .audit-section-content {
            min-height: 200px;
        }
        .risk-matrix-container {
            min-height: 300px;
        }
        .audit-table-wrapper {
            max-height: 350px;
            overflow-y: auto;
        }
        .audit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .audit-header h2 {
            margin: 0;
            color: var(--text-primary);
        }
        .audit-header-actions {
            display: flex;
            gap: 10px;
        }
        /* Project Selection Row */
        .audit-project-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .audit-project-input {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .audit-project-input label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .audit-project-input input {
            flex: 1;
            padding: 8px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }
        .audit-project-row .btn-icon-left {
            margin-right: 6px;
        }
        /* Sources Status Badges */
        .audit-sources {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .source-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
        }
        .source-badge[data-available="true"] {
            border-color: #238636;
            background: rgba(35, 134, 54, 0.1);
        }
        .source-badge[data-available="true"] .source-status {
            color: #3fb950;
        }
        .source-badge[data-available="false"] {
            opacity: 0.6;
        }
        .source-icon {
            font-size: 16px;
        }
        .source-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .source-status {
            font-size: 11px;
            color: var(--text-secondary);
        }
        /* Summary Cards */
        .audit-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .audit-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }
        .audit-card-icon {
            font-size: 28px;
            opacity: 0.8;
        }
        .audit-card-icon.risk-high {
            color: #f85149;
        }
        .audit-card-icon.drift-alert {
            color: #d29922;
        }
        .audit-card-content {
            display: flex;
            flex-direction: column;
        }
        .audit-card-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .audit-card-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        /* Main Content Grid */
        .audit-main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 1200px) {
            .audit-main-content {
                grid-template-columns: 1fr;
            }
        }
        /* Spacing for direct children of audit-panel */
        .audit-panel > .audit-section {
            margin-bottom: 20px;
        }
        .audit-panel > .audit-header {
            margin-bottom: 20px;
        }
        /* Audit Section Fullscreen Mode */
        .audit-section.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            background: var(--bg-primary, #1e1e1e) !important;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .audit-section.fullscreen .audit-section-header {
            flex-shrink: 0;
        }
        .audit-section.fullscreen .audit-section-content {
            flex: 1 !important;
            min-height: 0 !important;
            max-height: none !important;
            height: auto !important;
            overflow-y: auto;
            padding: 20px;
        }
        .audit-section.fullscreen .audit-table-wrapper {
            max-height: none !important;
            height: calc(100vh - 180px);
            overflow-y: auto;
        }
        .audit-section.fullscreen .risk-matrix-container {
            height: calc(100vh - 180px) !important;
            max-height: none !important;
            min-height: 0 !important;
        }
        .audit-section.fullscreen .audit-section-content .risk-matrix-container {
            height: 100% !important;
        }
        .audit-section.fullscreen .insights-result {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }
        .audit-section.fullscreen .audit-drift-list {
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }
        /* Audit Sections */
        .audit-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }
        .audit-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            user-select: none;
        }
        .audit-section-header:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        .audit-section-header h3 {
            margin: 0;
            font-size: 15px;
            color: var(--text-primary);
        }
        .audit-section-toggle {
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }
        .audit-section-toggle.collapsed {
            transform: rotate(-90deg);
        }
        .audit-section-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: auto;
        }
        .audit-section-badge {
            background: var(--accent-color);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: auto;
        }
        /* Fullscreen button in audit section header */
        .audit-section-header .btn.btn-sm.btn-icon {
            padding: 4px 8px;
            font-size: 14px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .audit-section-header .btn.btn-sm.btn-icon:hover {
            color: var(--accent-color);
            border-color: var(--accent-color);
            background: rgba(79, 195, 247, 0.1);
        }
        .audit-section-content {
            padding: 15px;
        }
        .audit-section-content.collapsed {
            display: none;
        }
        /* Risk Matrix */
        .risk-matrix-container {
            width: 100%;
            height: 300px;
            position: relative;
        }
        .risk-matrix-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
        }
        .risk-matrix-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-dot.low { background: #238636; }
        .legend-dot.medium { background: #d29922; }
        .legend-dot.high { background: #da3633; }
        .legend-dot.critical { background: #8b0000; }
        /* Service Profiles Table */
        .audit-table-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .audit-table-controls input {
            flex: 1;
            padding: 8px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }
        .audit-table-controls select {
            padding: 8px 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }
        .audit-table-wrapper {
            max-height: 350px;
            overflow-y: auto;
        }
        .audit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .audit-table th,
        .audit-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .audit-table th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .audit-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        .audit-table-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 30px !important;
        }
        /* Risk Badges */
        .risk-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .risk-badge.low {
            background: rgba(35, 134, 54, 0.2);
            color: #3fb950;
        }
        .risk-badge.medium {
            background: rgba(210, 153, 34, 0.2);
            color: #d29922;
        }
        .risk-badge.high {
            background: rgba(218, 54, 51, 0.2);
            color: #f85149;
        }
        .risk-badge.critical {
            background: rgba(139, 0, 0, 0.3);
            color: #ff6b6b;
        }
        /* Category Badges */
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            background: var(--code-bg);
            color: var(--text-secondary);
        }
        .category-badge.legacy_hot {
            background: rgba(218, 54, 51, 0.15);
            color: #f85149;
        }
        .category-badge.active {
            background: rgba(35, 134, 54, 0.15);
            color: #3fb950;
        }
        .category-badge.new {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }
        .category-badge.frozen {
            background: rgba(139, 148, 158, 0.15);
            color: #8b949e;
        }
        /* Drift Alerts */
        .audit-drift-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .audit-drift-filters label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .audit-drift-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .audit-drift-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }
        .drift-alert-card {
            display: flex;
            gap: 12px;
            padding: 12px 15px;
            background: var(--code-bg);
            border-radius: 8px;
            border-left: 4px solid var(--border-color);
        }
        .drift-alert-card.critical {
            border-left-color: #8b0000;
        }
        .drift-alert-card.error {
            border-left-color: #da3633;
        }
        .drift-alert-card.warning {
            border-left-color: #d29922;
        }
        .drift-alert-card.info {
            border-left-color: #58a6ff;
        }
        .drift-alert-icon {
            font-size: 18px;
        }
        .drift-alert-content {
            flex: 1;
        }
        .drift-alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .drift-alert-component {
            font-weight: 600;
            color: var(--text-primary);
        }
        .drift-alert-type {
            font-size: 11px;
            padding: 2px 8px;
            background: var(--card-bg);
            border-radius: 4px;
            color: var(--text-secondary);
        }
        .drift-alert-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .drift-alert-meta {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* AI Insights Section */
        .audit-insights-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        .insight-select {
            padding: 6px 12px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .insights-placeholder {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }
        .insights-placeholder .muted {
            font-size: 13px;
            margin-top: 10px;
        }
        .insights-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .insights-result {
            padding: 15px;
            min-height: 200px;
            max-height: 350px;
            overflow-y: auto;
        }
        .insights-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
        }
        .insights-text {
            line-height: 1.7;
            font-size: 14px;
        }
        .insights-text h2, .insights-text h3, .insights-text h4 {
            margin: 20px 0 10px 0;
            color: var(--accent-color);
        }
        .insights-text h2 { font-size: 1.3em; }
        .insights-text h3 { font-size: 1.15em; }
        .insights-text h4 { font-size: 1.05em; }
        .insights-text p {
            margin-bottom: 12px;
        }
        .insights-text ul, .insights-text ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        .insights-text li {
            margin-bottom: 6px;
        }
        .insights-text strong {
            color: var(--text-primary);
        }
        .insights-text code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        /* Audit Settings Modal */
        .audit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .audit-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
        }
        .audit-modal-content {
            position: relative;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        .audit-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        .audit-modal-header h3 {
            margin: 0;
            font-size: 16px;
        }
        .audit-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        .audit-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }
        .settings-section {
            margin-bottom: 24px;
        }
        .settings-section h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--accent-color);
        }
        .settings-note {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0 0 12px 0;
        }
        .settings-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        .settings-row label {
            width: 140px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .settings-row input[type="number"] {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 13px;
        }
        .settings-hint {
            font-size: 11px;
            color: var(--text-secondary);
            flex: 1;
        }
        .settings-row.weight-total {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .settings-row.weight-total span {
            font-weight: 600;
            color: var(--accent-color);
        }

        /* Report Section */
        .audit-report-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
            padding: 15px;
        }
        .report-option-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .report-option-group label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .report-select {
            padding: 8px 12px;
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            min-width: 180px;
        }
        .report-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        /* Logs Panel */
        .logs-panel {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        /* Logs Content - Scrollable container with visible slider */
        .logs-content {
            flex: 1;
            min-height: 150px;
            max-height: calc(100vh - 350px);
            background: var(--code-bg);
            border-radius: 6px;
            padding: 15px;
            padding-right: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: scroll;
            overflow-x: hidden;
            white-space: pre-wrap;
            scrollbar-width: auto;
            scrollbar-color: var(--accent-green) var(--bg-tertiary);
        }
        .logs-content::-webkit-scrollbar {
            width: 12px;
            background: var(--bg-tertiary);
        }
        .logs-content::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin: 4px;
        }
        .logs-content::-webkit-scrollbar-thumb {
            background: var(--accent-green);
            border-radius: 6px;
            border: 2px solid var(--bg-tertiary);
            min-height: 40px;
        }
        .logs-content::-webkit-scrollbar-thumb:hover {
            background: #7ee787;
        }
        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }
        .log-cmd { color: #79c0ff; }
        .log-edit { color: #ffa657; }
        .log-error { color: #f85149; }
        .log-event { color: #a5d6ff; }
        /* Agent and Workflow Lists */
        .agent-list, .workflow-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .agent-item, .workflow-item {
            padding: 8px 10px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        .agent-item:hover, .workflow-item:hover {
            border-color: var(--accent-color);
            background: rgba(88, 166, 255, 0.1);
        }
        .agent-item.selected, .workflow-item.selected {
            border-color: var(--accent-color);
            background: rgba(88, 166, 255, 0.2);
        }
        .workflow-toggle {
            padding: 6px 10px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .workflow-toggle:hover {
            color: var(--accent-color);
            background: rgba(88, 166, 255, 0.1);
        }
        .workflow-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .workflow-desc {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .agent-icon {
            font-size: 16px;
            margin-right: 6px;
        }
        .agent-name, .workflow-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .agent-desc, .workflow-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        /* Trace Items */
        .trace-item {
            padding: 10px;
            background: var(--code-bg);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .trace-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .trace-type {
            font-weight: 500;
            color: var(--accent-color);
        }
        .trace-time {
            color: var(--text-secondary);
            font-size: 11px;
        }
        .trace-detail {
            color: var(--text-secondary);
            word-break: break-all;
        }
        /* Logs Toolbar */
        .logs-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .logs-toolbar select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .settings-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .settings-tab:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }
        .settings-tab.active {
            background: var(--accent-color);
            color: #fff;
        }
        .settings-content {
            display: none;
        }
        .settings-content.active {
            display: block;
        }
        /* Agent Settings */
        .agent-settings-header h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: var(--text-primary);
        }
        .settings-desc {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 20px;
        }
        .agent-mode-toggle {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .toggle-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }
        .toggle-text {
            font-weight: 500;
            color: var(--text-primary);
        }
        .mode-hint {
            display: block;
            margin-top: 8px;
            color: var(--text-secondary);
            font-size: 12px;
        }
        .per-agent-models {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .per-agent-models .form-group {
            margin-bottom: 15px;
        }
        .per-agent-models .form-group:last-child {
            margin-bottom: 0;
        }
        .vram-warning {
            background: rgba(218, 54, 51, 0.15);
            border: 1px solid #da3633;
            border-radius: 8px;
            padding: 12px 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .vram-warning .warning-icon {
            font-size: 20px;
            color: #f85149;
        }
        .vram-warning .warning-text {
            color: #f85149;
            font-size: 13px;
        }
        .config-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .session-note {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }
        /* Reasoning Panel */
        .reasoning-panel {
            padding: 20px;
            height: calc(100vh - 160px);
            max-height: calc(100vh - 160px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .reasoning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .reasoning-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .reasoning-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .reasoning-controls select {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        .agent-config-summary {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        .agent-config-summary h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .config-cards {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .config-card {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 150px;
        }
        .config-card.config-mode {
            background: rgba(88, 166, 255, 0.1);
            border-color: var(--accent-color);
        }
        .config-icon {
            font-size: 24px;
        }
        .config-info {
            display: flex;
            flex-direction: column;
        }
        .config-role {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .config-model {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .config-note {
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 166, 87, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #ffa657;
        }
        .note-icon {
            font-size: 16px;
        }
        /* Reasoning Timeline - Scrollable container with visible slider */
        .reasoning-timeline {
            flex: 1;
            min-height: 200px;
            max-height: calc(100vh - 550px);
            overflow-y: scroll;
            overflow-x: hidden;
            background: var(--code-bg);
            border-radius: 8px;
            padding: 15px;
            padding-right: 8px;
            scrollbar-width: auto;
            scrollbar-color: var(--accent-blue) var(--bg-tertiary);
        }
        .reasoning-timeline::-webkit-scrollbar {
            width: 12px;
            background: var(--bg-tertiary);
        }
        .reasoning-timeline::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin: 4px;
        }
        .reasoning-timeline::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 6px;
            border: 2px solid var(--bg-tertiary);
            min-height: 40px;
        }
        .reasoning-timeline::-webkit-scrollbar-thumb:hover {
            background: #5bcfff;
        }
        .reasoning-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .reasoning-empty .empty-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .reasoning-empty p {
            margin: 0 0 8px 0;
        }
        .reasoning-empty .empty-hint {
            font-size: 12px;
            opacity: 0.7;
        }

        /* v0.23 Reasoning Graph Styles */
        .reasoning-graph-section {
            margin: 15px 0;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            flex-shrink: 0;
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-blue) var(--bg-tertiary);
        }
        .reasoning-graph-section::-webkit-scrollbar {
            width: 8px;
        }
        .reasoning-graph-section::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .reasoning-graph-section::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 4px;
        }
        .reasoning-graph-section h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: var(--accent-blue);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        .reasoning-graph-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .graph-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 4px;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        .status-indicator.checking { background: var(--accent-yellow); }
        .status-indicator.available { background: var(--accent-green); animation: none; }
        .status-indicator.unavailable { background: var(--accent-red); animation: none; }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .graph-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .graph-controls .btn-sm {
            padding: 6px 12px;
            font-size: 11px;
        }
        .graph-visualization {
            min-height: 150px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .graph-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }
        .graph-placeholder .graph-icon {
            font-size: 36px;
            display: block;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        .graph-placeholder p {
            margin: 0;
            font-size: 13px;
        }
        .graph-placeholder .graph-hint {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 8px;
        }
        .graph-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 4px;
        }
        .graph-stats .stat-item {
            text-align: center;
        }
        .graph-stats .stat-label {
            display: block;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .graph-stats .stat-value {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
        }
        /* Graph node flow visualization */
        .graph-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            padding: 15px;
        }
        .graph-node {
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s;
        }
        .graph-node.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #fff;
            box-shadow: 0 0 12px rgba(79, 195, 247, 0.4);
        }
        .graph-node.visited {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
        .graph-node.failed {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }
        .graph-arrow {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* v0.32 Memory Context Section in Reasoning Tab */
        .memory-context-section {
            margin: 15px 0;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            border-left: 3px solid var(--accent-purple);
        }
        .memory-context-section h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: var(--accent-purple);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .memory-context-section h3 .memory-icon {
            font-size: 16px;
        }
        .memory-context-search {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .memory-context-search input {
            flex: 1;
            padding: 6px 10px;
            font-size: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
        }
        .memory-context-search input:focus {
            outline: none;
            border-color: var(--accent-purple);
        }
        .memory-context-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .memory-context-controls .btn-sm {
            padding: 5px 10px;
            font-size: 11px;
        }
        .memory-context-controls .btn-sm.active {
            background: var(--accent-purple);
            color: #fff;
        }
        .memory-context-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 4px;
            margin-bottom: 12px;
        }
        .memory-context-stats .stat-item {
            text-align: center;
        }
        .memory-context-stats .stat-label {
            display: block;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 3px;
        }
        .memory-context-stats .stat-value {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-purple);
        }
        .memory-context-list {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        .memory-context-entry {
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
            font-size: 12px;
        }
        .memory-context-entry:last-child {
            margin-bottom: 0;
        }
        .memory-context-entry.used-in-reasoning {
            border-left-color: var(--accent-green);
            background: rgba(86, 211, 100, 0.05);
        }
        .memory-context-entry .memory-goal {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .memory-context-entry .memory-result {
            color: var(--text-secondary);
            font-size: 11px;
        }
        .memory-context-entry .memory-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 10px;
            color: var(--text-muted);
        }
        .memory-context-entry .memory-files {
            color: var(--accent-blue);
        }
        .memory-context-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }
        .memory-context-empty .empty-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
            opacity: 0.5;
        }
        .memory-used-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(86, 211, 100, 0.15);
            color: var(--accent-green);
        }

        /* Memory Details Modal (v0.32) */
        .memory-details {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .memory-details-header {
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .memory-details-header h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: var(--accent-purple);
        }
        .memory-details-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .memory-details-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .memory-details-section {
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
        }
        .memory-details-section h4 {
            margin: 0 0 8px 0;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }
        .memory-details-section.plan {
            border-left-color: var(--accent-purple);
        }
        .memory-details-section.result {
            border-left-color: var(--accent-green);
        }
        .memory-details-section.decisions {
            border-left-color: var(--accent-yellow);
        }
        .memory-details-section.files {
            border-left-color: var(--accent-blue);
        }
        .memory-details-section.commands {
            border-left-color: var(--accent-orange, #f0883e);
        }
        .memory-details-section p {
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .memory-details-section ul {
            margin: 0;
            padding-left: 20px;
            font-size: 12px;
        }
        .memory-details-section li {
            margin-bottom: 4px;
            word-break: break-all;
        }
        .memory-details-section code {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
            max-width: 100%;
            overflow-x: auto;
        }
        .memory-details-empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .reasoning-trace {
            margin-bottom: 15px;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
        }
        .reasoning-trace.type-planning {
            border-left-color: #b392f0;
        }
        .reasoning-trace.type-execution {
            border-left-color: #56d364;
        }
        .reasoning-trace.type-verification {
            border-left-color: #ffa657;
        }
        .trace-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .trace-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: var(--accent-color);
            color: #fff;
            text-transform: uppercase;
        }
        .trace-type-badge.planning { background: #b392f0; }
        .trace-type-badge.execution { background: #56d364; }
        .trace-type-badge.verification { background: #ffa657; }
        .trace-timestamp {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .trace-content {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .trace-thinking {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>RAGIX</h1>
                <span class="version" id="app-version">v...</span>
            </div>
            <div class="header-right">
                <span id="status" class="status status-disconnected">Disconnected</span>
                <button id="settingsBtn" class="btn btn-icon" title="Settings">&#9881;</button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="chat">Chat</button>
            <button class="nav-tab" data-tab="reasoning">Reasoning</button>
            <button class="nav-tab" data-tab="ast">AST Analysis</button>
            <button class="nav-tab" data-tab="rag">Project RAG</button>
            <button class="nav-tab" data-tab="audit">Audit</button>
            <button class="nav-tab" data-tab="logs">Logs</button>
        </nav>

        <!-- Tab Contents -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="dashboard-panel">
                    <div class="dashboard-header">
                        <h2>RAGIX Dashboard</h2>
                        <p class="dashboard-subtitle">Local-first development assistant with AST analysis</p>
                    </div>

                    <!-- Project Selector -->
                    <div class="dashboard-section">
                        <h3>Project Selection</h3>
                        <div class="project-selector">
                            <div class="project-input-row">
                                <input type="text" id="dashboardProjectPath" placeholder="Enter project path or select from recent..." />
                                <button class="btn btn-icon" onclick="folderBrowser.open('dashboardProjectPath')" title="Browse folders">&#128193;</button>
                                <button class="btn btn-primary" onclick="dashboardApp.loadProject()">Load Project</button>
                            </div>
                            <div id="recentProjects" class="recent-projects">
                                <p class="recent-empty">No recent projects. Enter a path above to get started.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="dashboard-section">
                        <h3>Quick Stats</h3>
                        <div id="dashboardStats" class="dashboard-stats">
                            <div class="dash-stat-card">
                                <span class="dash-stat-icon">&#128187;</span>
                                <div class="dash-stat-info">
                                    <span class="dash-stat-value" id="dashStatFiles">-</span>
                                    <span class="dash-stat-label">Source Files</span>
                                </div>
                            </div>
                            <div class="dash-stat-card">
                                <span class="dash-stat-icon">&#128200;</span>
                                <div class="dash-stat-info">
                                    <span class="dash-stat-value" id="dashStatSymbols">-</span>
                                    <span class="dash-stat-label">Symbols</span>
                                </div>
                            </div>
                            <div class="dash-stat-card">
                                <span class="dash-stat-icon">&#128279;</span>
                                <div class="dash-stat-info">
                                    <span class="dash-stat-value" id="dashStatDeps">-</span>
                                    <span class="dash-stat-label">Dependencies</span>
                                </div>
                            </div>
                            <div class="dash-stat-card">
                                <span class="dash-stat-icon">&#9888;</span>
                                <div class="dash-stat-info">
                                    <span class="dash-stat-value" id="dashStatDebt">-</span>
                                    <span class="dash-stat-label">Tech Debt (hours)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Project RAG Indexing -->
                    <div class="dashboard-section">
                        <h3>Project RAG Index</h3>
                        <div id="projectRagStatus" class="rag-status-panel">
                            <div class="rag-status-row">
                                <span class="status-dot" id="ragStatusDot"></span>
                                <span class="status-text" id="ragStatusText">Select a project to enable RAG indexing</span>
                            </div>
                            <!-- GPU indicator -->
                            <div id="ragGpuStatus" class="rag-gpu-status" style="display: none;">
                                <span id="ragGpuIcon" class="rag-gpu-icon">&#9889;</span>
                                <span id="ragGpuText">GPU: Checking...</span>
                            </div>
                            <div id="ragIndexStats" class="rag-index-stats" style="display: none;">
                                <div class="rag-stat">
                                    <span class="rag-stat-value" id="ragStatFiles">0</span>
                                    <span class="rag-stat-label">Files</span>
                                </div>
                                <div class="rag-stat">
                                    <span class="rag-stat-value" id="ragStatChunks">0</span>
                                    <span class="rag-stat-label">Chunks</span>
                                </div>
                                <div class="rag-stat">
                                    <span class="rag-stat-value" id="ragStatProgress">0%</span>
                                    <span class="rag-stat-label">Progress</span>
                                </div>
                                <div class="rag-stat">
                                    <span class="rag-stat-value" id="ragStatTime">-</span>
                                    <span class="rag-stat-label">Elapsed</span>
                                </div>
                                <div class="rag-stat">
                                    <span class="rag-stat-value" id="ragStatEta">-</span>
                                    <span class="rag-stat-label">ETA</span>
                                </div>
                                <div class="rag-stat">
                                    <span class="rag-stat-value" id="ragStatSize">-</span>
                                    <span class="rag-stat-label">Size</span>
                                </div>
                            </div>
                            <div id="ragProgressBar" class="rag-progress-bar" style="display: none;">
                                <div class="rag-progress-fill" id="ragProgressFill"></div>
                            </div>
                            <div class="rag-actions">
                                <select id="ragProfileSelect" class="rag-profile-select">
                                    <option value="mixed_docs_code">Mixed (Docs + Code)</option>
                                    <option value="docs_only">Documentation Only</option>
                                    <option value="code_only">Code Only</option>
                                </select>
                                <button class="btn btn-primary" id="ragIndexBtn" onclick="projectRagApp.startIndexing()">
                                    Index Project
                                </button>
                                <button class="btn" id="ragStopBtn" onclick="projectRagApp.stopIndexing()" style="display: none;">
                                    Stop
                                </button>
                                <button class="btn btn-danger" id="ragDeleteBtn" onclick="projectRagApp.deleteIndex()" style="display: none;">
                                    Delete Index
                                </button>
                            </div>
                            <p class="rag-hint">RAG indexing enables intelligent project-wide search in chat. Supports code, docs, PDF, PPTX, XLSX.</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="dashboard-section">
                        <h3>Quick Actions</h3>
                        <div class="quick-actions">
                            <button class="action-btn" onclick="dashboardApp.goToChat()">
                                <span class="action-icon">&#128172;</span>
                                <span class="action-label">Start Chat</span>
                                <span class="action-desc">Talk to the AI assistant</span>
                            </button>
                            <button class="action-btn" onclick="dashboardApp.goToAST()">
                                <span class="action-icon">&#128202;</span>
                                <span class="action-label">Analyze Code</span>
                                <span class="action-desc">Run AST analysis</span>
                            </button>
                            <button class="action-btn" onclick="dashboardApp.goToLogs()">
                                <span class="action-icon">&#128196;</span>
                                <span class="action-label">View Logs</span>
                                <span class="action-desc">Check command history</span>
                            </button>
                            <button class="action-btn" onclick="dashboardApp.goToSettings()">
                                <span class="action-icon">&#9881;</span>
                                <span class="action-label">Settings</span>
                                <span class="action-desc">Configure AI model</span>
                            </button>
                        </div>
                    </div>

                    <!-- System Status -->
                    <div class="dashboard-section">
                        <h3>System Status</h3>
                        <div id="systemStatus" class="system-status">
                            <div class="status-item">
                                <span class="status-dot" id="ollamaStatusDot"></span>
                                <span class="status-text" id="ollamaStatusText">Checking Ollama...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot" id="astStatusDot"></span>
                                <span class="status-text" id="astStatusText">Checking AST...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot" id="sandboxStatusDot"></span>
                                <span class="status-text" id="sandboxStatusText">Sandbox: Loading...</span>
                            </div>
                            <div class="status-item">
                                <span class="status-dot" id="cacheStatusDot"></span>
                                <span class="status-text" id="cacheStatusText">Cache: Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chatTab" class="tab-content">
                <div class="main-layout">
                    <!-- Sidebar -->
                    <aside class="sidebar" id="chatSidebar">
                        <!-- v0.33: Resize handle for draggable sidebar width -->
                        <div class="sidebar-resize-handle" id="sidebarResizeHandle"></div>
                        <div class="sidebar-inner">
                            <!-- Threads Section (v0.33) -->
                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    Threads
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div class="threads-explorer">
                                        <!-- Thread Actions -->
                                        <div class="thread-actions">
                                            <button class="btn btn-small btn-primary" onclick="app.createThread()" title="Create new thread">
                                                + New Thread
                                            </button>
                                        </div>
                                        <!-- Thread List -->
                                        <div id="threadList" class="thread-list">
                                            <p style="color: var(--text-secondary); font-size: 12px;">Loading threads...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    Session
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div id="sessionInfo" class="session-info">
                                        <div class="info-row">
                                            <span class="label">Sandbox</span>
                                            <span id="sandboxPath" class="value" title="Scroll to see full path">-</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="label">Model</span>
                                            <span id="modelName" class="value short">-</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="label">Profile</span>
                                            <span id="profileName" class="value short">-</span>
                                        </div>
                                        <div class="info-row">
                                            <span class="label">Reasoning</span>
                                            <span id="reasoningStrategy" class="value short">-</span>
                                        </div>
                                        <!-- Model Info (v0.32.1 - dynamic from Ollama API) -->
                                        <div class="model-info-row" id="modelInfoRow">
                                            <div class="model-info-item" title="Model quantization level">
                                                <span class="model-info-label">Quant</span>
                                                <span id="modelQuantization" class="model-info-value">-</span>
                                            </div>
                                            <div class="model-info-item" title="VRAM usage">
                                                <span class="model-info-label">VRAM</span>
                                                <span id="modelVram" class="model-info-value">-</span>
                                            </div>
                                            <div class="model-info-item" title="Parameter count">
                                                <span class="model-info-label">Size</span>
                                                <span id="modelParamSize" class="model-info-value">-</span>
                                            </div>
                                        </div>
                                        <!-- Context Window Indicator -->
                                        <div class="context-window-indicator" id="contextWindowIndicator">
                                            <div class="context-label">
                                                <span>Context</span>
                                                <span id="contextUsageText" class="context-usage-text">0 / 32k</span>
                                            </div>
                                            <div class="context-bar-container">
                                                <div id="contextBar" class="context-bar" style="width: 0%"></div>
                                            </div>
                                            <button id="compactBtn" class="compact-btn hidden" onclick="app.compactMemory()" title="Compact memory to free context space">
                                                 Compact
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Global Context Section (v0.33) -->
                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    Global Context
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div class="context-editor">
                                        <div class="context-info">
                                            <span class="context-hint">Instructions included in all messages</span>
                                        </div>
                                        <textarea
                                            id="globalContextInput"
                                            class="context-textarea"
                                            placeholder="Add custom instructions here (e.g., coding style, project rules)..."
                                            rows="3"
                                        ></textarea>
                                        <div class="context-actions">
                                            <span id="contextCharCount" class="context-char-count">0 chars</span>
                                            <button class="btn btn-small" onclick="app.saveGlobalContext()" title="Save context">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    Agents
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div id="agentList" class="agent-list">
                                        <p style="color: var(--text-secondary); font-size: 12px;">Loading agents...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    Memory Explorer
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div class="memory-explorer">
                                        <!-- Memory Stats -->
                                        <div class="memory-stats" id="memoryStats">
                                            <div class="stat-row">
                                                <span class="stat-label">Episodes</span>
                                                <span id="memoryEpisodeCount" class="stat-value">0</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Files Touched</span>
                                                <span id="memoryFilesCount" class="stat-value">0</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Commands</span>
                                                <span id="memoryCommandsCount" class="stat-value">0</span>
                                            </div>
                                        </div>
                                        <!-- Memory Search -->
                                        <div class="memory-search">
                                            <input type="text" id="memorySearchInput" placeholder="Search memories..." class="memory-search-input">
                                        </div>
                                        <!-- Memory List -->
                                        <div id="memoryList" class="memory-list">
                                            <p style="color: var(--text-secondary); font-size: 12px;">No episodes yet</p>
                                        </div>
                                        <!-- Memory Actions -->
                                        <div class="memory-actions">
                                            <button class="btn btn-small" onclick="app.refreshMemory()"> Refresh</button>
                                            <button class="btn btn-small btn-danger" onclick="app.clearMemory()"> Clear All</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    Workflows
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div id="workflowList" class="workflow-list">
                                        <p style="color: var(--text-secondary); font-size: 12px;">Loading workflows...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- RAG Section (v0.33) -->
                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    RAG
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div class="rag-explorer">
                                        <!-- RAG Status -->
                                        <div class="rag-status" id="ragStatus">
                                            <!-- Project RAG Toggle (v0.33) -->
                                            <div class="rag-toggle-row rag-toggle-project">
                                                <span class="rag-toggle-label" title="Project-wide RAG from .RAG/ index (ChromaDB)">
                                                    <span class="rag-type-icon"></span> Project RAG
                                                </span>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="projectRagToggle" checked onchange="app.toggleProjectRag(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div class="rag-toggle-hint" id="projectRagHint">
                                                <small>Injects context from indexed project (.RAG/)</small>
                                            </div>

                                            <!-- Chat RAG Toggle -->
                                            <div class="rag-toggle-row rag-toggle-chat">
                                                <span class="rag-toggle-label" title="Session-scoped RAG from uploaded files (.ragix/)">
                                                    <span class="rag-type-icon"></span> Chat RAG
                                                </span>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="ragEnabledToggle" onchange="app.toggleRag(this.checked)">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div class="rag-toggle-hint">
                                                <small>Session files uploaded below (.ragix/)</small>
                                            </div>

                                            <div class="rag-stats" id="ragStats">
                                                <div class="stat-row">
                                                    <span class="stat-label">Chat Index</span>
                                                    <span id="ragIndexStatus" class="stat-value">Not loaded</span>
                                                </div>
                                                <div class="stat-row">
                                                    <span class="stat-label">Documents</span>
                                                    <span id="ragDocCount" class="stat-value">0</span>
                                                </div>
                                                <div class="stat-row">
                                                    <span class="stat-label">Chunks</span>
                                                    <span id="ragChunkCount" class="stat-value">0</span>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- v0.33: RAG Indexing Options -->
                                        <div class="rag-config" id="ragConfig">
                                            <div class="config-row">
                                                <label title="Characters per chunk">Chunk:</label>
                                                <input type="number" id="ragChunkSize" value="1000" min="200" max="5000" step="100" class="config-input-small">
                                            </div>
                                            <div class="config-row">
                                                <label title="Overlap between chunks">Overlap:</label>
                                                <input type="number" id="ragChunkOverlap" value="200" min="0" max="1000" step="50" class="config-input-small">
                                            </div>
                                            <div class="config-row converter-row">
                                                <label title="Document converters">Conv:</label>
                                                <label class="converter-option" title="PDF conversion via pdftotext">
                                                    <input type="checkbox" id="ragPdfEnabled" checked> PDF
                                                </label>
                                                <label class="converter-option" title="Office docs via pandoc (docx, pptx, xlsx)">
                                                    <input type="checkbox" id="ragPandocEnabled" checked> Office
                                                </label>
                                            </div>
                                        </div>
                                        <!-- RAG Actions -->
                                        <div class="rag-actions">
                                            <button class="btn btn-small btn-primary" onclick="document.getElementById('ragFileInput').click()" title="Upload files to RAG index"> Upload</button>
                                            <input type="file" id="ragFileInput" class="hidden" multiple accept=".zip,.txt,.md,.py,.js,.ts,.json,.yaml,.yml,.xml,.html,.css,.sh,.sql,.csv,.pdf,.docx,.pptx,.xlsx,.odt,.java,.kt,.c,.cpp,.h,.go,.rs,.rb" onchange="app.handleRagFileUpload(event)" />
                                            <button class="btn btn-small" onclick="app.loadRagStatus()" title="Refresh RAG status"></button>
                                            <button class="btn btn-small" onclick="app.showRagBrowser()" title="Browse indexed documents"></button>
                                            <button class="btn btn-small" onclick="app.indexChatToRag()" title="Index chat history to RAG"></button>
                                            <button class="btn btn-small btn-danger" onclick="app.clearRagIndex()" title="Clear RAG index"></button>
                                        </div>
                                        <div class="rag-hint">
                                            <small> Upload files/ZIP |  saves chat</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="sidebar-section">
                                <h3 onclick="toggleSidebarSection(this)">
                                    Tools
                                    <span class="collapse-icon">&#9660;</span>
                                </h3>
                                <div class="sidebar-section-content">
                                    <div class="tool-list">
                                        <button class="tool-btn" onclick="app.showTraces()">View Traces</button>
                                        <button class="tool-btn" onclick="app.clearChat()">Clear Chat</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">&#9664;</button>

                    <!-- Chat Area -->
                    <main class="chat-area">
                        <div id="chatMessages" class="chat-messages"></div>

                        <!-- Quick Actions Bar -->
                        <div class="quick-actions-bar" id="quickActionsBar">
                            <div class="quick-actions-row">
                                <button class="quick-action-btn" onclick="app.loadQuickAction('folder')" title="Project Overview">
                                    <span class="qa-icon"></span>
                                </button>
                                <button class="quick-action-btn" onclick="app.loadQuickAction('chart')" title="Code Stats">
                                    <span class="qa-icon"></span>
                                </button>
                                <button class="quick-action-btn" onclick="app.loadQuickAction('clock')" title="Recent Changes">
                                    <span class="qa-icon"></span>
                                </button>
                                <button class="quick-action-btn" onclick="app.loadQuickAction('bug')" title="Find Bugs">
                                    <span class="qa-icon"></span>
                                </button>
                                <button class="quick-action-btn" onclick="app.loadQuickAction('link')" title="Dependencies">
                                    <span class="qa-icon"></span>
                                </button>
                                <select id="promptComplexity" class="prompt-complexity-select" onchange="app.loadPromptsByComplexity(this.value)">
                                    <option value="">Demo Prompts...</option>
                                    <option value="bypass"> BYPASS (Concepts)</option>
                                    <option value="simple"> SIMPLE (Single Command)</option>
                                    <option value="moderate"> MODERATE (Multi-step)</option>
                                    <option value="complex"> COMPLEX (Investigation)</option>
                                </select>
                            </div>
                            <div id="promptsList" class="prompts-list hidden"></div>
                        </div>

                        <!-- File Drop Zone -->
                        <div id="fileDropZone" class="file-drop-zone hidden">
                            <div class="file-drop-content">
                                <span class="file-drop-icon"></span>
                                <span class="file-drop-text">Drop files here to add to context</span>
                                <span class="file-drop-hint">Supports: .txt, .md, .py, .js, .json, .yaml, .pdf*, .docx*</span>
                            </div>
                        </div>
                        <div id="filePreview" class="file-preview hidden"></div>

                        <div class="chat-input-container">
                            <div class="input-actions">
                                <button id="attachFileBtn" class="btn btn-icon" title="Attach file" onclick="document.getElementById('fileInput').click()">
                                    
                                </button>
                                <input type="file" id="fileInput" class="hidden" multiple accept=".txt,.md,.py,.js,.ts,.json,.yaml,.yml,.xml,.html,.css,.sh,.sql,.csv,.pdf,.docx,.odt" />
                            </div>
                            <textarea
                                id="chatInput"
                                class="chat-input"
                                placeholder="Type your message... (Shift+Enter for new line, Enter to send)"
                                rows="3"
                            ></textarea>
                            <button id="sendBtn" class="btn btn-primary">Send</button>
                        </div>
                    </main>

                    <!-- Trace Panel (collapsible) -->
                    <aside id="tracePanel" class="trace-panel hidden">
                        <div class="trace-header">
                            <h3>Tool Traces</h3>
                            <button onclick="app.closeTraces()" class="btn btn-icon">&#10005;</button>
                        </div>
                        <div id="traceContent" class="trace-content">
                            <p class="trace-empty">No traces yet. Start chatting to see tool calls here.</p>
                        </div>
                    </aside>
                </div>
            </div>

            <!-- Reasoning Tab (Chain of Thought Viewer) -->
            <div id="reasoningTab" class="tab-content">
                <div class="reasoning-panel">
                    <div class="reasoning-header">
                        <h2>Agent Reasoning & Chain of Thought</h2>
                        <div class="reasoning-controls">
                            <button class="btn" onclick="reasoningApp.refresh()">Refresh</button>
                            <button class="btn" onclick="reasoningApp.clear()">Clear</button>
                            <select id="reasoningFilter" onchange="reasoningApp.filter()">
                                <option value="all">All Traces</option>
                                <option value="planning">Planning</option>
                                <option value="execution">Execution</option>
                                <option value="verification">Verification</option>
                            </select>
                        </div>
                    </div>

                    <!-- Agent Config Summary -->
                    <div id="agentConfigSummary" class="agent-config-summary">
                        <h3>Current Agent Configuration</h3>
                        <div class="config-cards">
                            <div class="config-card">
                                <span class="config-icon">&#129302;</span>
                                <div class="config-info">
                                    <span class="config-role">Planner</span>
                                    <span class="config-model" id="plannerModelDisplay">-</span>
                                </div>
                            </div>
                            <div class="config-card">
                                <span class="config-icon">&#128736;</span>
                                <div class="config-info">
                                    <span class="config-role">Worker</span>
                                    <span class="config-model" id="workerModelDisplay">-</span>
                                </div>
                            </div>
                            <div class="config-card">
                                <span class="config-icon">&#9989;</span>
                                <div class="config-info">
                                    <span class="config-role">Verifier</span>
                                    <span class="config-model" id="verifierModelDisplay">-</span>
                                </div>
                            </div>
                            <div class="config-card config-mode">
                                <span class="config-icon">&#9881;</span>
                                <div class="config-info">
                                    <span class="config-role">Mode</span>
                                    <span class="config-model" id="agentModeDisplay">minimal</span>
                                </div>
                            </div>
                        </div>
                        <div class="config-note" id="configNote">
                            <span class="note-icon">&#128161;</span>
                            <span id="configNoteText">Single-model mode recommended for 8GB VRAM to avoid load/unload overhead.</span>
                        </div>
                    </div>

                    <!-- Reasoning Graph Visualization -->
                    <div id="reasoningGraphSection" class="reasoning-graph-section">
                        <h3>Reasoning Graph</h3>
                        <div class="reasoning-graph-container">
                            <div class="graph-status" id="graphStatus">
                                <span class="status-indicator checking"></span>
                                <span id="graphStatusText">Checking graph availability...</span>
                            </div>
                            <div class="graph-controls">
                                <button class="btn btn-sm" onclick="reasoningGraph.refresh()">Refresh Status</button>
                                <button class="btn btn-sm" onclick="reasoningGraph.showNodes()">View Nodes</button>
                                <button class="btn btn-sm" onclick="reasoningGraph.showExperience()">Experience Corpus</button>
                                <button class="btn btn-sm" onclick="reasoningGraph.classify()">Classify Task</button>
                            </div>
                            <div class="graph-visualization" id="graphVisualization">
                                <div class="graph-placeholder">
                                    <span class="graph-icon">&#128200;</span>
                                    <p>Graph visualization will appear here during reasoning.</p>
                                    <p class="graph-hint">Nodes: CLASSIFY  PLAN  EXECUTE  VERIFY  RESPOND</p>
                                </div>
                            </div>
                            <div class="graph-stats" id="graphStats" style="display: none;">
                                <div class="stat-item">
                                    <span class="stat-label">Complexity</span>
                                    <span class="stat-value" id="graphComplexity">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Current Node</span>
                                    <span class="stat-value" id="graphCurrentNode">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Reflections</span>
                                    <span class="stat-value" id="graphReflections">0/2</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Status</span>
                                    <span class="stat-value" id="graphStopReason">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Memory Context (v0.32) -->
                    <div id="memoryContextSection" class="memory-context-section">
                        <h3><span class="memory-icon">&#129504;</span> Memory Context</h3>
                        <div class="memory-context-search">
                            <input type="text" id="memoryContextSearchInput" placeholder="Search memories..."
                                   onkeyup="memoryContext.handleSearchKeyup(event)">
                            <button class="btn btn-sm" onclick="memoryContext.search()">Search</button>
                        </div>
                        <div class="memory-context-controls">
                            <button class="btn btn-sm" onclick="memoryContext.refresh()">All</button>
                            <button class="btn btn-sm" id="memoryShowRelevantBtn" onclick="memoryContext.showRelevant()" title="Search memories matching current goal">Relevant</button>
                            <button class="btn btn-sm" id="memoryShowUsedBtn" onclick="memoryContext.showUsed()" title="Show memories used in current reasoning">Used (<span id="memoryUsedBtnCount">0</span>)</button>
                        </div>
                        <div class="memory-context-stats" id="memoryContextStats">
                            <div class="stat-item">
                                <span class="stat-label">Total</span>
                                <span class="stat-value" id="memoryTotalCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Sessions</span>
                                <span class="stat-value" id="memorySessionCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Goal</span>
                                <span class="stat-value" id="memoryCurrentGoal" title="Current reasoning goal">-</span>
                            </div>
                        </div>
                        <div class="memory-context-list" id="memoryContextList">
                            <div class="memory-context-empty">
                                <span class="empty-icon">&#128218;</span>
                                <p>No episodic memories yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Reasoning Timeline -->
                    <div class="reasoning-timeline" id="reasoningTimeline">
                        <div class="reasoning-empty">
                            <span class="empty-icon">&#129504;</span>
                            <p>No reasoning traces yet. Start a chat to see the agent's thinking process.</p>
                            <p class="empty-hint">The agent will show its planning, execution, and verification steps here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AST Analysis Tab -->
            <div id="astTab" class="tab-content">
                <div class="ast-panel">
                    <div class="ast-header">
                        <h2>AST Analysis & Visualization</h2>
                        <div id="astStatus" class="ast-status available">Checking AST availability...</div>
                    </div>

                    <div class="project-input-group">
                        <input type="text" id="projectPath" placeholder="Enter project path (e.g., /path/to/java/project)" />
                        <button class="btn btn-icon" onclick="folderBrowser.open('projectPath')" title="Browse folders">&#128193;</button>
                        <button class="btn btn-primary" onclick="astApp.analyze()">Analyze</button>
                    </div>

                    <h3>Visualizations</h3>
                    <div class="viz-cards">
                        <div class="viz-card" onclick="astApp.openGraph()">
                            <h3><span class="viz-icon">&#128200;</span> Dependency Graph</h3>
                            <p>Force-directed graph with package clustering, edge bundling, and interactive exploration.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openMatrix()">
                            <h3><span class="viz-icon">&#9638;</span> DSM Matrix</h3>
                            <p>Dependency Structure Matrix with heatmap coloring and cycle detection.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openRadial()">
                            <h3><span class="viz-icon">&#9673;</span> Radial Explorer</h3>
                            <p>Ego-centric visualization with focal node at center and dependencies radiating outward.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openMetrics()">
                            <h3><span class="viz-icon">&#128202;</span> Code Metrics</h3>
                            <p>Cyclomatic complexity, technical debt, maintainability index, and hotspots.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openTreemap()">
                            <h3><span class="viz-icon">&#9618;</span> Treemap</h3>
                            <p>Hierarchical package view with size by LOC, complexity, or technical debt.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openSunburst()">
                            <h3><span class="viz-icon">&#9788;</span> Sunburst</h3>
                            <p>Radial hierarchical diagram for module structure drill-down exploration.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openChord()">
                            <h3><span class="viz-icon">&#10226;</span> Chord Diagram</h3>
                            <p>Inter-module dependencies as circular chord connections.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openCycles()">
                            <h3><span class="viz-icon">&#128260;</span> Cycles Detection</h3>
                            <p>Detect and display circular dependencies in the codebase.</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 24px;">Build & Quality Tools</h3>
                    <div class="viz-cards">
                        <div class="viz-card" onclick="astApp.openMaven()">
                            <h3><span class="viz-icon">&#128230;</span> Maven Analysis</h3>
                            <p>Parse pom.xml files, show dependencies, detect version conflicts.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openSonar()">
                            <h3><span class="viz-icon">&#128269;</span> SonarQube</h3>
                            <p>Quality gate, bugs, vulnerabilities, code smells, coverage metrics.</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 24px;">Reports</h3>
                    <div class="viz-cards">
                        <div class="viz-card" onclick="astApp.openReport('executive')">
                            <h3><span class="viz-icon">&#128196;</span> Executive Summary</h3>
                            <p>High-level overview with health score, key metrics, and critical findings.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openReport('technical')">
                            <h3><span class="viz-icon">&#128209;</span> Technical Audit</h3>
                            <p>Detailed analysis with complexity hotspots, coupling metrics, and findings.</p>
                        </div>
                        <div class="viz-card" onclick="astApp.openReport('compliance')">
                            <h3><span class="viz-icon">&#9989;</span> Compliance Report</h3>
                            <p>Standards-based assessment (SonarQube, OWASP, ISO 25010) with remediation plan.</p>
                        </div>
                    </div>

                    <div id="astResults" style="margin-top: 20px;"></div>

                    <!-- Embedded Visualization Area (with fullscreen and resize support) -->
                    <div id="vizContainer" class="viz-container" style="display: none;">
                        <div class="viz-header">
                            <h3 id="vizTitle">Visualization</h3>
                            <div class="viz-header-actions">
                                <button class="btn btn-icon" onclick="astApp.toggleVizFullscreen()" title="Toggle Fullscreen" id="vizFullscreenBtn">&#9974;</button>
                                <button class="btn btn-icon" onclick="astApp.closeViz()" title="Close">&#10005;</button>
                            </div>
                        </div>
                        <div class="viz-frame-container" id="vizFrameContainer">
                            <iframe id="vizFrame" name="vizFrame" class="viz-frame" src="about:blank"></iframe>
                            <div class="viz-resize-handle" id="vizResizeHandle" title="Drag to resize"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Tab (v0.4) -->
            <div id="auditTab" class="tab-content">
                <div class="audit-panel">
                    <div class="audit-header">
                        <h2>Code Audit Dashboard</h2>
                        <div class="audit-header-actions">
                            <button class="btn" onclick="auditApp.refresh()">Refresh</button>
                            <button class="btn btn-icon" onclick="auditApp.openSettings()" title="Audit Settings">&#9881;</button>
                        </div>
                    </div>

                    <!-- Project Selection & Sources Status -->
                    <div class="audit-section">
                        <div class="audit-project-row">
                            <div class="audit-project-input">
                                <label>Project Path:</label>
                                <input type="text" id="auditProjectPath" placeholder="Enter project path to audit..." />
                                <button class="btn btn-icon" onclick="folderBrowser.open('auditProjectPath')" title="Browse folders">&#128193;</button>
                            </div>
                            <button class="btn btn-primary" onclick="auditApp.detectServices()" id="auditDetectBtn">
                                <span class="btn-icon-left">&#128269;</span> Detect Services
                            </button>
                            <button class="btn" onclick="auditApp.runFullAudit()" id="auditRunBtn" disabled>
                                <span class="btn-icon-left">&#9881;</span> Run Audit
                            </button>
                        </div>

                        <!-- Sources Status -->
                        <div class="audit-sources" id="auditSources">
                            <div class="source-badge" id="sourceFilesystem" data-available="true">
                                <span class="source-icon">&#128193;</span>
                                <span class="source-name">Filesystem</span>
                                <span class="source-status">Ready</span>
                            </div>
                            <div class="source-badge" id="sourceRag" data-available="false">
                                <span class="source-icon">&#128218;</span>
                                <span class="source-name">RAG Index</span>
                                <span class="source-status">Not indexed</span>
                            </div>
                            <div class="source-badge" id="sourceAst" data-available="false">
                                <span class="source-icon">&#128194;</span>
                                <span class="source-name">AST Cache</span>
                                <span class="source-status">Not cached</span>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="audit-summary" id="auditSummary" style="display: none;">
                        <div class="audit-card">
                            <div class="audit-card-icon">&#128202;</div>
                            <div class="audit-card-content">
                                <span class="audit-card-value" id="auditTotalServices">0</span>
                                <span class="audit-card-label">Services</span>
                            </div>
                        </div>
                        <div class="audit-card">
                            <div class="audit-card-icon risk-high">&#9888;</div>
                            <div class="audit-card-content">
                                <span class="audit-card-value" id="auditHighRisk">0</span>
                                <span class="audit-card-label">High Risk</span>
                            </div>
                        </div>
                        <div class="audit-card">
                            <div class="audit-card-icon">&#128200;</div>
                            <div class="audit-card-content">
                                <span class="audit-card-value" id="auditAvgRisk">-</span>
                                <span class="audit-card-label">Avg Risk</span>
                            </div>
                        </div>
                        <div class="audit-card">
                            <div class="audit-card-icon drift-alert">&#128196;</div>
                            <div class="audit-card-content">
                                <span class="audit-card-value" id="auditDriftAlerts">0</span>
                                <span class="audit-card-label">Drift Alerts</span>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Matrix & Service Profiles (side by side) -->
                    <div class="audit-main-content" id="auditMainContent" style="display: none;">
                        <!-- Risk Matrix -->
                        <div class="audit-section audit-matrix-section" id="auditMatrixWrapper">
                            <div class="audit-section-header" onclick="auditApp.toggleSection('matrix')">
                                <span class="audit-section-toggle" id="auditMatrixToggle">&#9660;</span>
                                <h3>Risk Matrix</h3>
                                <span class="audit-section-hint">Impact  Complexity</span>
                                <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); auditApp.toggleSectionFullscreen('matrix')" title="Toggle Fullscreen">
                                    <span id="matrixFullscreenIcon">&#9974;</span>
                                </button>
                            </div>
                            <div class="audit-section-content" id="auditMatrixSection">
                                <div id="riskMatrixChart" class="risk-matrix-container">
                                    <div class="risk-matrix-loading">Loading risk matrix...</div>
                                </div>
                                <div class="risk-matrix-legend">
                                    <span class="legend-item"><span class="legend-dot low"></span> Low</span>
                                    <span class="legend-item"><span class="legend-dot medium"></span> Medium</span>
                                    <span class="legend-item"><span class="legend-dot high"></span> High</span>
                                    <span class="legend-item"><span class="legend-dot critical"></span> Critical</span>
                                </div>
                            </div>
                        </div>

                        <!-- Service Life Profiles -->
                        <div class="audit-section audit-profiles-section" id="auditProfilesWrapper">
                            <div class="audit-section-header" onclick="auditApp.toggleSection('profiles')">
                                <span class="audit-section-toggle" id="auditProfilesToggle">&#9660;</span>
                                <h3>Service Life Profiles</h3>
                                <span class="audit-section-badge" id="auditProfilesCount">0</span>
                                <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); auditApp.toggleSectionFullscreen('profiles')" title="Toggle Fullscreen">
                                    <span id="profilesFullscreenIcon">&#9974;</span>
                                </button>
                            </div>
                            <div class="audit-section-content" id="auditProfilesSection">
                                <div class="audit-table-controls">
                                    <input type="text" id="auditProfilesFilter" placeholder="Filter by ID or type..." oninput="auditApp.filterProfiles()" />
                                    <select id="auditProfilesSort" onchange="auditApp.sortProfiles()">
                                        <option value="risk-desc">Risk (High  Low)</option>
                                        <option value="risk-asc">Risk (Low  High)</option>
                                        <option value="age-desc">Age (Old  New)</option>
                                        <option value="age-asc">Age (New  Old)</option>
                                        <option value="id-asc">ID (A  Z)</option>
                                    </select>
                                </div>
                                <div class="audit-table-wrapper">
                                    <table class="audit-table" id="auditProfilesTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Type</th>
                                                <th>Files</th>
                                                <th>Age</th>
                                                <th>Risk</th>
                                                <th>Category</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="auditProfilesBody">
                                            <tr><td colspan="7" class="audit-table-empty">Run detection to see services</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Drift Alerts -->
                    <div class="audit-section" id="auditDriftWrapper" style="display: none;">
                        <div class="audit-section-header" onclick="auditApp.toggleSection('drift')">
                            <span class="audit-section-toggle" id="auditDriftToggle">&#9660;</span>
                            <h3>Drift Alerts</h3>
                            <span class="audit-section-badge" id="auditDriftCount">0</span>
                            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); auditApp.toggleSectionFullscreen('drift')" title="Toggle Fullscreen">
                                <span id="driftFullscreenIcon">&#9974;</span>
                            </button>
                        </div>
                        <div class="audit-section-content" id="auditDriftContent">
                            <div class="audit-drift-filters">
                                <label>
                                    <input type="checkbox" id="auditDriftCritical" checked onchange="auditApp.filterDrift()"> Critical
                                </label>
                                <label>
                                    <input type="checkbox" id="auditDriftError" checked onchange="auditApp.filterDrift()"> Error
                                </label>
                                <label>
                                    <input type="checkbox" id="auditDriftWarning" checked onchange="auditApp.filterDrift()"> Warning
                                </label>
                                <label>
                                    <input type="checkbox" id="auditDriftInfo" onchange="auditApp.filterDrift()"> Info
                                </label>
                            </div>
                            <div class="audit-drift-list" id="auditDriftList">
                                <div class="audit-drift-empty">No drift alerts</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Insights Section -->
                    <div class="audit-section" id="auditInsightsWrapper" style="display: none;">
                        <div class="audit-section-header" onclick="auditApp.toggleSection('insights')">
                            <span class="audit-section-toggle" id="auditInsightsToggle">&#9660;</span>
                            <h3>&#129302; AI Insights</h3>
                            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); auditApp.toggleSectionFullscreen('insights')" title="Toggle Fullscreen">
                                <span id="insightsFullscreenIcon">&#9974;</span>
                            </button>
                            <div class="audit-insights-actions">
                                <select id="insightFocusSelect" class="insight-select" onchange="auditApp.insightFocusChanged()">
                                    <option value="executive">Executive Summary</option>
                                    <option value="technical">Technical Analysis</option>
                                    <option value="recommendations">Recommendations</option>
                                </select>
                                <button class="btn btn-sm" onclick="auditApp.generateInsights()" id="generateInsightsBtn">
                                    &#9889; Generate
                                </button>
                            </div>
                        </div>
                        <div class="audit-section-content" id="auditInsightsContent">
                            <div class="insights-placeholder" id="insightsPlaceholder">
                                <p>Run an audit and click "Generate" to get AI-powered insights based on your audit data.</p>
                                <p class="muted">Choose a focus mode: Executive (for stakeholders), Technical (for developers), or Recommendations (action items).</p>
                            </div>
                            <div class="insights-loading" id="insightsLoading" style="display: none;">
                                <span class="spinner"></span> Generating insights...
                            </div>
                            <div class="insights-result" id="insightsResult" style="display: none;">
                                <div class="insights-meta" id="insightsMeta"></div>
                                <div class="insights-text" id="insightsText"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Generation Section -->
                    <div class="audit-section" id="auditReportSection" style="display: none;">
                        <div class="audit-section-header">
                            <h3>&#128196; Generate Report</h3>
                        </div>
                        <div class="audit-section-content audit-report-options">
                            <div class="report-option-group">
                                <label>Report Type:</label>
                                <select id="reportTypeSelect" class="report-select">
                                    <option value="full">Full Audit Report</option>
                                    <option value="risk">Risk Analysis Only</option>
                                    <option value="timeline">Timeline Only</option>
                                    <option value="drift">Drift Analysis Only</option>
                                </select>
                            </div>
                            <div class="report-option-group">
                                <label>Include AI Insights:</label>
                                <select id="reportInsightsSelect" class="report-select">
                                    <option value="executive">Executive Summary</option>
                                    <option value="technical">Technical Analysis</option>
                                    <option value="recommendations">Recommendations</option>
                                    <option value="none">No AI Insights</option>
                                </select>
                            </div>
                            <div class="report-buttons">
                                <button class="btn btn-primary" onclick="auditApp.openReport()">
                                    &#128196; View Report
                                </button>
                                <button class="btn" onclick="auditApp.downloadReport()">
                                    &#128190; Save HTML
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Settings Modal -->
                    <div id="auditSettingsModal" class="audit-modal" style="display: none;">
                        <div class="audit-modal-backdrop" onclick="auditApp.closeSettings()"></div>
                        <div class="audit-modal-content">
                            <div class="audit-modal-header">
                                <h3>&#9881; Audit Settings</h3>
                                <button class="btn btn-icon" onclick="auditApp.closeSettings()">&#10005;</button>
                            </div>
                            <div class="audit-modal-body">
                                <div class="settings-section">
                                    <h4>Thresholds</h4>
                                    <div class="settings-row">
                                        <label>Drift Alert (days):</label>
                                        <input type="number" id="settingDriftDays" value="90" min="1" max="365" />
                                        <span class="settings-hint">Days without doc update triggers drift alert</span>
                                    </div>
                                    <div class="settings-row">
                                        <label>New Component (days):</label>
                                        <input type="number" id="settingNewDays" value="180" min="30" max="730" />
                                        <span class="settings-hint">Components younger than this are "New"</span>
                                    </div>
                                    <div class="settings-row">
                                        <label>Legacy Threshold (years):</label>
                                        <input type="number" id="settingLegacyYears" value="3" min="1" max="10" />
                                        <span class="settings-hint">Components older than this are "Legacy"</span>
                                    </div>
                                </div>
                                <div class="settings-section">
                                    <h4>Risk Weights</h4>
                                    <p class="settings-note">Weights should sum to 1.0</p>
                                    <div class="settings-row">
                                        <label>Age:</label>
                                        <input type="number" id="settingWeightAge" value="0.2" min="0" max="1" step="0.05" />
                                    </div>
                                    <div class="settings-row">
                                        <label>Volatility:</label>
                                        <input type="number" id="settingWeightVolatility" value="0.25" min="0" max="1" step="0.05" />
                                    </div>
                                    <div class="settings-row">
                                        <label>Complexity:</label>
                                        <input type="number" id="settingWeightComplexity" value="0.2" min="0" max="1" step="0.05" />
                                    </div>
                                    <div class="settings-row">
                                        <label>Doc Coverage:</label>
                                        <input type="number" id="settingWeightDocCoverage" value="0.15" min="0" max="1" step="0.05" />
                                    </div>
                                    <div class="settings-row">
                                        <label>Test Coverage:</label>
                                        <input type="number" id="settingWeightTestCoverage" value="0.2" min="0" max="1" step="0.05" />
                                    </div>
                                    <div class="settings-row weight-total">
                                        <label>Total:</label>
                                        <span id="settingWeightTotal">1.00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="audit-modal-footer">
                                <button class="btn" onclick="auditApp.resetSettings()">Reset Defaults</button>
                                <button class="btn btn-primary" onclick="auditApp.saveSettings()">Save & Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logsTab" class="tab-content">
                <div class="logs-panel">
                    <div class="ast-header">
                        <h2>Command Logs & Integrity</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="logsApp.refresh()">Refresh</button>
                            <button class="btn btn-primary" onclick="logsApp.verifyIntegrity()">Verify Integrity</button>
                        </div>
                    </div>

                    <!-- Integrity Status Banner -->
                    <div id="integrityStatus" class="integrity-status" style="display: none;">
                        <div class="integrity-icon"></div>
                        <div class="integrity-message"></div>
                        <div class="integrity-details"></div>
                    </div>

                    <!-- Log Statistics -->
                    <div id="logStats" class="log-stats" style="display: none;">
                        <div class="stat-card">
                            <span class="stat-value" id="statEntries">0</span>
                            <span class="stat-label">Log Entries</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="statChain">0</span>
                            <span class="stat-label">Hash Chain</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="statSize">0 KB</span>
                            <span class="stat-label">Log Size</span>
                        </div>
                    </div>

                    <!-- View Toggle -->
                    <div class="logs-toolbar">
                        <select id="logViewMode" onchange="logsApp.changeView()">
                            <option value="logs">Command Logs</option>
                            <option value="chain">Hash Chain</option>
                            <option value="traces">Tool Traces</option>
                        </select>
                    </div>

                    <div id="logsContent" class="logs-content">
                        <p style="color: var(--text-secondary);">Select a session to view logs...</p>
                    </div>
                </div>
            </div>

            <!-- Project RAG Tab -->
            <div id="ragTab" class="tab-content">
                <div class="rag-panel">
                    <div class="ast-header">
                        <h2>Project Knowledge Base</h2>
                        <div id="ragTabStatus" class="ast-status available">
                            Checking Project RAG status...
                        </div>
                        <button class="btn btn-icon" onclick="projectRagApp.openSettings()" title="RAG Settings" style="margin-left: auto;">&#9881;</button>
                    </div>

                    <!-- Change Detection Notification -->
                    <div id="ragChangeNotification" class="rag-change-notification hidden">
                        <div class="rag-notification-icon"></div>
                        <div class="rag-notification-content">
                            <strong>Changes detected in project</strong>
                            <span id="ragChangeSummary">Loading...</span>
                        </div>
                        <div class="rag-notification-actions">
                            <button class="btn btn-primary btn-sm" onclick="projectRagApp.updateIndex()">Update Now</button>
                            <button class="btn btn-secondary btn-sm" onclick="projectRagApp.reindexProject()">Full Reindex</button>
                            <button class="btn btn-icon btn-sm" onclick="projectRagApp.dismissNotification()" title="Dismiss"></button>
                        </div>
                    </div>

                    <!-- 1. Discovered Concepts (Position 1 - Click to explore) -->
                    <div class="rag-section" id="ragConceptsWrapper">
                        <div class="rag-section-header" onclick="projectRagApp.toggleSection('concepts')">
                            <span class="rag-section-toggle" id="ragConceptsToggle"></span>
                            <h3>Discovered Concepts</h3>
                            <span id="ragConceptsCount" class="rag-section-badge"></span>
                            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); projectRagApp.toggleSectionFullscreen('concepts')" title="Toggle Fullscreen">
                                <span id="conceptsFullscreenIcon"></span>
                            </button>
                        </div>
                        <div class="rag-section-content" id="ragConceptsSection">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                                Concepts extracted from indexed files. Click to explore in Concept Explorer below.
                            </p>
                            <!-- Pagination controls -->
                            <div class="rag-concepts-pagination">
                                <button class="btn btn-sm" id="conceptsPrevBtn" onclick="projectRagApp.changeConceptsPage(-1)" disabled title="Show fewer concepts">
                                     Less
                                </button>
                                <span id="conceptsPageInfo" style="font-size: 12px; color: var(--text-secondary);">
                                    Showing 1-20
                                </span>
                                <button class="btn btn-sm" id="conceptsNextBtn" onclick="projectRagApp.changeConceptsPage(1)" title="Show more concepts">
                                    More 
                                </button>
                            </div>
                            <div id="ragConceptsList" class="rag-concepts-list">
                                <span style="color: var(--text-secondary);">No concepts indexed yet.</span>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Search Project -->
                    <div class="rag-section" id="ragSearchWrapper">
                        <div class="rag-section-header" onclick="projectRagApp.toggleSection('search')">
                            <span class="rag-section-toggle" id="ragSearchToggle"></span>
                            <h3>Search Project</h3>
                            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); projectRagApp.toggleSectionFullscreen('search')" title="Toggle Fullscreen">
                                <span id="searchFullscreenIcon"></span>
                            </button>
                        </div>
                        <div class="rag-section-content" id="ragSearchSection">
                            <div class="rag-query-input-group">
                                <input type="text" id="ragQueryInput" class="rag-query-input"
                                       placeholder="Search for code, concepts, or documentation..."
                                       onkeypress="if(event.key==='Enter') projectRagApp.search()" />
                                <select id="ragCollectionSelect" class="rag-profile-select">
                                    <option value="mixed">All (Mixed)</option>
                                    <option value="code">Code Only</option>
                                    <option value="docs">Docs Only</option>
                                </select>
                                <button class="btn btn-primary" onclick="projectRagApp.search()">Search</button>
                            </div>
                            <!-- Results Section -->
                            <div id="ragResults" class="rag-results">
                                <p style="color: var(--text-secondary);">Enter a search query above to find relevant content in your project.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Concept Explorer (v0.33.1) - with fullscreen support -->
                    <div class="rag-section" id="ragExplorerWrapper">
                        <div class="rag-section-header" onclick="projectRagApp.toggleSection('explorer')">
                            <span class="rag-section-toggle" id="ragExplorerToggle"></span>
                            <h3>Concept Explorer</h3>
                            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); projectRagApp.toggleExplorerFullscreen()" title="Toggle Fullscreen">
                                <span id="explorerFullscreenIcon"></span>
                            </button>
                        </div>
                        <div class="rag-section-content" id="ragExplorerSection">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                                Explore concepts with file-centric and graph views. Click on discovered concepts above or search directly.
                            </p>
                            <div class="rag-query-input-group">
                                <input type="text" id="ragExploreInput" class="rag-query-input"
                                       placeholder="Explore a concept (e.g., 'SK02', 'authentication')..."
                                       onkeypress="if(event.key==='Enter') projectRagApp.exploreConcept()" />
                                <button class="btn btn-primary" onclick="projectRagApp.exploreConcept()">Explore</button>
                                <button class="btn btn-secondary" onclick="projectRagApp.toggleExplorerView()" title="Toggle Files/Graph View">
                                    <span id="explorerViewIcon"></span>
                                </button>
                            </div>

                            <!-- Recurring Tags (auto-discovered) -->
                            <div id="ragExplorerTags" class="rag-explorer-tags" style="display: none;">
                                <span style="font-size: 11px; color: var(--text-secondary);">Related tags:</span>
                                <div id="ragExplorerTagsList" class="rag-tags-list"></div>
                            </div>

                            <!-- Dual View Container -->
                            <div id="ragExplorerResults" class="rag-explorer-results">
                                <!-- File-Centric View (default) -->
                                <div id="ragExplorerFiles" class="rag-explorer-files">
                                    <p style="color: var(--text-secondary);">Enter a concept to explore files and chunks.</p>
                                </div>

                                <!-- Graph View (toggle) -->
                                <div id="ragExplorerGraph" class="rag-explorer-graph" style="display: none;">
                                    <div id="ragGraphContainer" class="rag-graph-container">
                                        <svg id="ragGraphSvg" width="100%" height="400"></svg>
                                        <!-- Tooltip for graph nodes -->
                                        <div id="ragGraphTooltip" class="rag-graph-tooltip" style="display: none;"></div>
                                    </div>
                                    <div id="ragGraphControls" class="rag-graph-controls">
                                        <button class="btn btn-sm" onclick="projectRagApp.zoomGraph(1.2)" title="Zoom In">+</button>
                                        <button class="btn btn-sm" onclick="projectRagApp.zoomGraph(0.8)" title="Zoom Out"></button>
                                        <button class="btn btn-sm" onclick="projectRagApp.resetGraph()" title="Reset"></button>
                                    </div>
                                    <div id="ragGraphLegend" class="rag-graph-legend">
                                        <span class="legend-item"><span class="legend-dot concept"></span> Concept</span>
                                        <span class="legend-item"><span class="legend-dot chunk"></span> Chunk</span>
                                        <span class="legend-item"><span class="legend-dot file"></span> File</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Related Concepts -->
                            <div id="ragRelatedConcepts" class="rag-related-concepts" style="display: none;">
                                <span style="font-size: 11px; color: var(--text-secondary);">Related concepts:</span>
                                <div id="ragRelatedConceptsList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Section (Collapsible) -->
                    <div class="rag-section" id="ragStatsWrapper">
                        <div class="rag-section-header" onclick="projectRagApp.toggleSection('stats')">
                            <span class="rag-section-toggle" id="ragStatsToggle"></span>
                            <h3>Index Statistics</h3>
                            <span id="ragStatsFiles" class="rag-stat-badge files" title="Total Files">0 files</span>
                            <span id="ragStatsChunks" class="rag-stat-badge chunks" title="Total Chunks">0 chunks</span>
                            <span id="ragStatsCode" class="rag-stat-badge code" title="Code Chunks">0 code</span>
                            <span id="ragStatsDocs" class="rag-stat-badge docs" title="Doc Chunks">0 docs</span>
                            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); projectRagApp.toggleSectionFullscreen('stats')" title="Toggle Fullscreen">
                                <span id="statsFullscreenIcon"></span>
                            </button>
                        </div>
                        <div class="rag-section-content" id="ragStatsSection">
                            <div id="ragStatsDetail" style="font-size: 13px; color: var(--text-secondary);">
                                No index statistics available.
                            </div>
                        </div>
                    </div>

                    <!-- Summarize Section (Collapsible) -->
                    <div class="rag-section" id="ragSummarizeWrapper">
                        <div class="rag-section-header" onclick="projectRagApp.toggleSection('summarize')">
                            <span class="rag-section-toggle" id="ragSummarizeToggle"></span>
                            <h3>Knowledge Summary</h3>
                            <button class="btn btn-sm btn-icon" onclick="event.stopPropagation(); projectRagApp.toggleSectionFullscreen('summarize')" title="Toggle Fullscreen">
                                <span id="summarizeFullscreenIcon"></span>
                            </button>
                        </div>
                        <div class="rag-section-content hidden" id="ragSummarizeSection">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                                Use the LLM to summarize knowledge about a concept with citations.
                            </p>
                            <div class="rag-query-input-group">
                                <input type="text" id="ragSummarizeInput" class="rag-query-input"
                                       placeholder="Enter concept to summarize (e.g., 'authentication', 'SK02')..."
                                       onkeypress="if(event.key==='Enter') projectRagApp.summarizeConcept()" />
                                <button class="btn btn-primary" onclick="projectRagApp.summarizeConcept()">Summarize</button>
                            </div>
                            <div id="ragSummarizeResults" class="rag-summarize-results">
                                <p style="color: var(--text-secondary);">Enter a concept to get an LLM-generated summary with source citations.</p>
                            </div>
                        </div>
                    </div>

                    <!-- File Viewer Modal -->
                    <div id="ragFileViewerModal" class="file-viewer-modal" style="display: none;">
                        <div class="file-viewer-backdrop" onclick="projectRagApp.closeFileViewer()"></div>
                        <div class="file-viewer-content">
                            <div class="file-viewer-header">
                                <div class="file-viewer-title">
                                    <span id="fileViewerIcon"></span>
                                    <span id="fileViewerName">file.txt</span>
                                    <span id="fileViewerPath" class="file-viewer-path"></span>
                                </div>
                                <div class="file-viewer-actions">
                                    <button class="btn btn-sm" onclick="projectRagApp.openFileInNewWindow()" title="Open in New Window"></button>
                                    <button class="btn btn-sm" onclick="projectRagApp.copyFilePath()" title="Copy Path"></button>
                                    <button class="btn btn-icon" onclick="projectRagApp.closeFileViewer()"></button>
                                </div>
                            </div>
                            <div class="file-viewer-info">
                                <span id="fileViewerLines">0 lines</span>
                                <span id="fileViewerChunks">0 chunks</span>
                                <span id="fileViewerLang">plaintext</span>
                                <!-- Chunk Navigation -->
                                <div id="fileViewerChunkNav" class="chunk-nav" style="display: none;">
                                    <button class="btn btn-sm" onclick="projectRagApp.prevChunk()" title="Previous Chunk"></button>
                                    <span id="fileViewerChunkPos">1/1</span>
                                    <button class="btn btn-sm" onclick="projectRagApp.nextChunk()" title="Next Chunk"></button>
                                </div>
                            </div>
                            <div class="file-viewer-body">
                                <div id="fileViewerContent" class="file-viewer-code">
                                    <pre><code>Loading...</code></pre>
                                </div>
                            </div>
                            <div class="file-viewer-legend" id="fileViewerLegend" style="display: none;">
                                <span class="legend-title">Chunks:</span>
                                <div id="fileViewerChunkList" class="chunk-legend-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- RAG Settings Modal -->
                    <div id="ragSettingsModal" class="audit-modal" style="display: none;">
                        <div class="audit-modal-backdrop" onclick="projectRagApp.closeSettings()"></div>
                        <div class="audit-modal-content">
                            <div class="audit-modal-header">
                                <h3>&#9881; Project RAG Settings</h3>
                                <button class="btn btn-icon" onclick="projectRagApp.closeSettings()">&#10005;</button>
                            </div>
                            <div class="audit-modal-body">
                                <div class="settings-section">
                                    <h4>Discovered Concepts</h4>
                                    <div class="settings-row">
                                        <label>Max concepts:</label>
                                        <input type="number" id="ragSettingMaxConcepts" value="200" min="50" max="2000" step="50" />
                                        <span class="settings-hint">Maximum concepts to load (50-2000)</span>
                                    </div>
                                    <div class="settings-row">
                                        <label>Min hits threshold:</label>
                                        <input type="number" id="ragSettingMinHits" value="1" min="1" max="100" />
                                        <span class="settings-hint">Only show concepts with  this many hits</span>
                                    </div>
                                </div>
                                <div class="settings-section">
                                    <h4>Concept Explorer Graph</h4>
                                    <div class="settings-row">
                                        <label>Force strength:</label>
                                        <input type="number" id="ragSettingForceStrength" value="-300" min="-1000" max="-50" step="50" />
                                        <span class="settings-hint">Node repulsion (-1000 to -50)</span>
                                    </div>
                                    <div class="settings-row">
                                        <label>Node size factor:</label>
                                        <input type="number" id="ragSettingNodeSize" value="1.0" min="0.5" max="3.0" step="0.1" />
                                        <span class="settings-hint">Scale factor for node radius</span>
                                    </div>
                                    <div class="settings-row">
                                        <label>Link distance:</label>
                                        <input type="number" id="ragSettingLinkDistance" value="80" min="30" max="200" step="10" />
                                        <span class="settings-hint">Distance between linked nodes</span>
                                    </div>
                                </div>
                                <div class="settings-section">
                                    <h4>Search Settings</h4>
                                    <div class="settings-row">
                                        <label>Results limit:</label>
                                        <input type="number" id="ragSettingSearchLimit" value="20" min="5" max="100" step="5" />
                                        <span class="settings-hint">Max search results to show</span>
                                    </div>
                                </div>
                            </div>
                            <div class="audit-modal-footer">
                                <button class="btn" onclick="projectRagApp.resetSettings()">Reset Defaults</button>
                                <button class="btn btn-primary" onclick="projectRagApp.saveSettings()">Save & Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>Settings</h2>
                <button onclick="app.closeSettings()" class="btn btn-icon">&#10005;</button>
            </div>
            <div class="modal-body">
                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" data-settings-tab="session">Session</button>
                    <button class="settings-tab" data-settings-tab="agents">Agent Config</button>
                    <button class="settings-tab" data-settings-tab="reasoning">Reasoning</button>
                    <button class="settings-tab" data-settings-tab="memory">Memory</button>
                    <button class="settings-tab" data-settings-tab="context">User Context</button>
                </div>

                <!-- Session Settings -->
                <div id="sessionSettings" class="settings-content active">
                    <div class="form-group">
                        <label>Session ID:</label>
                        <input type="text" id="sessionIdInput" value="default" />
                    </div>
                    <div class="form-group">
                        <label>Sandbox Root:</label>
                        <input type="text" id="sandboxInput" value="" placeholder="Leave empty for current directory (secure)" />
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            Security: Like Claude Code, sandbox is restricted to the server's launch directory
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Sovereign AI Model (from Ollama):</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="modelInput" style="flex: 1;">
                                <option value="">Loading models...</option>
                            </select>
                            <button type="button" class="btn btn-icon" onclick="app.loadOllamaModels()" title="Refresh models">&#8635;</button>
                        </div>
                        <small id="modelStatus" style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            All models run locally via Ollama - no data leaves your machine
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Profile:</label>
                        <select id="profileInput">
                            <option value="strict">Strict (Read-only)</option>
                            <option value="dev" selected>Dev (Default)</option>
                            <option value="unsafe">Unsafe (Expert)</option>
                        </select>
                    </div>
                </div>

                <!-- Agent Configuration Settings -->
                <div id="agentsSettings" class="settings-content">
                    <div class="agent-settings-header">
                        <h3>Multi-Agent LLM Configuration</h3>
                        <p class="settings-desc">Configure which models are used for each agent role. Use single-model mode on low VRAM systems (8GB) to avoid model load/unload overhead.</p>
                    </div>

                    <!-- Single Model Mode Toggle -->
                    <div class="form-group agent-mode-toggle">
                        <label class="toggle-label">
                            <input type="checkbox" id="singleModelMode" onchange="agentSettingsApp.toggleSingleMode()">
                            <span class="toggle-text">Single Model Mode (Low VRAM)</span>
                        </label>
                        <small class="mode-hint">Recommended for GPUs with 8GB VRAM. Uses the same model for all agents to avoid loading/unloading.</small>
                    </div>

                    <!-- Agent Mode Selection -->
                    <div class="form-group" id="agentModeGroup">
                        <label>Agent Mode:</label>
                        <select id="agentModeInput" onchange="agentSettingsApp.changeMode()">
                            <option value="minimal">Minimal (All 3B - Best for low VRAM)</option>
                            <option value="strict">Strict (7B Planner, 3B Workers)</option>
                            <option value="custom">Custom (Choose per agent)  Select for per-agent models</option>
                        </select>
                        <small class="mode-hint"> Select "Custom" above to configure different models for Planner, Worker, and Verifier.</small>
                    </div>

                    <!-- Single Model Selection (shown when single mode enabled) -->
                    <div id="singleModelGroup" class="form-group" style="display: none;">
                        <label>Model for All Agents:</label>
                        <select id="singleModelInput">
                            <option value="">Loading models...</option>
                        </select>
                        <small>This model will be used for Planner, Worker, and Verifier roles.</small>
                    </div>

                    <!-- Per-Agent Model Selection (shown when custom mode) -->
                    <div id="perAgentModels" class="per-agent-models">
                        <div class="form-group">
                            <label>&#129302; Planner Model:</label>
                            <select id="plannerModelInput">
                                <option value="">Loading models...</option>
                            </select>
                            <small>Handles task decomposition and planning. Larger models (7B+) recommended.</small>
                        </div>
                        <div class="form-group">
                            <label>&#128736; Worker Model:</label>
                            <select id="workerModelInput">
                                <option value="">Loading models...</option>
                            </select>
                            <small>Executes planned tasks. 3B models are efficient for execution.</small>
                        </div>
                        <div class="form-group">
                            <label>&#9989; Verifier Model:</label>
                            <select id="verifierModelInput">
                                <option value="">Loading models...</option>
                            </select>
                            <small>Verifies outputs and results. 3B models are sufficient.</small>
                        </div>
                    </div>

                    <!-- VRAM Warning -->
                    <div id="vramWarning" class="vram-warning" style="display: none;">
                        <span class="warning-icon">&#9888;</span>
                        <span class="warning-text">Warning: Selected configuration may exceed available VRAM. Consider using single-model mode or smaller models.</span>
                    </div>

                    <!-- Config Actions -->
                    <div class="config-actions">
                        <button onclick="agentSettingsApp.reset()" class="btn">Reset to Defaults</button>
                        <span id="configSessionNote" class="session-note">Changes are session-specific and don't affect default configuration.</span>
                    </div>
                </div>

                <!-- Reasoning Graph Settings -->
                <div id="reasoningSettings" class="settings-content">
                    <div class="agent-settings-header">
                        <h3>Reasoning Graph</h3>
                        <p class="settings-desc">Configure the reflective reasoning strategy. The graph handles task classification, planning, execution, verification, and reflection loops.</p>
                    </div>

                    <!-- Reasoning Strategy -->
                    <div class="form-group">
                        <label>Reasoning Strategy:</label>
                        <select id="reasoningStrategyInput" onchange="reasoningSettingsApp.changeStrategy()">
                            <option value="loop_v1">Loop v1 (Default - Iterative)</option>
                            <option value="graph">Graph (Full reasoning graph)</option>
                            <option value="simple">Simple (Direct execution)</option>
                        </select>
                        <small>Set RAGIX_REASONING_STRATEGY environment variable to persist selection.</small>
                    </div>

                    <!-- Max Reflections -->
                    <div class="form-group">
                        <label>Max Reflections:</label>
                        <input type="number" id="maxReflectionsInput" value="2" min="0" max="5" style="width: 80px;">
                        <small>Maximum self-reflection iterations before stopping (0-5).</small>
                    </div>

                    <!-- Model Inheritance Info -->
                    <div class="form-group">
                        <label>Reasoning Model:</label>
                        <div class="inheritance-info" style="background: var(--bg-secondary); padding: 10px; border-radius: 6px; margin-top: 8px;">
                            <span id="reasoningModelDisplay" style="font-weight: 500; color: var(--accent-blue);">-</span>
                            <small style="display: block; margin-top: 4px; color: var(--text-secondary);">
                                &#x2139; Inherits from Agent Config  Session. To change, update the Session or Agent Config settings.
                            </small>
                        </div>
                    </div>

                    <!-- Experience Corpus Settings -->
                    <div class="form-group">
                        <label>Experience Corpus:</label>
                        <div style="display: flex; gap: 12px; align-items: center; margin-top: 8px;">
                            <label class="toggle-label">
                                <input type="checkbox" id="enableExperienceCorpus" checked>
                                <span>Enable learning from past experiences</span>
                            </label>
                        </div>
                        <small>When enabled, the agent learns from successes and failures to improve future responses.</small>
                    </div>

                    <!-- Graph Status -->
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Graph Status:</label>
                        <div id="reasoningSettingsStatus" class="graph-status" style="margin-top: 8px;">
                            <span class="status-indicator checking"></span>
                            <span id="reasoningSettingsStatusText">Checking...</span>
                        </div>
                    </div>

                    <!-- Reasoning Actions -->
                    <div class="config-actions">
                        <button onclick="reasoningSettingsApp.reset()" class="btn">Reset to Defaults</button>
                        <button onclick="reasoningSettingsApp.save()" class="btn btn-primary">Apply Changes</button>
                    </div>
                </div>

                <!-- Memory Management Settings -->
                <div id="memorySettings" class="settings-content">
                    <div class="memory-header">
                        <h3>Session Memory</h3>
                        <p class="settings-desc">View and manage conversation history for this session. Delete specific messages or clear all history.</p>
                    </div>

                    <!-- v0.33: Context Limits Section -->
                    <div class="context-limits-section" style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--accent-blue);">Context Limits</h4>
                        <p class="settings-desc" style="margin-bottom: 12px;">Control how much conversation history is included in the context sent to the LLM.</p>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="font-size: 12px;">Max Conversation Turns:</label>
                            <input type="number" id="contextMaxTurns" value="5" min="1" max="20" style="width: 80px;">
                            <small style="display: block; margin-top: 4px; color: var(--text-secondary);">Number of user+assistant pairs to include (default: 5)</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="font-size: 12px;">User Message Limit (chars):</label>
                            <input type="number" id="contextUserLimit" value="500" min="100" max="5000" step="100" style="width: 100px;">
                            <small style="display: block; margin-top: 4px; color: var(--text-secondary);">Max characters per user message (default: 500)</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="font-size: 12px;">Assistant Message Limit (chars):</label>
                            <input type="number" id="contextAssistantLimit" value="2000" min="100" max="10000" step="100" style="width: 100px;">
                            <small style="display: block; margin-top: 4px; color: var(--text-secondary);">Max characters per assistant message (default: 2000)</small>
                        </div>

                        <button onclick="memoryApp.saveContextLimits()" class="btn btn-small btn-primary">Save Context Limits</button>
                    </div>

                    <!-- Memory Stats -->
                    <div class="memory-stats">
                        <div class="stat-card">
                            <span class="stat-value" id="memoryTotalMessages">0</span>
                            <span class="stat-label">Total Messages</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="memoryUserMessages">0</span>
                            <span class="stat-label">User Messages</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="memoryAssistantMessages">0</span>
                            <span class="stat-label">Assistant Messages</span>
                        </div>
                    </div>

                    <!-- Memory Actions -->
                    <div class="memory-actions">
                        <button onclick="memoryApp.refresh()" class="btn">Refresh</button>
                        <button onclick="memoryApp.clearAll()" class="btn btn-danger">Clear All Memory</button>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <span>Keep last:</span>
                            <input type="number" id="keepLastInput" value="0" min="0" max="100" style="width: 60px;">
                            <span>messages</span>
                        </label>
                    </div>

                    <!-- Memory List -->
                    <div class="memory-list-container">
                        <div id="memoryList" class="memory-list">
                            <p style="color: var(--text-secondary);">Click "Refresh" to load memory...</p>
                        </div>
                    </div>
                </div>

                <!-- User Context Settings -->
                <div id="contextSettings" class="settings-content">
                    <div class="context-header">
                        <h3>User Context</h3>
                        <p class="settings-desc">Set custom instructions that persist across all conversations in this session. Similar to Claude's system prompts or ChatGPT's custom instructions.</p>
                    </div>

                    <div class="form-group">
                        <label>System Instructions:</label>
                        <textarea id="systemInstructionsInput" rows="4" placeholder="e.g., 'Always explain your reasoning step by step', 'Focus on Python best practices', 'Be concise'"></textarea>
                        <small>These instructions are prepended to every message you send.</small>
                    </div>

                    <div class="form-group">
                        <label>Custom Prompt Context:</label>
                        <textarea id="customPromptInput" rows="4" placeholder="e.g., 'I am working on a FastAPI project with PostgreSQL backend', 'The codebase follows clean architecture patterns'"></textarea>
                        <small>Additional context about your project or preferences.</small>
                    </div>

                    <div class="form-group">
                        <label>Preferences:</label>
                        <div class="preferences-grid">
                            <label class="preference-item">
                                <input type="checkbox" id="prefVerbose">
                                <span>Verbose explanations</span>
                            </label>
                            <label class="preference-item">
                                <input type="checkbox" id="prefCodeComments">
                                <span>Add code comments</span>
                            </label>
                            <label class="preference-item">
                                <input type="checkbox" id="prefStepByStep">
                                <span>Step-by-step output</span>
                            </label>
                            <label class="preference-item">
                                <input type="checkbox" id="prefSafetyFirst">
                                <span>Safety-first approach</span>
                            </label>
                        </div>
                    </div>

                    <!-- Context Actions -->
                    <div class="context-actions">
                        <button onclick="contextApp.load()" class="btn">Load Current</button>
                        <button onclick="contextApp.save()" class="btn btn-primary">Save Context</button>
                        <button onclick="contextApp.clear()" class="btn btn-danger">Clear Context</button>
                    </div>

                    <div id="contextStatus" class="context-status" style="display: none;">
                        <span class="status-icon"></span>
                        <span class="status-text"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="app.closeSettings()" class="btn">Cancel</button>
                <button onclick="app.saveSettings()" class="btn btn-primary">Save & Reconnect</button>
            </div>
        </div>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folderBrowserModal" class="modal hidden">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>Select Project Folder</h2>
                <button onclick="folderBrowser.close()" class="btn btn-icon">&#10005;</button>
            </div>
            <div class="modal-body">
                <div class="folder-nav">
                    <button class="btn btn-icon" onclick="folderBrowser.goUp()" title="Go to parent">&#8593;</button>
                    <button class="btn btn-icon" onclick="folderBrowser.goHome()" title="Go to home">&#127968;</button>
                    <input type="text" id="folderPath" class="folder-path-input" placeholder="Enter path..." onkeydown="if(event.key==='Enter')folderBrowser.navigate(this.value)">
                    <button class="btn" onclick="folderBrowser.navigate(document.getElementById('folderPath').value)">Go</button>
                </div>
                <div id="folderContents" class="folder-contents">
                    <p style="color: var(--text-secondary);">Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="folderBrowser.close()" class="btn">Cancel</button>
                <button onclick="folderBrowser.selectCurrent()" class="btn btn-primary">Select This Folder</button>
            </div>
        </div>
    </div>

    <!-- Memory Details Modal (v0.32) -->
    <div id="memoryDetailsModal" class="modal hidden">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2><span style="margin-right: 8px;">&#129504;</span> Memory Entry Details</h2>
                <button onclick="memoryContext.closeDetails()" class="btn btn-icon">&#10005;</button>
            </div>
            <div class="modal-body" id="memoryDetailsBody">
                <!-- Content populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button onclick="memoryContext.closeDetails()" class="btn">Close</button>
                <button onclick="memoryContext.deleteCurrentEntry()" class="btn btn-danger">Delete Entry</button>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
    <script>
        // Folder Browser
        const folderBrowser = {
            currentPath: '',
            targetInput: null,
            callback: null,

            open(targetInputId, callback = null) {
                this.targetInput = document.getElementById(targetInputId);
                this.callback = callback;
                document.getElementById('folderBrowserModal').classList.remove('hidden');

                // Start at current value or launch directory
                const startPath = this.targetInput?.value || '';
                this.navigate(startPath);
            },

            close() {
                document.getElementById('folderBrowserModal').classList.add('hidden');
            },

            async navigate(path) {
                const container = document.getElementById('folderContents');
                container.innerHTML = '<p style="color: var(--text-secondary);">Loading...</p>';

                try {
                    const resp = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                    const data = await resp.json();
                    const entries = data.entries || [];

                    this.currentPath = data.current || path;
                    document.getElementById('folderPath').value = data.current || path;

                    if (entries.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-secondary);">No subfolders found</p>';
                        return;
                    }

                    container.innerHTML = entries.map(entry => `
                        <div class="folder-item ${entry.is_project ? 'is-project' : ''}" onclick="folderBrowser.${entry.is_dir ? 'navigate' : 'selectFile'}('${entry.path.replace(/'/g, "\\'")}')">
                            <span class="folder-icon">${entry.is_dir ? (entry.is_project ? '&#128193;' : '&#128194;') : '&#128196;'}</span>
                            <span class="folder-name">${entry.name}</span>
                            ${entry.is_project ? '<span class="project-badge">Project</span>' : ''}
                        </div>
                    `).join('');

                } catch (e) {
                    container.innerHTML = `<p style="color: #f85149;">Error: ${e.message}</p>`;
                }
            },

            goUp() {
                const path = document.getElementById('folderPath').value;
                const parent = path.split('/').slice(0, -1).join('/') || '/';
                this.navigate(parent);
            },

            goHome() {
                this.navigate('~');
            },

            selectFile(path) {
                // For files, just update the path display
                document.getElementById('folderPath').value = path;
            },

            selectCurrent() {
                if (this.targetInput) {
                    this.targetInput.value = this.currentPath;
                }
                if (this.callback) {
                    this.callback(this.currentPath);
                }
                this.close();
            },

            selectPath(path) {
                if (this.targetInput) {
                    this.targetInput.value = path;
                }
                if (this.callback) {
                    this.callback(path);
                }
                this.close();
            }
        };

        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update active content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
            });
        });

        // AST Application
        const astApp = {
            projectPath: '',

            async init() {
                // Check AST availability
                try {
                    const resp = await fetch('/api/ast/status');
                    const data = await resp.json();
                    const statusEl = document.getElementById('astStatus');
                    if (data.available) {
                        statusEl.className = 'ast-status available';
                        statusEl.textContent = 'AST analysis available';
                    } else {
                        statusEl.className = 'ast-status unavailable';
                        statusEl.textContent = data.message;
                    }
                } catch (e) {
                    console.error('AST status check failed:', e);
                }

                // Initialize viz resize handle
                this.initVizResize();
            },

            initVizResize() {
                const handle = document.getElementById('vizResizeHandle');
                const container = document.getElementById('vizFrameContainer');
                if (!handle || !container) return;

                let startY = 0;
                let startHeight = 0;
                let isResizing = false;

                const startResize = (e) => {
                    isResizing = true;
                    startY = e.clientY || e.touches?.[0]?.clientY || 0;
                    startHeight = container.offsetHeight;
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';

                    // Prevent iframe from capturing mouse events
                    const iframe = container.querySelector('iframe');
                    if (iframe) iframe.style.pointerEvents = 'none';
                };

                const doResize = (e) => {
                    if (!isResizing) return;
                    const clientY = e.clientY || e.touches?.[0]?.clientY || 0;
                    const delta = clientY - startY;
                    const newHeight = Math.max(200, Math.min(startHeight + delta, window.innerHeight - 100));
                    container.style.height = newHeight + 'px';
                };

                const stopResize = () => {
                    if (!isResizing) return;
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // Restore iframe events
                    const iframe = container.querySelector('iframe');
                    if (iframe) iframe.style.pointerEvents = '';
                };

                handle.addEventListener('mousedown', startResize);
                handle.addEventListener('touchstart', startResize, { passive: true });
                document.addEventListener('mousemove', doResize);
                document.addEventListener('touchmove', doResize, { passive: true });
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchend', stopResize);
            },

            getPath() {
                return document.getElementById('projectPath').value.trim();
            },

            analyze() {
                const path = this.getPath();
                if (!path) {
                    alert('Please enter a project path');
                    return;
                }
                this.projectPath = path;
                this.showMetrics(path);
            },

            async showMetrics(path) {
                const results = document.getElementById('astResults');
                results.innerHTML = '<p>Loading metrics...</p>';

                try {
                    // Fetch both metrics and graph data for complete stats
                    const [metricsResp, graphResp] = await Promise.all([
                        fetch(`/api/ast/metrics?path=${encodeURIComponent(path)}`),
                        fetch(`/api/ast/graph?path=${encodeURIComponent(path)}&max_nodes=1`)
                    ]);

                    if (!metricsResp.ok) throw new Error(await metricsResp.text());
                    const metrics = await metricsResp.json();

                    // Graph response for dependency count (even if error, show partial data)
                    let depCount = '-';
                    if (graphResp.ok) {
                        const graphData = await graphResp.json();
                        depCount = graphData.total_edges || graphData.links?.length || '-';
                    }

                    // Extract nested values from API response
                    const totalFiles = metrics.summary?.total_files || 0;
                    const totalSymbols = (metrics.summary?.total_classes || 0) + (metrics.summary?.total_functions || 0);
                    const debtHours = metrics.debt?.estimated_hours?.toFixed(1) || 0;

                    results.innerHTML = `
                        <h3>Analysis Results</h3>
                        <div class="viz-cards">
                            <div class="viz-card">
                                <h3>Files: ${totalFiles}</h3>
                                <p>Total source files analyzed</p>
                            </div>
                            <div class="viz-card">
                                <h3>Symbols: ${totalSymbols}</h3>
                                <p>Classes, interfaces, methods extracted</p>
                            </div>
                            <div class="viz-card">
                                <h3>Dependencies: ${depCount}</h3>
                                <p>Dependency relationships mapped</p>
                            </div>
                            <div class="viz-card">
                                <h3>Debt: ${debtHours}h</h3>
                                <p>Estimated technical debt</p>
                            </div>
                        </div>
                        <div class="viz-cards" style="margin-top: 16px;">
                            <div class="viz-card">
                                <h3>Complexity: ${metrics.complexity?.average_cyclomatic?.toFixed(2) || '-'}</h3>
                                <p>Average cyclomatic complexity</p>
                            </div>
                            <div class="viz-card">
                                <h3>Lines: ${metrics.summary?.total_lines?.toLocaleString() || 0}</h3>
                                <p>Total lines of code</p>
                            </div>
                            <div class="viz-card">
                                <h3>Code: ${metrics.summary?.code_lines?.toLocaleString() || 0}</h3>
                                <p>Actual code lines</p>
                            </div>
                            <div class="viz-card">
                                <h3>Comments: ${metrics.summary?.comment_lines?.toLocaleString() || 0}</h3>
                                <p>Comment and doc lines</p>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    results.innerHTML = `<p style="color: #f85149;">Error: ${e.message}</p>`;
                }
            },

            openGraph() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/visualize?path=${encodeURIComponent(path)}&title=Dependency Graph`, 'Dependency Graph');
            },

            openMatrix() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/matrix?path=${encodeURIComponent(path)}&title=DSM Matrix&level=package`, 'DSM Matrix');
            },

            openRadial() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/radial/page?path=${encodeURIComponent(path)}`, 'Radial Explorer');
            },

            openMetrics() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showMetrics(path);
            },

            openTreemap() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/treemap?path=${encodeURIComponent(path)}&metric=loc&depth=4`, 'Treemap');
            },

            openSunburst() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/sunburst?path=${encodeURIComponent(path)}&depth=5`, 'Sunburst');
            },

            openChord() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/chord?path=${encodeURIComponent(path)}&group_by=package`, 'Chord Diagram');
            },

            openReport(type) {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                const titles = {
                    'executive': 'Executive Summary',
                    'technical': 'Technical Audit Report',
                    'compliance': 'Compliance Report'
                };
                this.showViz(`/api/reports/generate?path=${encodeURIComponent(path)}&report_type=${type}`, titles[type] || 'Report');
            },

            openCycles() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/cycles/page?path=${encodeURIComponent(path)}`, 'Cycles Detection');
            },

            openMaven() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                this.showViz(`/api/ast/maven/page?path=${encodeURIComponent(path)}`, 'Maven Analysis');
            },

            openSonar() {
                const path = this.getPath();
                if (!path) { alert('Please enter a project path first'); return; }
                // Prompt for project key since it's required
                const projectKey = prompt('Enter SonarQube project key:', '');
                if (!projectKey) { return; }
                this.showViz(`/api/ast/sonar/page?project=${encodeURIComponent(projectKey)}`, 'SonarQube Analysis');
            },

            showViz(url, title) {
                const container = document.getElementById('vizContainer');
                const titleEl = document.getElementById('vizTitle');
                const frame = document.getElementById('vizFrame');

                titleEl.textContent = title;
                frame.src = url;
                container.style.display = 'block';

                // Scroll to visualization
                container.scrollIntoView({ behavior: 'smooth' });

                // Add export buttons after iframe loads
                frame.onload = () => {
                    const baseName = title.toLowerCase().replace(/\s+/g, '-');
                    addExportButtons('vizContainer', 'vizFrame', baseName);
                };
            },

            closeViz() {
                const container = document.getElementById('vizContainer');
                const frame = document.getElementById('vizFrame');

                // Exit fullscreen if active
                if (container.classList.contains('fullscreen')) {
                    this.toggleVizFullscreen();
                }

                container.style.display = 'none';
                frame.src = 'about:blank';
            },

            // Viz container fullscreen state
            vizFullscreen: false,
            _vizEscHandler: null,

            toggleVizFullscreen() {
                const container = document.getElementById('vizContainer');
                const btn = document.getElementById('vizFullscreenBtn');
                if (!container) return;

                this.vizFullscreen = !this.vizFullscreen;

                if (this.vizFullscreen) {
                    container.classList.add('fullscreen');
                    document.body.style.overflow = 'hidden';
                    if (btn) btn.innerHTML = '&#10005;'; // X icon when fullscreen

                    // Add ESC key listener
                    this._vizEscHandler = (e) => {
                        if (e.key === 'Escape') this.toggleVizFullscreen();
                    };
                    document.addEventListener('keydown', this._vizEscHandler);
                } else {
                    container.classList.remove('fullscreen');
                    document.body.style.overflow = '';
                    if (btn) btn.innerHTML = '&#9974;'; // Restore expand icon

                    // Remove ESC key listener
                    if (this._vizEscHandler) {
                        document.removeEventListener('keydown', this._vizEscHandler);
                        this._vizEscHandler = null;
                    }
                }
            },

            openInNewTab() {
                const frame = document.getElementById('vizFrame');
                if (frame.src && frame.src !== 'about:blank') {
                    window.open(frame.src, '_blank');
                }
            }
        };

        // =================================================================
        // Audit Application (v0.4)
        // =================================================================
        const auditApp = {
            projectPath: null,
            detectionResult: null,
            riskResult: null,
            driftResult: null,
            allProfiles: [],

            async init() {
                // Sync project path from dashboard if available
                const dashPath = document.getElementById('dashboardProjectPath')?.value;
                if (dashPath) {
                    document.getElementById('auditProjectPath').value = dashPath;
                }
            },

            async checkSourcesStatus() {
                const path = document.getElementById('auditProjectPath').value.trim();
                if (!path) return;

                try {
                    const response = await fetch(`/api/audit/sources-status?project_path=${encodeURIComponent(path)}`);
                    const data = await response.json();

                    // Update source badges
                    const sources = data.sources || {};

                    // Filesystem
                    const fsEl = document.getElementById('sourceFilesystem');
                    fsEl.dataset.available = sources.filesystem?.available ? 'true' : 'false';
                    fsEl.querySelector('.source-status').textContent = sources.filesystem?.status || 'Ready';

                    // RAG
                    const ragEl = document.getElementById('sourceRag');
                    ragEl.dataset.available = sources.rag?.available ? 'true' : 'false';
                    let ragStatus = 'Not indexed';
                    if (sources.rag?.available) {
                        const status = sources.rag.status === 'active' ? 'Active' : 'Indexed';
                        const count = sources.rag.file_count || '?';
                        ragStatus = `${status} (${count} files)`;
                    }
                    ragEl.querySelector('.source-status').textContent = ragStatus;

                    // AST
                    const astEl = document.getElementById('sourceAst');
                    astEl.dataset.available = sources.ast?.available ? 'true' : 'false';
                    let astStatus = 'Not cached';
                    if (sources.ast?.available) {
                        const count = sources.ast.node_count || '?';
                        astStatus = `Cached (${count} nodes)`;
                    }
                    astEl.querySelector('.source-status').textContent = astStatus;

                } catch (error) {
                    console.error('Failed to check sources:', error);
                }
            },

            async detectServices() {
                const path = document.getElementById('auditProjectPath').value.trim();
                if (!path) {
                    alert('Please enter a project path');
                    return;
                }

                this.projectPath = path;
                const btn = document.getElementById('auditDetectBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="btn-icon-left">&#8987;</span> Detecting...';

                try {
                    // Check sources first
                    await this.checkSourcesStatus();

                    // Run detection
                    const response = await fetch(`/api/audit/detect-services?project_path=${encodeURIComponent(path)}`);
                    if (!response.ok) throw new Error(await response.text());

                    this.detectionResult = await response.json();
                    console.log('Detection result:', this.detectionResult);

                    // Update summary cards
                    document.getElementById('auditSummary').style.display = 'grid';
                    document.getElementById('auditTotalServices').textContent =
                        this.detectionResult.summary?.total_services || 0;

                    // Enable run audit button
                    document.getElementById('auditRunBtn').disabled = false;

                    // Show services in table (without risk data yet)
                    this.renderServicesTable(this.detectionResult.services || {});

                    // Show main content
                    document.getElementById('auditMainContent').style.display = 'grid';

                } catch (error) {
                    console.error('Detection failed:', error);
                    alert('Detection failed: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="btn-icon-left">&#128269;</span> Detect Services';
                }
            },

            async runFullAudit() {
                if (!this.projectPath) {
                    alert('Please detect services first');
                    return;
                }

                const btn = document.getElementById('auditRunBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="btn-icon-left">&#8987;</span> Running...';

                try {
                    // Get full audit (timeline + risk + drift)
                    const response = await fetch(`/api/audit/full?project_path=${encodeURIComponent(this.projectPath)}`);
                    if (!response.ok) throw new Error(await response.text());

                    const fullAudit = await response.json();
                    console.log('Full audit:', fullAudit);

                    this.riskResult = fullAudit.risk;
                    this.driftResult = fullAudit.drift;

                    // Update summary
                    const riskSummary = this.riskResult?.summary || {};
                    const highRisk = (riskSummary.by_level?.high?.count || 0) +
                                     (riskSummary.by_level?.critical?.count || 0);
                    document.getElementById('auditHighRisk').textContent = highRisk;
                    document.getElementById('auditAvgRisk').textContent =
                        (riskSummary.avg_risk_score || 0).toFixed(2);

                    // Drift alerts count
                    const driftSummary = this.driftResult?.summary || {};
                    const alertCount = (driftSummary.by_severity?.error?.count || 0) +
                                       (driftSummary.by_severity?.warning?.count || 0);
                    document.getElementById('auditDriftAlerts').textContent = alertCount;

                    // Render risk matrix
                    await this.renderRiskMatrix();

                    // Update profiles table with risk data
                    this.renderProfilesWithRisk();

                    // Render drift alerts
                    this.renderDriftAlerts();
                    document.getElementById('auditDriftWrapper').style.display = 'block';

                    // Show AI Insights and Report sections
                    document.getElementById('auditInsightsWrapper').style.display = 'block';
                    document.getElementById('auditReportSection').style.display = 'block';

                } catch (error) {
                    console.error('Audit failed:', error);
                    alert('Audit failed: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="btn-icon-left">&#9881;</span> Run Audit';
                }
            },

            renderServicesTable(services) {
                const tbody = document.getElementById('auditProfilesBody');
                const profiles = [];

                for (const [id, svc] of Object.entries(services)) {
                    profiles.push({
                        id: id,
                        type: svc.type || 'unknown',
                        files: svc.file_count || 0,
                        age: null,
                        risk: null,
                        riskLevel: null,
                        category: null,
                        confidence: svc.confidence || 0,
                    });
                }

                this.allProfiles = profiles;
                document.getElementById('auditProfilesCount').textContent = profiles.length;

                if (profiles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="audit-table-empty">No services detected</td></tr>';
                    return;
                }

                tbody.innerHTML = profiles.map(p => `
                    <tr data-id="${p.id}">
                        <td><strong>${p.id}</strong></td>
                        <td>${this.formatType(p.type)}</td>
                        <td>${p.files}</td>
                        <td>-</td>
                        <td><span class="risk-badge">Pending</span></td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-sm" onclick="auditApp.viewComponent('${p.id}')" title="View details">&#128269;</button>
                        </td>
                    </tr>
                `).join('');
            },

            renderProfilesWithRisk() {
                if (!this.riskResult?.risks) return;

                const risks = this.riskResult.risks;
                const timeline = this.detectionResult?.services || {};

                // Merge data
                for (const profile of this.allProfiles) {
                    const risk = risks[profile.id];
                    if (risk) {
                        profile.risk = risk.score;
                        profile.riskLevel = risk.level;
                        profile.category = risk.timeline?.category;
                        profile.age = risk.timeline?.age_years;
                    }
                }

                this.sortProfiles();
            },

            sortProfiles() {
                const sortBy = document.getElementById('auditProfilesSort').value;
                const profiles = [...this.allProfiles];

                switch (sortBy) {
                    case 'risk-desc':
                        profiles.sort((a, b) => (b.risk || 0) - (a.risk || 0));
                        break;
                    case 'risk-asc':
                        profiles.sort((a, b) => (a.risk || 0) - (b.risk || 0));
                        break;
                    case 'age-desc':
                        profiles.sort((a, b) => (b.age || 0) - (a.age || 0));
                        break;
                    case 'age-asc':
                        profiles.sort((a, b) => (a.age || 0) - (b.age || 0));
                        break;
                    case 'id-asc':
                        profiles.sort((a, b) => a.id.localeCompare(b.id));
                        break;
                }

                this.renderProfilesRows(profiles);
            },

            filterProfiles() {
                const filter = document.getElementById('auditProfilesFilter').value.toLowerCase();
                const filtered = this.allProfiles.filter(p =>
                    p.id.toLowerCase().includes(filter) ||
                    p.type.toLowerCase().includes(filter)
                );
                this.renderProfilesRows(filtered);
            },

            renderProfilesRows(profiles) {
                const tbody = document.getElementById('auditProfilesBody');

                if (profiles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="audit-table-empty">No matching services</td></tr>';
                    return;
                }

                tbody.innerHTML = profiles.map(p => `
                    <tr data-id="${p.id}">
                        <td><strong>${p.id}</strong></td>
                        <td>${this.formatType(p.type)}</td>
                        <td>${p.files}</td>
                        <td>${p.age !== null ? p.age.toFixed(1) + 'y' : '-'}</td>
                        <td>${this.formatRiskBadge(p.riskLevel, p.risk)}</td>
                        <td>${this.formatCategoryBadge(p.category)}</td>
                        <td>
                            <button class="btn btn-sm" onclick="auditApp.viewComponent('${p.id}')" title="View details">&#128269;</button>
                        </td>
                    </tr>
                `).join('');
            },

            formatType(type) {
                const icons = { service: '&#9881;', screen: '&#128187;', general: '&#128230;' };
                return `${icons[type] || ''} ${type}`;
            },

            formatRiskBadge(level, score) {
                if (!level) return '<span class="risk-badge">Pending</span>';
                const scoreText = score !== null ? ` (${(score * 100).toFixed(0)}%)` : '';
                return `<span class="risk-badge ${level}">${level}${scoreText}</span>`;
            },

            formatCategoryBadge(category) {
                if (!category) return '-';
                const display = category.replace(/_/g, ' ');
                return `<span class="category-badge ${category}">${display}</span>`;
            },

            async renderRiskMatrix() {
                const container = document.getElementById('riskMatrixChart');

                try {
                    const response = await fetch(`/api/audit/risk/matrix?project_path=${encodeURIComponent(this.projectPath)}`);
                    if (!response.ok) throw new Error('Failed to load matrix');

                    const data = await response.json();
                    const matrix = data.matrix || [];

                    // Simple SVG-based matrix (no D3 dependency)
                    // Use container dimensions for responsive sizing
                    const width = container.clientWidth || 400;
                    const height = container.clientHeight || 280;
                    const margin = { top: 20, right: 20, bottom: 40, left: 50 };
                    const plotWidth = width - margin.left - margin.right;
                    const plotHeight = height - margin.top - margin.bottom;

                    const colorMap = {
                        low: '#238636',
                        medium: '#d29922',
                        high: '#da3633',
                        critical: '#8b0000'
                    };

                    // Create SVG
                    let svg = `<svg width="${width}" height="${height}" style="font-family: inherit;">`;

                    // Background quadrants
                    svg += `<rect x="${margin.left}" y="${margin.top}" width="${plotWidth/2}" height="${plotHeight/2}" fill="rgba(35,134,54,0.1)"/>`;
                    svg += `<rect x="${margin.left + plotWidth/2}" y="${margin.top}" width="${plotWidth/2}" height="${plotHeight/2}" fill="rgba(210,153,34,0.1)"/>`;
                    svg += `<rect x="${margin.left}" y="${margin.top + plotHeight/2}" width="${plotWidth/2}" height="${plotHeight/2}" fill="rgba(210,153,34,0.05)"/>`;
                    svg += `<rect x="${margin.left + plotWidth/2}" y="${margin.top + plotHeight/2}" width="${plotWidth/2}" height="${plotHeight/2}" fill="rgba(218,54,51,0.1)"/>`;

                    // Axes
                    svg += `<line x1="${margin.left}" y1="${margin.top + plotHeight}" x2="${margin.left + plotWidth}" y2="${margin.top + plotHeight}" stroke="#444" stroke-width="1"/>`;
                    svg += `<line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + plotHeight}" stroke="#444" stroke-width="1"/>`;

                    // Labels
                    svg += `<text x="${margin.left + plotWidth/2}" y="${height - 5}" text-anchor="middle" fill="#8b949e" font-size="12">Impact </text>`;
                    svg += `<text x="15" y="${margin.top + plotHeight/2}" text-anchor="middle" fill="#8b949e" font-size="12" transform="rotate(-90, 15, ${margin.top + plotHeight/2})">Complexity </text>`;

                    // Points
                    for (const point of matrix) {
                        const x = margin.left + point.x * plotWidth;
                        const y = margin.top + plotHeight - (point.y * plotHeight);
                        const r = 6 + (point.size || 0.3) * 10;
                        const color = colorMap[point.color] || '#888';

                        svg += `<circle cx="${x}" cy="${y}" r="${r}" fill="${color}" fill-opacity="0.7" stroke="${color}" stroke-width="2" style="cursor: pointer;">
                            <title>${point.id}: Risk ${(point.score * 100).toFixed(0)}%</title>
                        </circle>`;
                        svg += `<text x="${x}" y="${y + 3}" text-anchor="middle" fill="white" font-size="9" font-weight="bold" pointer-events="none">${point.id}</text>`;
                    }

                    svg += '</svg>';
                    container.innerHTML = svg;

                } catch (error) {
                    console.error('Matrix render failed:', error);
                    container.innerHTML = '<div class="risk-matrix-loading">Failed to load risk matrix</div>';
                }
            },

            renderDriftAlerts() {
                const reports = this.driftResult?.reports || {};
                const list = document.getElementById('auditDriftList');

                const alerts = Object.values(reports)
                    .filter(r => r.severity !== 'info' || document.getElementById('auditDriftInfo').checked)
                    .sort((a, b) => {
                        const order = ['critical', 'error', 'warning', 'info'];
                        return order.indexOf(a.severity) - order.indexOf(b.severity);
                    });

                document.getElementById('auditDriftCount').textContent = alerts.length;

                if (alerts.length === 0) {
                    list.innerHTML = '<div class="audit-drift-empty">No drift alerts</div>';
                    return;
                }

                const icons = { critical: '&#128680;', error: '&#9888;', warning: '&#9888;', info: '&#8505;' };

                list.innerHTML = alerts.map(alert => `
                    <div class="drift-alert-card ${alert.severity}">
                        <div class="drift-alert-icon">${icons[alert.severity] || '&#8505;'}</div>
                        <div class="drift-alert-content">
                            <div class="drift-alert-header">
                                <span class="drift-alert-component">${alert.component_id}</span>
                                <span class="drift-alert-type">${alert.drift_type}</span>
                            </div>
                            <div class="drift-alert-message">${alert.message}</div>
                            <div class="drift-alert-meta">
                                <span>Drift: ${alert.drift_days} days</span>
                                <span>Gap score: ${(alert.gap_score * 100).toFixed(0)}%</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            filterDrift() {
                this.renderDriftAlerts();
            },

            toggleSection(section) {
                const toggle = document.getElementById(`audit${section.charAt(0).toUpperCase() + section.slice(1)}Toggle`);
                const content = document.getElementById(`audit${section.charAt(0).toUpperCase() + section.slice(1)}Section`) ||
                               document.getElementById(`audit${section.charAt(0).toUpperCase() + section.slice(1)}Content`);

                if (toggle && content) {
                    toggle.classList.toggle('collapsed');
                    content.classList.toggle('collapsed');
                }
            },

            // Fullscreen state for audit sections
            fullscreenSections: {},
            _escHandlers: {},

            toggleSectionFullscreen(sectionName) {
                const wrapperIds = {
                    'matrix': 'auditMatrixWrapper',
                    'profiles': 'auditProfilesWrapper',
                    'drift': 'auditDriftWrapper',
                    'insights': 'auditInsightsWrapper'
                };
                const iconIds = {
                    'matrix': 'matrixFullscreenIcon',
                    'profiles': 'profilesFullscreenIcon',
                    'drift': 'driftFullscreenIcon',
                    'insights': 'insightsFullscreenIcon'
                };

                const wrapper = document.getElementById(wrapperIds[sectionName]);
                const icon = document.getElementById(iconIds[sectionName]);
                if (!wrapper) return;

                // Close any other fullscreen section first
                Object.keys(this.fullscreenSections).forEach(name => {
                    if (name !== sectionName && this.fullscreenSections[name]) {
                        this.fullscreenSections[name] = false;
                        const otherWrapper = document.getElementById(wrapperIds[name]);
                        if (otherWrapper) otherWrapper.classList.remove('fullscreen');
                        const otherIcon = document.getElementById(iconIds[name]);
                        if (otherIcon) otherIcon.innerHTML = '&#9974;';
                        if (this._escHandlers[name]) {
                            document.removeEventListener('keydown', this._escHandlers[name]);
                        }
                    }
                });

                this.fullscreenSections[sectionName] = !this.fullscreenSections[sectionName];

                if (this.fullscreenSections[sectionName]) {
                    wrapper.classList.add('fullscreen');
                    document.body.style.overflow = 'hidden';
                    if (icon) icon.innerHTML = '&#10005;'; // X icon when fullscreen

                    // Expand the section if collapsed
                    const sectionContent = wrapper.querySelector('.audit-section-content');
                    if (sectionContent && sectionContent.classList.contains('collapsed')) {
                        sectionContent.classList.remove('collapsed');
                        const toggle = wrapper.querySelector('.audit-section-toggle');
                        if (toggle) toggle.classList.remove('collapsed');
                    }

                    // Re-render risk matrix if it's the matrix section (to fit new size)
                    if (sectionName === 'matrix' && this.riskResult) {
                        // Wait for CSS to fully apply, force layout flush, then render
                        setTimeout(() => {
                            // Force layout recalculation
                            const container = document.getElementById('riskMatrixChart');
                            void container.offsetHeight;
                            this.renderRiskMatrix();
                        }, 150);
                    }

                    // Add ESC key listener
                    this._escHandlers[sectionName] = (e) => {
                        if (e.key === 'Escape') this.toggleSectionFullscreen(sectionName);
                    };
                    document.addEventListener('keydown', this._escHandlers[sectionName]);
                } else {
                    wrapper.classList.remove('fullscreen');
                    document.body.style.overflow = '';
                    if (icon) icon.innerHTML = '&#9974;'; // Restore expand icon

                    // Remove ESC key listener
                    if (this._escHandlers[sectionName]) {
                        document.removeEventListener('keydown', this._escHandlers[sectionName]);
                    }

                    // Re-render risk matrix when exiting fullscreen (to fit normal size)
                    if (sectionName === 'matrix' && this.riskResult) {
                        setTimeout(() => {
                            const container = document.getElementById('riskMatrixChart');
                            void container.offsetHeight;
                            this.renderRiskMatrix();
                        }, 150);
                    }
                }
            },

            async viewComponent(id) {
                // Show component details - for now just log
                console.log('View component:', id);

                if (this.riskResult?.risks?.[id]) {
                    const risk = this.riskResult.risks[id];
                    alert(`${id}\n\nRisk Score: ${(risk.score * 100).toFixed(0)}%\nLevel: ${risk.level}\n\n${risk.recommendation}`);
                }
            },

            async openSettings() {
                const modal = document.getElementById('auditSettingsModal');
                modal.style.display = 'flex';

                // Load current settings from API
                try {
                    const path = this.projectPath || document.getElementById('auditProjectPath').value.trim();
                    if (path) {
                        const response = await fetch(`/api/audit/config?project_path=${encodeURIComponent(path)}`);
                        if (response.ok) {
                            const config = await response.json();

                            // Populate thresholds
                            if (config.thresholds) {
                                document.getElementById('settingDriftDays').value = config.thresholds.drift_days || 90;
                                document.getElementById('settingNewDays').value = config.thresholds.new_component_days || 180;
                                document.getElementById('settingLegacyYears').value = config.thresholds.legacy_years || 3;
                            }

                            // Populate weights
                            if (config.risk_weights) {
                                document.getElementById('settingWeightAge').value = config.risk_weights.age || 0.2;
                                document.getElementById('settingWeightVolatility').value = config.risk_weights.volatility || 0.25;
                                document.getElementById('settingWeightComplexity').value = config.risk_weights.complexity || 0.2;
                                document.getElementById('settingWeightDocCoverage').value = config.risk_weights.doc_coverage || 0.15;
                                document.getElementById('settingWeightTestCoverage').value = config.risk_weights.test_coverage || 0.2;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Failed to load settings:', e);
                }

                this.updateWeightTotal();

                // Add listeners for weight updates
                document.querySelectorAll('.settings-row input[id^="settingWeight"]').forEach(input => {
                    input.addEventListener('input', () => this.updateWeightTotal());
                });
            },

            closeSettings() {
                document.getElementById('auditSettingsModal').style.display = 'none';
            },

            updateWeightTotal() {
                const age = parseFloat(document.getElementById('settingWeightAge').value) || 0;
                const volatility = parseFloat(document.getElementById('settingWeightVolatility').value) || 0;
                const complexity = parseFloat(document.getElementById('settingWeightComplexity').value) || 0;
                const docCoverage = parseFloat(document.getElementById('settingWeightDocCoverage').value) || 0;
                const testCoverage = parseFloat(document.getElementById('settingWeightTestCoverage').value) || 0;
                const total = age + volatility + complexity + docCoverage + testCoverage;

                const totalEl = document.getElementById('settingWeightTotal');
                totalEl.textContent = total.toFixed(2);
                totalEl.style.color = Math.abs(total - 1.0) < 0.05 ? 'var(--accent-color)' : '#ef4444';
            },

            resetSettings() {
                document.getElementById('settingDriftDays').value = 90;
                document.getElementById('settingNewDays').value = 180;
                document.getElementById('settingLegacyYears').value = 3;
                document.getElementById('settingWeightAge').value = 0.2;
                document.getElementById('settingWeightVolatility').value = 0.25;
                document.getElementById('settingWeightComplexity').value = 0.2;
                document.getElementById('settingWeightDocCoverage').value = 0.15;
                document.getElementById('settingWeightTestCoverage').value = 0.2;
                this.updateWeightTotal();
            },

            async saveSettings() {
                const path = this.projectPath || document.getElementById('auditProjectPath').value.trim();
                if (!path) {
                    alert('Please select a project first');
                    return;
                }

                const config = {
                    thresholds: {
                        drift_days: parseInt(document.getElementById('settingDriftDays').value),
                        new_component_days: parseInt(document.getElementById('settingNewDays').value),
                        legacy_years: parseInt(document.getElementById('settingLegacyYears').value),
                    },
                    risk_weights: {
                        age: parseFloat(document.getElementById('settingWeightAge').value),
                        volatility: parseFloat(document.getElementById('settingWeightVolatility').value),
                        complexity: parseFloat(document.getElementById('settingWeightComplexity').value),
                        doc_coverage: parseFloat(document.getElementById('settingWeightDocCoverage').value),
                        test_coverage: parseFloat(document.getElementById('settingWeightTestCoverage').value),
                    }
                };

                try {
                    const response = await fetch(`/api/audit/config?project_path=${encodeURIComponent(path)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }

                    this.closeSettings();

                    // Re-run audit with new settings if we have results
                    if (this.riskResult) {
                        await this.runFullAudit();
                    }
                } catch (e) {
                    alert('Failed to save settings: ' + e.message);
                }
            },

            async refresh() {
                if (this.projectPath) {
                    await this.checkSourcesStatus();
                    if (this.riskResult) {
                        await this.runFullAudit();
                    }
                }
            },

            // ========== AI Insights Methods ==========

            insightsCache: {},

            insightFocusChanged() {
                // Clear cached result when focus changes
                const focus = document.getElementById('insightFocusSelect').value;
                if (this.insightsCache[focus]) {
                    this.displayInsights(this.insightsCache[focus]);
                }
            },

            async generateInsights() {
                const path = this.projectPath;
                if (!path) {
                    alert('Please select a project first');
                    return;
                }

                if (!this.riskResult) {
                    alert('Please run an audit first to generate insights');
                    return;
                }

                const focus = document.getElementById('insightFocusSelect').value;
                const btn = document.getElementById('generateInsightsBtn');

                // Show loading state
                document.getElementById('insightsPlaceholder').style.display = 'none';
                document.getElementById('insightsLoading').style.display = 'block';
                document.getElementById('insightsResult').style.display = 'none';
                btn.disabled = true;
                btn.innerHTML = '&#9889; Generating...';

                try {
                    const response = await fetch(`/api/audit/insights?project_path=${encodeURIComponent(path)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ focus: focus })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error);
                    }

                    const result = await response.json();
                    this.insightsCache[focus] = result;
                    this.displayInsights(result);

                } catch (error) {
                    console.error('Insight generation failed:', error);
                    document.getElementById('insightsLoading').style.display = 'none';
                    document.getElementById('insightsPlaceholder').style.display = 'block';
                    document.getElementById('insightsPlaceholder').innerHTML = `
                        <p style="color: var(--error-color);">Failed to generate insights: ${error.message}</p>
                        <p class="muted">Make sure Ollama is running and try again.</p>
                    `;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '&#9889; Generate';
                }
            },

            displayInsights(result) {
                document.getElementById('insightsLoading').style.display = 'none';
                document.getElementById('insightsPlaceholder').style.display = 'none';
                document.getElementById('insightsResult').style.display = 'block';

                const summary = result.data_summary || {};
                document.getElementById('insightsMeta').innerHTML = `
                    <span>Focus: <strong>${result.focus}</strong></span>
                    <span>Components: ${summary.components || 0}</span>
                    <span>Services: ${summary.services_detected || 0}</span>
                    <span>Critical: ${summary.risk_critical || 0}</span>
                    <span>Generated: ${result.generated_at?.slice(0, 16).replace('T', ' ') || 'now'}</span>
                `;

                // Convert markdown to HTML
                let text = result.insights || '';
                text = text.replace(/^### (.+)$/gm, '<h4>$1</h4>');
                text = text.replace(/^## (.+)$/gm, '<h3>$1</h3>');
                text = text.replace(/^# (.+)$/gm, '<h2>$1</h2>');
                text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
                text = text.replace(/^- (.+)$/gm, '<li>$1</li>');
                text = text.replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>');
                text = text.replace(/((?:<li>.*?<\/li>\s*)+)/g, '<ul>$1</ul>');
                text = text.replace(/\n\n+/g, '</p><p>');
                text = '<p>' + text + '</p>';
                text = text.replace(/<p><\/p>/g, '');
                text = text.replace(/<p>(<h[234]>)/g, '$1');
                text = text.replace(/(<\/h[234]>)<\/p>/g, '$1');
                text = text.replace(/<p>(<ul>)/g, '$1');
                text = text.replace(/(<\/ul>)<\/p>/g, '$1');

                document.getElementById('insightsText').innerHTML = text;
            },

            // ========== Report Methods ==========

            openReport() {
                const path = this.projectPath;
                if (!path) {
                    alert('Please select a project first');
                    return;
                }

                const reportType = document.getElementById('reportTypeSelect').value;
                const insightFocus = document.getElementById('reportInsightsSelect').value;
                const includeInsights = insightFocus !== 'none';

                let url = `/api/audit/report/html?project_path=${encodeURIComponent(path)}`;
                url += `&report_type=${reportType}`;
                url += `&include_insights=${includeInsights}`;
                if (includeInsights) {
                    url += `&insight_focus=${insightFocus}`;
                }

                // Open in new tab
                window.open(url, '_blank');
            },

            async downloadReport() {
                const path = this.projectPath;
                if (!path) {
                    alert('Please select a project first');
                    return;
                }

                const reportType = document.getElementById('reportTypeSelect').value;
                const insightFocus = document.getElementById('reportInsightsSelect').value;
                const includeInsights = insightFocus !== 'none';

                let url = `/api/audit/report/html?project_path=${encodeURIComponent(path)}`;
                url += `&report_type=${reportType}`;
                url += `&include_insights=${includeInsights}`;
                if (includeInsights) {
                    url += `&insight_focus=${insightFocus}`;
                }

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to generate report');

                    const html = await response.text();
                    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
                    const downloadUrl = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `audit-report-${path.split('/').pop()}-${new Date().toISOString().slice(0, 10)}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(downloadUrl);

                } catch (error) {
                    alert('Failed to download report: ' + error.message);
                }
            }
        };

        // Initialize audit app when tab is shown
        document.addEventListener('DOMContentLoaded', () => {
            const auditTab = document.querySelector('[data-tab="audit"]');
            if (auditTab) {
                auditTab.addEventListener('click', () => {
                    auditApp.init();
                });
            }
        });

        // Logs Application
        const logsApp = {
            currentView: 'logs',

            async refresh() {
                const mode = document.getElementById('logViewMode')?.value || 'logs';
                this.currentView = mode;

                if (mode === 'chain') {
                    await this.loadChain();
                } else if (mode === 'traces') {
                    await this.loadTraces();
                } else {
                    await this.loadLogs();
                }

                // Also load stats
                await this.loadStats();
            },

            async loadLogs() {
                const content = document.getElementById('logsContent');
                content.innerHTML = '<p>Loading logs...</p>';

                try {
                    const resp = await fetch('/api/logs/server?limit=100');
                    const data = await resp.json();
                    const logs = data.logs || [];

                    if (logs.length === 0) {
                        const sessResp = await fetch('/api/sessions');
                        const sessData = await sessResp.json();
                        const sessions = sessData.sessions || [];

                        if (sessions.length === 0) {
                            content.innerHTML = '<p style="color: var(--text-secondary);">No logs yet. Start using RAGIX to generate logs.</p>';
                            return;
                        }

                        const session = sessions[0];
                        const logsResp = await fetch(`/api/sessions/${session.id}/logs?limit=100`);
                        const logsData = await logsResp.json();
                        const sessionLogs = logsData.logs || [];

                        if (sessionLogs.length === 0) {
                            content.innerHTML = '<p style="color: var(--text-secondary);">No logs yet.</p>';
                            return;
                        }

                        content.innerHTML = sessionLogs.map(line => this.formatLogLine(line)).join('');
                    } else {
                        content.innerHTML = logs.map(entry => this.formatLogLine(entry.line || entry, entry.session)).join('');
                    }
                } catch (e) {
                    content.innerHTML = `<p style="color: #f85149;">Error loading logs: ${e.message}</p>`;
                }
            },

            async loadChain() {
                const content = document.getElementById('logsContent');
                content.innerHTML = '<p>Loading hash chain...</p>';

                try {
                    const resp = await fetch('/api/logs/chain?limit=100');
                    const data = await resp.json();
                    const entries = data.entries || [];

                    if (!data.has_integrity || entries.length === 0) {
                        content.innerHTML = '<p style="color: var(--text-secondary);">No hash chain entries yet. Commands will be logged with SHA256 hashes.</p>';
                        return;
                    }

                    content.innerHTML = entries.map(entry => `
                        <div class="chain-entry">
                            <div class="chain-header">
                                <span class="chain-seq">#${entry.sequence}</span>
                                <span class="chain-time">${entry.timestamp}</span>
                            </div>
                            <div class="chain-content">${escapeHtml(entry.content)}</div>
                            <div class="chain-hashes">
                                <span class="hash-label">Hash:</span>
                                <span class="hash-value">${entry.hash.substring(0, 16)}...</span>
                                <span class="hash-label">Prev:</span>
                                <span class="hash-value">${entry.prev_hash.substring(0, 16)}...</span>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    content.innerHTML = `<p style="color: #f85149;">Error loading chain: ${e.message}</p>`;
                }
            },

            async loadTraces() {
                const content = document.getElementById('logsContent');
                content.innerHTML = '<p>Loading traces...</p>';

                try {
                    const resp = await fetch('/api/traces?limit=50');
                    const data = await resp.json();
                    const traces = data.traces || [];

                    if (traces.length === 0) {
                        content.innerHTML = '<p style="color: var(--text-secondary);">No tool traces yet.</p>';
                        return;
                    }

                    content.innerHTML = traces.map(trace => `
                        <div class="trace-item">
                            <div class="trace-header">
                                <span class="trace-type">${trace.event || trace.action || 'event'}</span>
                                <span class="trace-time">${trace.timestamp || ''}</span>
                            </div>
                            <div class="trace-detail">${escapeHtml(JSON.stringify(trace.data || trace, null, 2).substring(0, 300))}</div>
                        </div>
                    `).join('');
                } catch (e) {
                    content.innerHTML = `<p style="color: #f85149;">Error loading traces: ${e.message}</p>`;
                }
            },

            async loadStats() {
                try {
                    const resp = await fetch('/api/logs/stats');
                    const data = await resp.json();
                    const sessions = data.sessions || [];

                    const statsEl = document.getElementById('logStats');
                    if (sessions.length > 0) {
                        const session = sessions[0];
                        document.getElementById('statEntries').textContent = session.log_file?.entries || 0;
                        document.getElementById('statChain').textContent = session.hash_chain?.entries || 0;
                        document.getElementById('statSize').textContent = (session.log_file?.size_kb || 0) + ' KB';
                        statsEl.style.display = 'flex';
                    }
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            },

            async verifyIntegrity() {
                const statusEl = document.getElementById('integrityStatus');
                const iconEl = statusEl.querySelector('.integrity-icon');
                const msgEl = statusEl.querySelector('.integrity-message');
                const detailsEl = statusEl.querySelector('.integrity-details');

                statusEl.style.display = 'flex';
                statusEl.className = 'integrity-status checking';
                iconEl.innerHTML = '&#8987;';
                msgEl.textContent = 'Verifying hash chain integrity...';
                detailsEl.textContent = '';

                try {
                    const resp = await fetch('/api/logs/integrity');
                    const data = await resp.json();
                    const results = data.results || [];

                    if (data.overall_valid) {
                        statusEl.className = 'integrity-status valid';
                        iconEl.innerHTML = '&#10003;';
                        msgEl.textContent = 'Integrity Verified';
                        const total = results.reduce((sum, r) => sum + (r.verified_entries || 0), 0);
                        detailsEl.textContent = `${total} entries verified with SHA256 hash chain`;
                    } else {
                        statusEl.className = 'integrity-status invalid';
                        iconEl.innerHTML = '&#10007;';
                        msgEl.textContent = 'Integrity Check Failed';
                        const errors = results.flatMap(r => r.errors || []);
                        detailsEl.textContent = errors.slice(0, 3).join('; ');
                    }
                } catch (e) {
                    statusEl.className = 'integrity-status error';
                    iconEl.innerHTML = '&#9888;';
                    msgEl.textContent = 'Verification Error';
                    detailsEl.textContent = e.message;
                }
            },

            changeView() {
                this.refresh();
            },

            formatLogLine(line, session = null) {
                // Defensive: ensure line is a string
                let lineStr;
                if (typeof line === 'string') {
                    lineStr = line;
                } else if (line && typeof line === 'object') {
                    // Handle object entries - extract meaningful content
                    lineStr = line.content || line.message || line.line ||
                              line.command || line.event || JSON.stringify(line);
                } else {
                    lineStr = String(line || '');
                }

                let cls = 'log-entry';
                if (lineStr.includes('CMD:')) cls += ' log-cmd';
                else if (lineStr.includes('EDIT:')) cls += ' log-edit';
                else if (lineStr.includes('ERROR')) cls += ' log-error';
                else if (lineStr.includes('EVENT:')) cls += ' log-event';
                const sessionTag = session ? `<span style="color: #8b949e;">[${session}]</span> ` : '';
                return `<div class="${cls}">${sessionTag}${escapeHtml(lineStr)}</div>`;
            }
        };

        // Agents Application
        const agentsApp = {
            selectedAgent: null,

            async load() {
                const container = document.getElementById('agentList');
                try {
                    const resp = await fetch('/api/agents');
                    const data = await resp.json();
                    const agents = data.agents || [];

                    if (!data.available || agents.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-secondary); font-size: 11px;">No agents available</p>';
                        return;
                    }

                    container.innerHTML = agents.map(agent => `
                        <div class="agent-item" data-agent="${agent.id}" onclick="agentsApp.select('${agent.id}')">
                            <span class="agent-icon">${agent.icon}</span>
                            <span class="agent-name">${agent.name}</span>
                            <div class="agent-desc">${agent.description}</div>
                        </div>
                    `).join('');
                } catch (e) {
                    container.innerHTML = '<p style="color: #f85149; font-size: 11px;">Error loading agents</p>';
                }
            },

            select(agentId) {
                this.selectedAgent = agentId;
                document.querySelectorAll('.agent-item').forEach(el => {
                    el.classList.toggle('selected', el.dataset.agent === agentId);
                });
                // Update chat placeholder to indicate selected agent
                const input = document.getElementById('chatInput');
                input.placeholder = `Ask ${agentId} agent... (Shift+Enter for new line, Enter to send)`;
            }
        };

        // Workflows Application
        const workflowsApp = {
            workflows: [],
            selectedWorkflow: null,
            expanded: false,
            defaultShowCount: 5,

            async load() {
                const container = document.getElementById('workflowList');
                try {
                    const resp = await fetch('/api/workflows');
                    const data = await resp.json();
                    const workflows = data.workflows || [];

                    if (!data.available || workflows.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-secondary); font-size: 11px;">No workflows available</p>';
                        return;
                    }

                    this.workflows = workflows;
                    this.render();
                } catch (e) {
                    container.innerHTML = '<p style="color: #f85149; font-size: 11px;">Error loading workflows</p>';
                }
            },

            render() {
                const container = document.getElementById('workflowList');
                const showCount = this.expanded ? this.workflows.length : this.defaultShowCount;
                const hasMore = this.workflows.length > this.defaultShowCount;

                container.innerHTML = this.workflows.slice(0, showCount).map(wf => `
                    <div class="workflow-item ${this.selectedWorkflow === wf.id ? 'selected' : ''}"
                         data-workflow="${wf.id}"
                         onclick="workflowsApp.select('${wf.id}')"
                         title="${wf.description || ''}">
                        <span class="workflow-name">${wf.name.replace(' Workflow', '')}</span>
                        <div class="workflow-desc">${(wf.steps || []).length} steps</div>
                    </div>
                `).join('') + (hasMore ? `
                    <div class="workflow-toggle" onclick="workflowsApp.toggleExpand()">
                        ${this.expanded
                            ? '<span>&#9650; Show less</span>'
                            : `<span>&#9660; +${this.workflows.length - this.defaultShowCount} more...</span>`
                        }
                    </div>
                ` : '');
            },

            toggleExpand() {
                this.expanded = !this.expanded;
                this.render();
            },

            select(workflowId) {
                // Toggle selection if clicking same workflow
                if (this.selectedWorkflow === workflowId) {
                    this.selectedWorkflow = null;
                    this.render();
                    document.getElementById('chatInput').placeholder = 'Ask RAGIX anything...';
                    return;
                }

                this.selectedWorkflow = workflowId;
                this.render();

                const wf = this.workflows.find(w => w.id === workflowId);
                if (wf) {
                    this.showWorkflowDetails(wf);
                }
            },

            showWorkflowDetails(wf) {
                // Show workflow info in chat input placeholder
                const input = document.getElementById('chatInput');
                const params = (wf.parameters || []).map(p => p.name).join(', ') || 'none';
                input.placeholder = `Use ${wf.name}... (parameters: ${params})`;

                // Show detailed info as a system message
                const stepsHtml = (wf.steps || []).map((s, i) =>
                    `${i + 1}. ${s.name} (${s.agent_type})`
                ).join('\n');

                const paramsHtml = (wf.parameters || []).map(p =>
                    `- ${p.name}${p.required ? '*' : ''}: ${p.description || p.type}`
                ).join('\n') || 'None';

                if (typeof app !== 'undefined' && app.addSystemMessage) {
                    app.addSystemMessage(
                        `**${wf.name}**\n` +
                        `${wf.description || ''}\n\n` +
                        `**Steps:**\n${stepsHtml}\n\n` +
                        `**Parameters:**\n${paramsHtml}\n\n` +
                        `_Click workflow again to deselect, or type a message to start._`
                    );
                }
            },

            async run(workflowId, params = {}) {
                // For future: actually run the workflow
                const wf = this.workflows.find(w => w.id === workflowId);
                if (!wf) return;

                if (typeof app !== 'undefined' && app.addSystemMessage) {
                    app.addSystemMessage(`Starting workflow: ${wf.name}...`);
                }
                // TODO: Implement actual workflow execution via API
            }
        };

        // Traces Application
        const tracesApp = {
            async load() {
                const container = document.getElementById('traceContent');
                try {
                    const resp = await fetch('/api/traces?limit=50');
                    const data = await resp.json();
                    const traces = data.traces || [];

                    if (traces.length === 0) {
                        container.innerHTML = '<p class="trace-empty">No traces yet. Start chatting to see tool calls here.</p>';
                        return;
                    }

                    container.innerHTML = traces.map(trace => `
                        <div class="trace-item">
                            <div class="trace-header">
                                <span class="trace-type">${trace.event || trace.action || 'event'}</span>
                                <span class="trace-time">${trace.timestamp || ''}</span>
                            </div>
                            <div class="trace-detail">${escapeHtml(JSON.stringify(trace.data || trace, null, 2).substring(0, 200))}</div>
                        </div>
                    `).join('');
                } catch (e) {
                    container.innerHTML = `<p style="color: #f85149;">Error loading traces: ${e.message}</p>`;
                }
            }
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Agent Settings Application
        const agentSettingsApp = {
            config: null,
            availableModels: [],

            async init() {
                await this.loadConfig();
                await this.populateModelSelects();
                this.setupSettingsTabs();
            },

            setupSettingsTabs() {
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        const targetId = tab.dataset.settingsTab + 'Settings';
                        document.getElementById(targetId)?.classList.add('active');

                        // Load agent config when switching to agents tab
                        if (tab.dataset.settingsTab === 'agents') {
                            this.loadConfig();
                        }
                    });
                });
            },

            async loadConfig() {
                try {
                    // Use app.sessionId as the source of truth (not sessionIdInput which may be stale)
                    const sessionId = (typeof app !== 'undefined' && app.sessionId) ? app.sessionId :
                                      (document.getElementById('sessionIdInput')?.value || 'default');
                    const resp = await fetch(`/api/agents/config?session_id=${encodeURIComponent(sessionId)}`);
                    this.config = await resp.json();
                    this.availableModels = this.config.available_models || [];
                    this.updateUI();
                    this.updateReasoningDisplay();
                } catch (e) {
                    console.error('Failed to load agent config:', e);
                }
            },

            async populateModelSelects() {
                const selects = ['singleModelInput', 'plannerModelInput', 'workerModelInput', 'verifierModelInput'];
                const models = this.availableModels;

                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;

                    select.innerHTML = models.length > 0
                        ? models.map(m => `<option value="${m.name}">${m.name} (${m.size_gb?.toFixed(1) || '?'}GB)</option>`).join('')
                        : '<option value="granite3.1-moe:3b">granite3.1-moe:3b (default)</option>';
                });

                // Set current values
                if (this.config) {
                    document.getElementById('agentModeInput').value = this.config.mode;
                    document.getElementById('plannerModelInput').value = this.config.planner_model;
                    document.getElementById('workerModelInput').value = this.config.worker_model;
                    document.getElementById('verifierModelInput').value = this.config.verifier_model;
                }
            },

            updateUI() {
                if (!this.config) return;

                const mode = this.config.mode;
                const singleMode = document.getElementById('singleModelMode');
                const agentModeInput = document.getElementById('agentModeInput');

                // Update mode display
                agentModeInput.value = mode;

                // Show/hide per-agent models based on mode
                const perAgentModels = document.getElementById('perAgentModels');
                if (mode === 'custom') {
                    perAgentModels.style.display = 'block';
                } else {
                    perAgentModels.style.display = 'none';
                }

                // Update VRAM warning visibility
                this.checkVRAMWarning();
            },

            updateReasoningDisplay() {
                if (!this.config) return;

                document.getElementById('plannerModelDisplay').textContent = this.config.planner_model || '-';
                document.getElementById('workerModelDisplay').textContent = this.config.worker_model || '-';
                document.getElementById('verifierModelDisplay').textContent = this.config.verifier_model || '-';
                document.getElementById('agentModeDisplay').textContent = this.config.mode || 'minimal';

                // Update config note
                const noteText = document.getElementById('configNoteText');
                if (this.config.mode === 'minimal') {
                    noteText.textContent = 'Single-model mode recommended for 8GB VRAM to avoid load/unload overhead.';
                } else if (this.config.mode === 'strict') {
                    noteText.textContent = 'Using 7B model for planning, 3B for execution. May require model switching.';
                } else {
                    noteText.textContent = 'Custom configuration. Ensure your system has sufficient VRAM for all models.';
                }
            },

            toggleSingleMode() {
                const singleMode = document.getElementById('singleModelMode').checked;
                const singleModelGroup = document.getElementById('singleModelGroup');
                const agentModeGroup = document.getElementById('agentModeGroup');
                const perAgentModels = document.getElementById('perAgentModels');

                if (singleMode) {
                    singleModelGroup.style.display = 'block';
                    agentModeGroup.style.display = 'none';
                    perAgentModels.style.display = 'none';
                } else {
                    singleModelGroup.style.display = 'none';
                    agentModeGroup.style.display = 'block';
                    this.changeMode();
                }
            },

            changeMode() {
                const mode = document.getElementById('agentModeInput').value;
                const perAgentModels = document.getElementById('perAgentModels');

                if (mode === 'custom') {
                    perAgentModels.style.display = 'block';
                } else {
                    perAgentModels.style.display = 'none';
                }

                this.checkVRAMWarning();
            },

            checkVRAMWarning() {
                const warning = document.getElementById('vramWarning');
                const mode = document.getElementById('agentModeInput').value;

                // Show warning for strict mode or custom with multiple large models
                if (mode === 'strict') {
                    warning.style.display = 'flex';
                } else {
                    warning.style.display = 'none';
                }
            },

            async save() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';
                const singleMode = document.getElementById('singleModelMode').checked;
                const mode = singleMode ? 'minimal' : document.getElementById('agentModeInput').value;

                const payload = {
                    mode: mode,
                    single_model_mode: singleMode,
                    single_model: singleMode ? document.getElementById('singleModelInput').value : null,
                    planner_model: document.getElementById('plannerModelInput').value,
                    worker_model: document.getElementById('workerModelInput').value,
                    verifier_model: document.getElementById('verifierModelInput').value,
                };

                try {
                    const resp = await fetch(`/api/agents/config?session_id=${sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (resp.ok) {
                        await this.loadConfig();
                        console.log('Agent config saved');
                    } else {
                        const err = await resp.json();
                        alert('Failed to save agent config: ' + (err.detail || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Error saving agent config: ' + e.message);
                }
            },

            async reset() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/agents/config?session_id=${sessionId}`, {
                        method: 'DELETE',
                    });

                    if (resp.ok) {
                        await this.loadConfig();
                        alert('Agent config reset to defaults');
                    }
                } catch (e) {
                    alert('Error resetting config: ' + e.message);
                }
            }
        };

        // Reasoning Application
        const reasoningApp = {
            traces: [],
            filterType: 'all',

            async init() {
                await this.refresh();
            },

            async refresh() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/agents/reasoning?session_id=${sessionId}&limit=50`);
                    const data = await resp.json();
                    this.traces = data.traces || [];
                    this.render();
                } catch (e) {
                    console.error('Failed to load reasoning traces:', e);
                }

                // Also refresh config display
                agentSettingsApp.loadConfig();
            },

            filter() {
                this.filterType = document.getElementById('reasoningFilter').value;
                this.render();
            },

            render() {
                const container = document.getElementById('reasoningTimeline');

                let filtered = this.traces;
                if (this.filterType !== 'all') {
                    filtered = this.traces.filter(t => {
                        const type = (t.type || t.event || '').toLowerCase();
                        return type.includes(this.filterType);
                    });
                }

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div class="reasoning-empty">
                            <span class="empty-icon">&#129504;</span>
                            <p>No reasoning traces yet. Start a chat to see the agent's thinking process.</p>
                            <p class="empty-hint">The agent will show its planning, execution, and verification steps here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filtered.map(trace => {
                    const type = this.getTraceType(trace);
                    const content = trace.content || trace.data || JSON.stringify(trace, null, 2);
                    const timestamp = trace.timestamp ? new Date(trace.timestamp).toLocaleTimeString() : '';

                    // Extract thinking content if present
                    let thinking = '';
                    if (typeof content === 'string' && content.includes('<thinking>')) {
                        const match = content.match(/<thinking>([\s\S]*?)<\/thinking>/);
                        if (match) thinking = match[1].trim();
                    }

                    return `
                        <div class="reasoning-trace type-${type}">
                            <div class="trace-meta">
                                <span class="trace-type-badge ${type}">${type}</span>
                                <span class="trace-timestamp">${timestamp}</span>
                            </div>
                            <div class="trace-content">${escapeHtml(typeof content === 'string' ? content.substring(0, 500) : JSON.stringify(content).substring(0, 500))}</div>
                            ${thinking ? `<div class="trace-thinking">${escapeHtml(thinking.substring(0, 300))}</div>` : ''}
                        </div>
                    `;
                }).join('');
            },

            getTraceType(trace) {
                const type = (trace.type || trace.event || '').toLowerCase();
                if (type.includes('plan')) return 'planning';
                if (type.includes('exec') || type.includes('work')) return 'execution';
                if (type.includes('verif') || type.includes('check')) return 'verification';
                return 'reasoning';
            },

            async clear() {
                if (!confirm('Clear all reasoning traces for this session?')) return;

                this.traces = [];
                this.render();
            }
        };

        // v0.23 Reasoning Graph Application
        const reasoningGraph = {
            available: false,
            strategy: 'unknown',
            currentState: null,

            async init() {
                await this.refresh();
            },

            async refresh() {
                try {
                    const resp = await fetch('/api/reasoning/status');
                    const data = await resp.json();

                    this.available = data.available;
                    this.strategy = data.strategy;

                    // Update status display
                    const indicator = document.querySelector('#graphStatus .status-indicator');
                    const statusText = document.getElementById('graphStatusText');

                    if (data.available) {
                        indicator.className = 'status-indicator available';
                        statusText.textContent = `Graph available (strategy: ${data.strategy})`;
                    } else {
                        indicator.className = 'status-indicator unavailable';
                        statusText.textContent = 'Reasoning graph not available';
                    }
                } catch (e) {
                    console.error('Failed to check reasoning graph status:', e);
                    const indicator = document.querySelector('#graphStatus .status-indicator');
                    indicator.className = 'status-indicator unavailable';
                    document.getElementById('graphStatusText').textContent = 'Error checking status';
                }
            },

            async showNodes() {
                if (!this.available) {
                    alert('Reasoning graph not available');
                    return;
                }

                try {
                    const resp = await fetch('/api/reasoning/nodes');
                    const data = await resp.json();

                    // Render nodes as a flow diagram
                    const viz = document.getElementById('graphVisualization');
                    viz.innerHTML = `
                        <div class="graph-flow">
                            ${data.nodes.map((node, i) => `
                                <span class="graph-node">${node.name}</span>
                                ${i < data.nodes.length - 1 ? '<span class="graph-arrow"></span>' : ''}
                            `).join('')}
                        </div>
                    `;
                } catch (e) {
                    console.error('Failed to load nodes:', e);
                }
            },

            async showExperience() {
                if (!this.available) {
                    alert('Reasoning graph not available');
                    return;
                }

                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/reasoning/experience/stats?session_id=${sessionId}`);
                    const data = await resp.json();

                    const viz = document.getElementById('graphVisualization');
                    viz.innerHTML = `
                        <div style="padding: 20px; text-align: left;">
                            <h4 style="margin: 0 0 15px 0; color: var(--accent-blue);">Experience Corpus Statistics</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <strong>Global Corpus</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 12px;">
                                        <li>Total: ${data.global_count}</li>
                                        <li>Successes: ${data.global_successes}</li>
                                        <li>Failures: ${data.global_failures}</li>
                                    </ul>
                                </div>
                                <div>
                                    <strong>Project Corpus</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 12px;">
                                        <li>Total: ${data.project_count}</li>
                                        <li>Successes: ${data.project_successes}</li>
                                        <li>Failures: ${data.project_failures}</li>
                                    </ul>
                                </div>
                            </div>
                            <p style="margin-top: 15px; font-size: 11px; color: var(--text-secondary);">
                                Total events: ${data.total_events}
                            </p>
                        </div>
                    `;
                } catch (e) {
                    console.error('Failed to load experience stats:', e);
                }
            },

            async classify() {
                if (!this.available) {
                    alert('Reasoning graph not available');
                    return;
                }

                const goal = prompt('Enter a task/goal to classify:');
                if (!goal) return;

                try {
                    const resp = await fetch(`/api/reasoning/classify?goal=${encodeURIComponent(goal)}`);
                    const data = await resp.json();

                    const viz = document.getElementById('graphVisualization');
                    viz.innerHTML = `
                        <div style="padding: 20px; text-align: left;">
                            <h4 style="margin: 0 0 15px 0; color: var(--accent-blue);">Classification Result</h4>
                            <p><strong>Goal:</strong> ${escapeHtml(data.goal)}</p>
                            <p><strong>Complexity:</strong> <span style="color: var(--accent-green);">${data.complexity.toUpperCase()}</span></p>
                            <p><strong>Next Node:</strong> ${data.next_node}</p>
                            <p><strong>Max Reflections:</strong> ${data.max_reflections}</p>
                            <p><strong>Uses Planning:</strong> ${data.uses_planning ? 'Yes' : 'No'}</p>
                        </div>
                    `;
                } catch (e) {
                    console.error('Failed to classify:', e);
                }
            },

            updateFromWebSocket(data) {
                // Called when we receive reasoning_graph_state from WebSocket
                this.currentState = data.state;

                // Show stats
                const statsDiv = document.getElementById('graphStats');
                statsDiv.style.display = 'grid';

                document.getElementById('graphComplexity').textContent = data.state.complexity || '-';
                document.getElementById('graphCurrentNode').textContent = data.current_node || '-';
                document.getElementById('graphReflections').textContent =
                    `${data.state.reflection_count || 0}/${data.state.max_reflections || 2}`;
                document.getElementById('graphStopReason').textContent = data.state.stop_reason || 'running';

                // Update visualization with visited path
                if (data.state.node_trace && data.state.node_trace.length > 0) {
                    const nodes = ['START', 'CLASSIFY', 'PLAN', 'EXECUTE', 'VERIFY', 'REFLECT', 'RESPOND', 'END'];
                    const visited = new Set(data.state.node_trace.map(t => {
                        const parts = t.split(':');
                        return parts.length > 1 ? parts[1] : t;
                    }));

                    const viz = document.getElementById('graphVisualization');
                    viz.innerHTML = `
                        <div class="graph-flow">
                            ${nodes.map((node, i) => `
                                <span class="graph-node ${visited.has(node) ? 'visited' : ''} ${node === data.current_node ? 'active' : ''}">${node}</span>
                                ${i < nodes.length - 1 ? '<span class="graph-arrow"></span>' : ''}
                            `).join('')}
                        </div>
                    `;
                }
            }
        };

        // v0.32 Memory Context Application for Reasoning Tab
        const memoryContext = {
            entries: [],
            usedMemories: new Set(),  // Track which memories were used in current reasoning
            currentGoal: null,

            async init() {
                await this.refresh();
            },

            async refresh() {
                try {
                    const sessionId = (typeof app !== 'undefined' && app.sessionId) ? app.sessionId : 'default';
                    const resp = await fetch(`/api/sessions/${encodeURIComponent(sessionId)}/episodic?limit=50`);
                    const data = await resp.json();

                    this.entries = data.entries || [];
                    this.updateStats();
                    this.renderList(this.entries);
                } catch (e) {
                    console.error('Failed to load memory context:', e);
                    this.renderEmpty('Failed to load memories');
                }
            },

            updateStats() {
                document.getElementById('memoryTotalCount').textContent = this.entries.length;

                // Count unique sessions
                const sessions = new Set(this.entries.map(e => e.task_id?.split('-').slice(0, 3).join('-')));
                document.getElementById('memorySessionCount').textContent = sessions.size;

                // Update used count in button
                const usedCount = this.usedMemories.size;
                const usedBtnCount = document.getElementById('memoryUsedBtnCount');
                if (usedBtnCount) {
                    usedBtnCount.textContent = usedCount;
                }

                // Update current goal display
                const goalEl = document.getElementById('memoryCurrentGoal');
                if (goalEl) {
                    if (this.currentGoal) {
                        const shortGoal = this.currentGoal.length > 15
                            ? this.currentGoal.substring(0, 15) + '...'
                            : this.currentGoal;
                        goalEl.textContent = shortGoal;
                        goalEl.title = this.currentGoal;
                    } else {
                        goalEl.textContent = '-';
                        goalEl.title = 'No active reasoning goal';
                    }
                }
            },

            renderList(entries) {
                const container = document.getElementById('memoryContextList');

                if (!entries || entries.length === 0) {
                    this.renderEmpty('No episodic memories yet');
                    return;
                }

                container.innerHTML = entries.map(entry => {
                    const isUsed = this.usedMemories.has(entry.task_id);
                    const filesCount = entry.files_touched?.length || 0;
                    const cmdsCount = entry.commands_run?.length || 0;
                    const timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : '-';

                    return `
                        <div class="memory-context-entry ${isUsed ? 'used-in-reasoning' : ''}"
                             data-task-id="${escapeHtml(entry.task_id)}"
                             onclick="memoryContext.showDetails('${escapeHtml(entry.task_id)}')">
                            <div class="memory-goal">
                                ${isUsed ? '<span class="memory-used-badge">Used</span> ' : ''}
                                ${escapeHtml(entry.user_goal?.substring(0, 80) || 'Unknown goal')}${(entry.user_goal?.length || 0) > 80 ? '...' : ''}
                            </div>
                            <div class="memory-result">${escapeHtml(entry.result_summary?.substring(0, 100) || '')}</div>
                            <div class="memory-meta">
                                <span class="memory-files">${filesCount} files, ${cmdsCount} commands</span>
                                <span>${timestamp}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderEmpty(message) {
                document.getElementById('memoryContextList').innerHTML = `
                    <div class="memory-context-empty">
                        <span class="empty-icon">&#128218;</span>
                        <p>${escapeHtml(message)}</p>
                    </div>
                `;
            },

            handleSearchKeyup(event) {
                if (event.key === 'Enter') {
                    this.search();
                }
            },

            async search() {
                const query = document.getElementById('memoryContextSearchInput').value.trim();
                if (!query) {
                    this.refresh();
                    return;
                }

                try {
                    const sessionId = (typeof app !== 'undefined' && app.sessionId) ? app.sessionId : 'default';
                    const resp = await fetch(`/api/sessions/${encodeURIComponent(sessionId)}/episodic/search?q=${encodeURIComponent(query)}&limit=20`);
                    const data = await resp.json();

                    if (data.results && data.results.length > 0) {
                        this.renderList(data.results);
                    } else {
                        this.renderEmpty(`No memories matching "${query}"`);
                    }
                } catch (e) {
                    console.error('Failed to search memories:', e);
                    this.renderEmpty('Search failed');
                }
            },

            async showRelevant() {
                // Show memories relevant to current reasoning goal
                let query = this.currentGoal;

                // If no active goal, prompt user or use search input
                if (!query) {
                    const searchInput = document.getElementById('memoryContextSearchInput').value.trim();
                    if (searchInput) {
                        query = searchInput;
                    } else {
                        // Try to get the last user message from chat
                        if (typeof app !== 'undefined' && app.messageHistory && app.messageHistory.length > 0) {
                            const lastUserMsg = [...app.messageHistory].reverse().find(m => m.role === 'user');
                            if (lastUserMsg) {
                                query = lastUserMsg.content.substring(0, 100);
                            }
                        }
                    }
                }

                if (!query) {
                    this.renderEmpty('Enter a search query or start a task');
                    return;
                }

                try {
                    const sessionId = (typeof app !== 'undefined' && app.sessionId) ? app.sessionId : 'default';
                    const resp = await fetch(`/api/sessions/${encodeURIComponent(sessionId)}/episodic/search?q=${encodeURIComponent(query)}&limit=10`);
                    const data = await resp.json();

                    if (data.results && data.results.length > 0) {
                        this.renderList(data.results);
                    } else {
                        this.renderEmpty('No relevant memories found');
                    }
                } catch (e) {
                    console.error('Failed to search memories:', e);
                }
            },

            showUsed() {
                // Filter to show only memories used in current reasoning
                if (this.usedMemories.size === 0) {
                    this.renderEmpty('No memories used in current reasoning session');
                    return;
                }

                const usedEntries = this.entries.filter(e => this.usedMemories.has(e.task_id));
                this.renderList(usedEntries);
            },

            currentDetailTaskId: null,

            async showDetails(taskId) {
                try {
                    const sessionId = (typeof app !== 'undefined' && app.sessionId) ? app.sessionId : 'default';
                    const resp = await fetch(`/api/sessions/${encodeURIComponent(sessionId)}/episodic/${encodeURIComponent(taskId)}`);
                    const entry = await resp.json();

                    if (!entry) {
                        alert('Memory entry not found');
                        return;
                    }

                    this.currentDetailTaskId = taskId;

                    // Format timestamp
                    const timestamp = entry.timestamp ? new Date(entry.timestamp).toLocaleString() : '-';

                    // Build formatted HTML content
                    const filesHtml = (entry.files_touched && entry.files_touched.length > 0)
                        ? `<ul>${entry.files_touched.map(f => `<li><code>${escapeHtml(f)}</code></li>`).join('')}</ul>`
                        : '<p class="memory-details-empty">No files touched</p>';

                    const commandsHtml = (entry.commands_run && entry.commands_run.length > 0)
                        ? `<ul>${entry.commands_run.map(c => `<li><code>$ ${escapeHtml(c.substring(0, 100))}${c.length > 100 ? '...' : ''}</code></li>`).join('')}</ul>`
                        : '<p class="memory-details-empty">No commands recorded</p>';

                    const decisionsHtml = (entry.key_decisions && entry.key_decisions.length > 0)
                        ? `<ul>${entry.key_decisions.map(d => `<li>${escapeHtml(d)}</li>`).join('')}</ul>`
                        : '<p class="memory-details-empty">No decisions recorded</p>';

                    const questionsHtml = (entry.open_questions && entry.open_questions.length > 0)
                        ? `<ul>${entry.open_questions.map(q => `<li>${escapeHtml(q)}</li>`).join('')}</ul>`
                        : '<p class="memory-details-empty">No open questions</p>';

                    const html = `
                        <div class="memory-details">
                            <div class="memory-details-header">
                                <h3>${escapeHtml(entry.user_goal || 'Unknown goal')}</h3>
                                <div class="memory-details-meta">
                                    <span>&#128197; ${timestamp}</span>
                                    <span>&#128196; ${entry.files_touched?.length || 0} files</span>
                                    <span>&#9881; ${entry.commands_run?.length || 0} commands</span>
                                </div>
                            </div>

                            <div class="memory-details-section plan">
                                <h4>&#128203; Plan Summary</h4>
                                <p>${escapeHtml(entry.plan_summary || 'No plan recorded')}</p>
                            </div>

                            <div class="memory-details-section result">
                                <h4>&#9989; Result</h4>
                                <p>${escapeHtml(entry.result_summary || 'No result recorded')}</p>
                            </div>

                            <div class="memory-details-section decisions">
                                <h4>&#128161; Key Decisions</h4>
                                ${decisionsHtml}
                            </div>

                            <div class="memory-details-section files">
                                <h4>&#128193; Files Touched</h4>
                                ${filesHtml}
                            </div>

                            <div class="memory-details-section commands">
                                <h4>&#128187; Commands Run</h4>
                                ${commandsHtml}
                            </div>

                            ${(entry.open_questions && entry.open_questions.length > 0) ? `
                            <div class="memory-details-section">
                                <h4>&#10067; Open Questions</h4>
                                ${questionsHtml}
                            </div>
                            ` : ''}

                            <div style="font-size: 11px; color: var(--text-muted); text-align: right;">
                                Task ID: ${escapeHtml(entry.task_id || '-')}
                            </div>
                        </div>
                    `;

                    document.getElementById('memoryDetailsBody').innerHTML = html;
                    document.getElementById('memoryDetailsModal').classList.remove('hidden');
                } catch (e) {
                    console.error('Failed to load memory details:', e);
                    alert('Failed to load memory details');
                }
            },

            closeDetails() {
                document.getElementById('memoryDetailsModal').classList.add('hidden');
                this.currentDetailTaskId = null;
            },

            async deleteCurrentEntry() {
                if (!this.currentDetailTaskId) return;

                if (!confirm('Delete this memory entry? This cannot be undone.')) {
                    return;
                }

                try {
                    const sessionId = (typeof app !== 'undefined' && app.sessionId) ? app.sessionId : 'default';
                    const resp = await fetch(`/api/sessions/${encodeURIComponent(sessionId)}/episodic/${encodeURIComponent(this.currentDetailTaskId)}`, {
                        method: 'DELETE'
                    });

                    if (resp.ok) {
                        this.closeDetails();
                        await this.refresh();
                    } else {
                        alert('Failed to delete entry');
                    }
                } catch (e) {
                    console.error('Failed to delete entry:', e);
                    alert('Failed to delete entry');
                }
            },

            // Called when reasoning starts to set the current goal
            setCurrentGoal(goal) {
                this.currentGoal = goal;
                this.usedMemories.clear();
                this.updateStats();
            },

            // Called when a memory is used during reasoning
            markAsUsed(taskId) {
                this.usedMemories.add(taskId);
                this.updateStats();
                // Update visual indicator
                const entryEl = document.querySelector(`.memory-context-entry[data-task-id="${taskId}"]`);
                if (entryEl) {
                    entryEl.classList.add('used-in-reasoning');
                }
            },

            // Called from WebSocket when reasoning state updates
            updateFromWebSocket(data) {
                if (data.goal) {
                    this.setCurrentGoal(data.goal);
                }
                if (data.used_memories && Array.isArray(data.used_memories)) {
                    data.used_memories.forEach(taskId => this.markAsUsed(taskId));
                }
            }
        };

        // Reasoning Settings Application (v0.23)
        // Model inheritance: Reasoning  Agent Config  Session
        const reasoningSettingsApp = {
            config: null,

            async init() {
                await this.loadConfig();
            },

            async loadConfig() {
                try {
                    // Use app.sessionId as the source of truth (not sessionIdInput which may be stale)
                    const sessionId = (typeof app !== 'undefined' && app.sessionId) ? app.sessionId :
                                      (document.getElementById('sessionIdInput')?.value || 'default');
                    const resp = await fetch(`/api/reasoning/status?session_id=${encodeURIComponent(sessionId)}`);
                    const data = await resp.json();
                    this.config = data;

                    // Update strategy dropdown
                    const strategyInput = document.getElementById('reasoningStrategyInput');
                    if (strategyInput && data.strategy) {
                        strategyInput.value = data.strategy;
                    }

                    // Update max reflections
                    const maxReflInput = document.getElementById('maxReflectionsInput');
                    if (maxReflInput && data.max_reflections !== undefined) {
                        maxReflInput.value = data.max_reflections;
                    }

                    // Update reasoning model display (inherited from session/agent)
                    const modelDisplay = document.getElementById('reasoningModelDisplay');
                    if (modelDisplay) {
                        const model = data.reasoning_model || data.session_model || 'Not set';
                        modelDisplay.textContent = model;
                    }

                    // Update experience corpus toggle
                    const corpusToggle = document.getElementById('enableExperienceCorpus');
                    if (corpusToggle && data.experience_corpus_enabled !== undefined) {
                        corpusToggle.checked = data.experience_corpus_enabled;
                    }

                    // Update sidebar display
                    const sidebarStrategy = document.getElementById('reasoningStrategy');
                    if (sidebarStrategy && data.strategy) {
                        sidebarStrategy.textContent = data.strategy;
                    }

                    // Update status display in settings
                    const indicator = document.querySelector('#reasoningSettingsStatus .status-indicator');
                    const statusText = document.getElementById('reasoningSettingsStatusText');

                    if (indicator && statusText) {
                        if (data.available) {
                            indicator.className = 'status-indicator available';
                            const overrideNote = data.is_session_override ? ' (session override)' : '';
                            statusText.textContent = `Graph available (${data.strategy})${overrideNote}`;
                        } else {
                            indicator.className = 'status-indicator unavailable';
                            statusText.textContent = 'Graph not available';
                        }
                    }
                } catch (e) {
                    console.error('Failed to load reasoning config:', e);
                }
            },

            changeStrategy() {
                const strategy = document.getElementById('reasoningStrategyInput').value;
                console.log('Reasoning strategy changed to:', strategy);
            },

            async save() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';
                const strategy = document.getElementById('reasoningStrategyInput').value;
                const maxReflections = parseInt(document.getElementById('maxReflectionsInput')?.value || '2');
                const enableCorpus = document.getElementById('enableExperienceCorpus')?.checked ?? true;

                try {
                    // Save to backend (no reasoning_model - it's inherited)
                    const resp = await fetch(`/api/reasoning/config?session_id=${encodeURIComponent(sessionId)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            strategy: strategy,
                            max_reflections: maxReflections,
                            experience_corpus_enabled: enableCorpus
                        })
                    });

                    if (!resp.ok) {
                        throw new Error('Failed to save reasoning config');
                    }

                    const data = await resp.json();

                    // Update the sidebar display
                    const strategyEl = document.getElementById('reasoningStrategy');
                    if (strategyEl) {
                        strategyEl.textContent = strategy;
                    }

                    // Refresh the reasoning graph display
                    await reasoningGraph.refresh();

                    // Update load config to reflect changes
                    await this.loadConfig();

                    // Refresh session info in main app
                    if (typeof app !== 'undefined' && app.loadSessionInfo) {
                        await app.loadSessionInfo();
                    }

                    // Show success feedback
                    console.log('Reasoning settings saved:', data);

                    // Show a brief indicator that settings were saved
                    const statusText = document.getElementById('reasoningSettingsStatusText');
                    if (statusText) {
                        const originalText = statusText.textContent;
                        statusText.textContent = ' Settings saved!';
                        setTimeout(() => {
                            statusText.textContent = originalText;
                        }, 2000);
                    }

                } catch (e) {
                    alert('Error saving reasoning settings: ' + e.message);
                }
            },

            reset() {
                document.getElementById('reasoningStrategyInput').value = 'loop_v1';
                document.getElementById('maxReflectionsInput').value = '2';
                document.getElementById('enableExperienceCorpus').checked = true;
                // Model is inherited - no reset needed
            }
        };

        // Memory Management Application
        const memoryApp = {
            messages: [],

            async refresh() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/sessions/${sessionId}/memory?limit=100`);
                    if (!resp.ok) {
                        throw new Error('Session not found');
                    }
                    const data = await resp.json();
                    this.messages = data.messages || [];
                    this.updateStats(data);
                    this.render();
                } catch (e) {
                    document.getElementById('memoryList').innerHTML = `
                        <p style="color: var(--text-secondary);">
                            Connect to a session first to view memory.
                            <br><small>${e.message}</small>
                        </p>
                    `;
                }
            },

            updateStats(data) {
                const total = data.total_messages || 0;
                const messages = data.messages || [];
                const userCount = messages.filter(m => m.role === 'user').length;
                const assistantCount = messages.filter(m => m.role === 'assistant').length;

                document.getElementById('memoryTotalMessages').textContent = total;
                document.getElementById('memoryUserMessages').textContent = userCount;
                document.getElementById('memoryAssistantMessages').textContent = assistantCount;
            },

            render() {
                const container = document.getElementById('memoryList');

                if (this.messages.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">No messages in memory.</p>';
                    return;
                }

                container.innerHTML = this.messages.map(msg => `
                    <div class="memory-item memory-${msg.role}">
                        <div class="memory-item-header">
                            <span class="memory-role ${msg.role}">${msg.role === 'user' ? 'You' : 'Assistant'}</span>
                            <span class="memory-timestamp">${msg.timestamp ? new Date(msg.timestamp).toLocaleString() : ''}</span>
                            <button class="btn btn-icon btn-sm btn-danger" onclick="memoryApp.deleteMessage(${msg.index})" title="Delete this message">&#128465;</button>
                        </div>
                        <div class="memory-content">${escapeHtml(msg.content)}</div>
                        ${msg.full_content_length > 500 ? `<small class="memory-truncated">Truncated (${msg.full_content_length} chars total)</small>` : ''}
                    </div>
                `).join('');
            },

            async deleteMessage(index) {
                if (!confirm(`Delete message #${index}?`)) return;

                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/sessions/${sessionId}/memory/${index}`, {
                        method: 'DELETE'
                    });

                    if (resp.ok) {
                        await this.refresh();
                    } else {
                        alert('Failed to delete message');
                    }
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            },

            async clearAll() {
                const keepLast = parseInt(document.getElementById('keepLastInput')?.value || '0');
                const msg = keepLast > 0
                    ? `Clear memory and keep only the last ${keepLast} messages?`
                    : 'Clear ALL session memory? This cannot be undone.';

                if (!confirm(msg)) return;

                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/sessions/${sessionId}/memory?keep_last=${keepLast}`, {
                        method: 'DELETE'
                    });

                    if (resp.ok) {
                        const data = await resp.json();
                        alert(`Cleared ${data.previous_count - data.current_count} messages. ${data.current_count} remaining.`);
                        await this.refresh();
                    } else {
                        alert('Failed to clear memory');
                    }
                } catch (e) {
                    alert('Error: ' + e.message);
                }
            },

            // v0.33: Load context limits from server/localStorage
            loadContextLimits() {
                const saved = localStorage.getItem('ragix_context_limits');
                if (saved) {
                    try {
                        const limits = JSON.parse(saved);
                        document.getElementById('contextMaxTurns').value = limits.max_turns || 5;
                        document.getElementById('contextUserLimit').value = limits.user_limit || 500;
                        document.getElementById('contextAssistantLimit').value = limits.assistant_limit || 2000;
                    } catch (e) {
                        console.warn('Failed to load context limits:', e);
                    }
                }
            },

            // v0.33: Save context limits to server and localStorage
            async saveContextLimits() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';
                const limits = {
                    max_turns: parseInt(document.getElementById('contextMaxTurns').value) || 5,
                    user_limit: parseInt(document.getElementById('contextUserLimit').value) || 500,
                    assistant_limit: parseInt(document.getElementById('contextAssistantLimit').value) || 2000
                };

                // Save to localStorage
                localStorage.setItem('ragix_context_limits', JSON.stringify(limits));

                // Save to server via agent config API
                try {
                    const resp = await fetch(`/api/sessions/${sessionId}/agent-config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            context_max_turns: limits.max_turns,
                            context_user_limit: limits.user_limit,
                            context_assistant_limit: limits.assistant_limit
                        })
                    });

                    if (resp.ok) {
                        alert('Context limits saved successfully');
                    } else {
                        alert('Saved locally (server update pending on reconnect)');
                    }
                } catch (e) {
                    console.warn('Server save failed, using localStorage:', e);
                    alert('Saved locally (will apply on next session)');
                }
            }
        };

        // User Context Application
        const contextApp = {
            context: null,

            async load() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/sessions/${sessionId}/context`);
                    if (!resp.ok) {
                        this.showStatus('error', 'Session not found. Connect first.');
                        return;
                    }
                    this.context = await resp.json();
                    this.updateUI();
                    this.showStatus('success', 'Context loaded');
                } catch (e) {
                    this.showStatus('error', 'Error: ' + e.message);
                }
            },

            updateUI() {
                if (!this.context) return;

                document.getElementById('systemInstructionsInput').value = this.context.system_instructions || '';
                document.getElementById('customPromptInput').value = this.context.custom_prompt || '';

                // Update preferences checkboxes
                const prefs = this.context.preferences || {};
                document.getElementById('prefVerbose').checked = prefs.verbose || false;
                document.getElementById('prefCodeComments').checked = prefs.code_comments || false;
                document.getElementById('prefStepByStep').checked = prefs.step_by_step || false;
                document.getElementById('prefSafetyFirst').checked = prefs.safety_first || false;
            },

            async save() {
                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                const payload = {
                    system_instructions: document.getElementById('systemInstructionsInput').value,
                    custom_prompt: document.getElementById('customPromptInput').value,
                    preferences: {
                        verbose: document.getElementById('prefVerbose').checked,
                        code_comments: document.getElementById('prefCodeComments').checked,
                        step_by_step: document.getElementById('prefStepByStep').checked,
                        safety_first: document.getElementById('prefSafetyFirst').checked,
                    }
                };

                try {
                    const resp = await fetch(`/api/sessions/${sessionId}/context`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (resp.ok) {
                        const data = await resp.json();
                        this.showStatus('success', `Context saved! (${data.system_instructions_length} chars instructions)`);
                    } else {
                        this.showStatus('error', 'Failed to save context');
                    }
                } catch (e) {
                    this.showStatus('error', 'Error: ' + e.message);
                }
            },

            async clear() {
                if (!confirm('Clear all user context for this session?')) return;

                const sessionId = document.getElementById('sessionIdInput')?.value || 'default';

                try {
                    const resp = await fetch(`/api/sessions/${sessionId}/context`, {
                        method: 'DELETE',
                    });

                    if (resp.ok) {
                        document.getElementById('systemInstructionsInput').value = '';
                        document.getElementById('customPromptInput').value = '';
                        document.getElementById('prefVerbose').checked = false;
                        document.getElementById('prefCodeComments').checked = false;
                        document.getElementById('prefStepByStep').checked = false;
                        document.getElementById('prefSafetyFirst').checked = false;
                        this.showStatus('success', 'Context cleared');
                    } else {
                        this.showStatus('error', 'Failed to clear context');
                    }
                } catch (e) {
                    this.showStatus('error', 'Error: ' + e.message);
                }
            },

            showStatus(type, message) {
                const status = document.getElementById('contextStatus');
                status.style.display = 'flex';
                status.className = `context-status ${type}`;
                status.querySelector('.status-text').textContent = message;

                // Auto-hide after 3 seconds
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        };

        // Initialize all apps
        astApp.init();
        agentsApp.load();
        workflowsApp.load();
        agentSettingsApp.init();
        reasoningApp.init();
        reasoningGraph.init();  // Reasoning Graph
        memoryContext.init();  // Memory Context in Reasoning tab (v0.32)
        reasoningSettingsApp.init();  // Reasoning Settings

        // Update app.showTraces to use tracesApp
        if (typeof app !== 'undefined') {
            const originalShowTraces = app.showTraces;
            app.showTraces = function() {
                if (originalShowTraces) originalShowTraces.call(app);
                tracesApp.load();
            };
        }

        // Dashboard Application
        const dashboardApp = {
            currentProject: null,
            recentProjects: [],

            // Normalize path to prevent duplicates (remove trailing slashes, handle case)
            normalizePath(path) {
                if (!path) return path;
                // Remove trailing slashes (except for root /)
                let normalized = path.replace(/\/+$/, '');
                if (normalized === '') normalized = '/';
                return normalized;
            },

            async init() {
                // Load recent projects from localStorage
                this.loadRecentProjects();
                this.renderRecentProjects();

                // Check system status
                await this.checkSystemStatus();
            },

            loadRecentProjects() {
                try {
                    const stored = localStorage.getItem('ragix_recent_projects');
                    const parsed = stored ? JSON.parse(stored) : [];
                    // Normalize paths and deduplicate (keep first occurrence)
                    const seen = new Set();
                    this.recentProjects = parsed.map(p => ({
                        ...p,
                        path: this.normalizePath(p.path)
                    })).filter(p => {
                        const normalized = this.normalizePath(p.path);
                        if (seen.has(normalized)) return false;
                        seen.add(normalized);
                        return true;
                    });
                    // Save cleaned data back if there were duplicates or path changes
                    if (this.recentProjects.length !== parsed.length) {
                        this.saveRecentProjects();
                    }
                } catch (e) {
                    this.recentProjects = [];
                }
            },

            saveRecentProjects() {
                try {
                    localStorage.setItem('ragix_recent_projects', JSON.stringify(this.recentProjects.slice(0, 10)));
                } catch (e) {
                    console.error('Failed to save recent projects:', e);
                }
            },

            renderRecentProjects() {
                const container = document.getElementById('recentProjects');
                if (this.recentProjects.length === 0) {
                    container.innerHTML = '<p class="recent-empty">No recent projects. Enter a path above to get started.</p>';
                    return;
                }

                container.innerHTML = this.recentProjects.map((p, idx) => `
                    <div class="recent-project-item" onclick="dashboardApp.selectProject(${idx})">
                        <span class="recent-project-path">${p.path}</span>
                        <span class="recent-project-stats">${p.files || '?'} files</span>
                        <button class="btn btn-icon btn-sm" onclick="event.stopPropagation(); dashboardApp.removeProject(${idx})">&#10005;</button>
                    </div>
                `).join('');
            },

            async loadProject() {
                const input = document.getElementById('dashboardProjectPath');
                const rawPath = input.value.trim();

                if (!rawPath) {
                    alert('Please enter a project path');
                    return;
                }

                // Normalize path to prevent duplicates
                const path = this.normalizePath(rawPath);
                input.value = path; // Update input with normalized path
                this.currentProject = path;

                // Remove existing entry with same normalized path
                const existing = this.recentProjects.findIndex(p => this.normalizePath(p.path) === path);
                if (existing >= 0) {
                    this.recentProjects.splice(existing, 1);
                }

                // v0.33: Set Project RAG path (the .RAG/ will be created inside this project)
                try {
                    const ragResp = await fetch(`/api/rag/project/set-project?project_path=${encodeURIComponent(path)}`, {
                        method: 'POST'
                    });
                    if (ragResp.ok) {
                        const ragData = await ragResp.json();
                        console.log('Project RAG set to:', path, ragData);
                        // Update RAG status display
                        projectRagApp.checkStatus();
                    }
                } catch (e) {
                    console.warn('Failed to set Project RAG path:', e);
                }

                // Fetch quick metrics
                try {
                    const resp = await fetch(`/api/ast/metrics?path=${encodeURIComponent(path)}`);
                    if (resp.ok) {
                        const data = await resp.json();

                        // Update stats display
                        document.getElementById('dashStatFiles').textContent = data.summary?.total_files || '-';
                        document.getElementById('dashStatSymbols').textContent =
                            (data.summary?.total_classes || 0) + (data.summary?.total_methods || 0);
                        document.getElementById('dashStatDeps').textContent = data.dependencies?.total || '-';
                        document.getElementById('dashStatDebt').textContent =
                            data.debt?.estimated_hours?.toFixed(1) || '-';

                        // Add to recent with stats
                        this.recentProjects.unshift({
                            path: path,
                            files: data.summary?.total_files || 0,
                            lastAccess: new Date().toISOString()
                        });
                    } else {
                        // Add without stats
                        this.recentProjects.unshift({
                            path: path,
                            files: 0,
                            lastAccess: new Date().toISOString()
                        });
                    }
                } catch (e) {
                    console.error('Failed to load metrics:', e);
                    this.recentProjects.unshift({
                        path: path,
                        files: 0,
                        lastAccess: new Date().toISOString()
                    });
                }

                this.saveRecentProjects();
                this.renderRecentProjects();

                // Also update AST tab
                document.getElementById('projectPath').value = path;
            },

            selectProject(idx) {
                const project = this.recentProjects[idx];
                if (project) {
                    document.getElementById('dashboardProjectPath').value = project.path;
                    this.loadProject();
                }
            },

            removeProject(idx) {
                this.recentProjects.splice(idx, 1);
                this.saveRecentProjects();
                this.renderRecentProjects();
            },

            async checkSystemStatus() {
                // Check Ollama
                try {
                    const resp = await fetch('/api/ollama/models');
                    const data = await resp.json();
                    const dot = document.getElementById('ollamaStatusDot');
                    const text = document.getElementById('ollamaStatusText');
                    if (data.available) {
                        dot.className = 'status-dot status-ok';
                        text.textContent = `Ollama: ${data.count} model(s) available`;
                    } else {
                        dot.className = 'status-dot status-error';
                        text.textContent = `Ollama: ${data.error || 'Not available'}`;
                    }
                } catch (e) {
                    document.getElementById('ollamaStatusDot').className = 'status-dot status-error';
                    document.getElementById('ollamaStatusText').textContent = 'Ollama: Connection error';
                }

                // Check AST
                try {
                    const resp = await fetch('/api/ast/status');
                    const data = await resp.json();
                    const dot = document.getElementById('astStatusDot');
                    const text = document.getElementById('astStatusText');
                    if (data.available) {
                        dot.className = 'status-dot status-ok';
                        text.textContent = 'AST: Ready';
                    } else {
                        dot.className = 'status-dot status-warn';
                        text.textContent = 'AST: Not installed';
                    }
                } catch (e) {
                    document.getElementById('astStatusDot').className = 'status-dot status-error';
                    document.getElementById('astStatusText').textContent = 'AST: Error';
                }

                // Check sandbox
                try {
                    const resp = await fetch('/api/health');
                    const data = await resp.json();
                    const dot = document.getElementById('sandboxStatusDot');
                    const text = document.getElementById('sandboxStatusText');
                    dot.className = 'status-dot status-ok';
                    text.textContent = `Server: v${data.version} | ${data.sessions} session(s)`;
                } catch (e) {
                    document.getElementById('sandboxStatusDot').className = 'status-dot status-error';
                    document.getElementById('sandboxStatusText').textContent = 'Server: Error';
                }

                // Check cache
                try {
                    const resp = await fetch('/api/ast/cache/stats');
                    const data = await resp.json();
                    const dot = document.getElementById('cacheStatusDot');
                    const text = document.getElementById('cacheStatusText');
                    dot.className = 'status-dot status-ok';
                    const entries = data.entry_count || 0;
                    const sizeMb = data.total_size_mb || 0;
                    text.textContent = `Cache: ${entries} project(s), ${sizeMb} MB`;
                } catch (e) {
                    document.getElementById('cacheStatusDot').className = 'status-dot status-warn';
                    document.getElementById('cacheStatusText').textContent = 'Cache: Not available';
                }
            },

            goToChat() {
                document.querySelector('.nav-tab[data-tab="chat"]').click();
            },

            goToAST() {
                if (this.currentProject) {
                    document.getElementById('projectPath').value = this.currentProject;
                }
                document.querySelector('.nav-tab[data-tab="ast"]').click();
            },

            goToLogs() {
                document.querySelector('.nav-tab[data-tab="logs"]').click();
            },

            goToSettings() {
                app.openSettings();
            }
        };

        // Initialize dashboard
        dashboardApp.init();

        // =============================================================================
        // Project RAG Application (v0.33)
        // =============================================================================
        const projectRagApp = {
            isIndexing: false,
            progressInterval: null,
            currentProject: null,

            async init() {
                await this.checkStatus();
            },

            async checkStatus() {
                try {
                    // v0.33: Pass project_path to get status for the selected project
                    const projectPath = dashboardApp.currentProject || document.getElementById('dashboardProjectPath')?.value || '';
                    let url = '/api/rag/project/status';
                    if (projectPath) {
                        url += `?project_path=${encodeURIComponent(projectPath)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();

                    const dot = document.getElementById('ragStatusDot');
                    const text = document.getElementById('ragStatusText');
                    const statsDiv = document.getElementById('ragIndexStats');
                    const progressBar = document.getElementById('ragProgressBar');
                    const indexBtn = document.getElementById('ragIndexBtn');
                    const stopBtn = document.getElementById('ragStopBtn');
                    const deleteBtn = document.getElementById('ragDeleteBtn');
                    const gpuStatus = document.getElementById('ragGpuStatus');

                    if (!data.available) {
                        dot.className = 'status-dot status-error';
                        text.textContent = 'Project RAG not available (install chromadb)';
                        indexBtn.disabled = true;
                        return;
                    }

                    // Update GPU status
                    if (data.vector_store) {
                        gpuStatus.style.display = 'block';
                        const gpuIcon = document.getElementById('ragGpuIcon');
                        const gpuText = document.getElementById('ragGpuText');
                        if (data.vector_store.gpu_available) {
                            gpuIcon.style.color = 'var(--accent-green)';
                            gpuText.textContent = 'GPU: CUDA Enabled';
                            gpuText.style.color = 'var(--accent-green)';
                        } else {
                            gpuIcon.style.color = 'var(--text-secondary)';
                            gpuText.textContent = 'GPU: CPU Mode';
                            gpuText.style.color = 'var(--text-secondary)';
                        }
                    }

                    // Update index size
                    if (data.vector_store?.disk_size_mb !== undefined) {
                        document.getElementById('ragStatSize').textContent = data.vector_store.disk_size_mb + ' MB';
                    }

                    if (data.is_indexing) {
                        this.isIndexing = true;
                        dot.className = 'status-dot status-warn';
                        text.textContent = 'Indexing in progress...';
                        indexBtn.style.display = 'none';
                        stopBtn.style.display = 'inline-block';
                        deleteBtn.style.display = 'none';
                        progressBar.style.display = 'block';
                        statsDiv.style.display = 'flex';
                        this.startProgressPolling();
                    } else if (data.initialized) {
                        dot.className = 'status-dot status-ok';
                        const state = data.state || {};
                        const projectName = data.current_project ? data.current_project.split('/').pop() : '';
                        text.textContent = `Index ready (${projectName}): ${state.files_indexed || 0} files, ${state.chunks_indexed || 0} chunks`;
                        indexBtn.style.display = 'inline-block';
                        indexBtn.textContent = 'Re-index';
                        stopBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                        progressBar.style.display = 'none';
                        statsDiv.style.display = 'flex';
                        document.getElementById('ragStatFiles').textContent = state.files_indexed || 0;
                        document.getElementById('ragStatChunks').textContent = state.chunks_indexed || 0;
                        document.getElementById('ragStatProgress').textContent = '100%';
                        document.getElementById('ragStatEta').textContent = '-';
                        document.getElementById('ragStatTime').textContent = '-';
                        // Size is already set above from vector_store.disk_size_mb
                    } else if (data.exists) {
                        dot.className = 'status-dot status-warn';
                        const projectName = data.current_project ? data.current_project.split('/').pop() : '';
                        text.textContent = projectName ? `RAG initialized (${projectName}) but not indexed` : 'RAG initialized but not indexed';
                        indexBtn.style.display = 'inline-block';
                        indexBtn.textContent = 'Index Project';
                        stopBtn.style.display = 'none';
                        deleteBtn.style.display = 'inline-block';
                    } else if (data.project_path) {
                        // Project selected but no RAG exists
                        dot.className = 'status-dot';
                        const projectName = data.project_path.split('/').pop();
                        text.textContent = `Project selected (${projectName}) - click Index to create .RAG/`;
                        indexBtn.style.display = 'inline-block';
                        indexBtn.textContent = 'Index Project';
                        stopBtn.style.display = 'none';
                        deleteBtn.style.display = 'none';
                        statsDiv.style.display = 'none';
                        gpuStatus.style.display = 'none';
                    } else {
                        dot.className = 'status-dot';
                        text.textContent = 'Load a project in Project Selection above';
                        indexBtn.style.display = 'inline-block';
                        indexBtn.textContent = 'Index Project';
                        stopBtn.style.display = 'none';
                        deleteBtn.style.display = 'none';
                        statsDiv.style.display = 'none';
                        gpuStatus.style.display = 'none';
                    }

                    // Update RAG tab status if exists
                    const tabStatus = document.getElementById('ragTabStatus');
                    if (tabStatus) {
                        if (data.initialized) {
                            tabStatus.className = 'ast-status available';
                            tabStatus.textContent = `Project RAG active: ${data.state?.files_indexed || 0} files indexed`;
                        } else {
                            tabStatus.className = 'ast-status unavailable';
                            tabStatus.textContent = 'Project RAG not indexed. Go to Dashboard to start indexing.';
                        }
                    }
                } catch (e) {
                    console.error('Failed to check RAG status:', e);
                    document.getElementById('ragStatusDot').className = 'status-dot status-error';
                    document.getElementById('ragStatusText').textContent = 'Error checking RAG status';
                }
            },

            async startIndexing() {
                const profile = document.getElementById('ragProfileSelect').value;
                const projectPath = dashboardApp.currentProject || document.getElementById('dashboardProjectPath').value;

                if (!projectPath) {
                    alert('Please select a project first');
                    return;
                }

                try {
                    // v0.33: First ensure the project path is set (in case user didn't click Load Project)
                    await fetch(`/api/rag/project/set-project?project_path=${encodeURIComponent(projectPath)}`, {
                        method: 'POST'
                    });

                    // First initialize if needed (pass project_path explicitly)
                    await fetch('/api/rag/project/init', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            project_path: projectPath,
                            profile,
                            project_name: projectPath.split('/').pop()
                        })
                    });

                    // Start indexing (pass project_path explicitly)
                    const resp = await fetch('/api/rag/project/index', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            project_path: projectPath,
                            full_reindex: true
                        })
                    });

                    const data = await resp.json();

                    if (data.status === 'started' || data.status === 'already_running') {
                        this.isIndexing = true;
                        this.startProgressPolling();
                        this.checkStatus();
                    } else {
                        alert('Failed to start indexing: ' + (data.message || 'Unknown error'));
                    }
                } catch (e) {
                    console.error('Failed to start indexing:', e);
                    alert('Failed to start indexing: ' + e.message);
                }
            },

            async stopIndexing() {
                try {
                    await fetch('/api/rag/project/stop', { method: 'POST' });
                    this.isIndexing = false;
                    this.stopProgressPolling();
                    this.checkStatus();
                } catch (e) {
                    console.error('Failed to stop indexing:', e);
                }
            },

            async deleteIndex() {
                const projectPath = dashboardApp.currentProject || document.getElementById('dashboardProjectPath').value;
                if (!projectPath) {
                    alert('No project selected');
                    return;
                }

                const projectName = projectPath.split('/').pop();
                if (!confirm(`Delete the RAG index for "${projectName}"?\n\nThis will remove the .RAG/ folder and all indexed data.`)) {
                    return;
                }

                try {
                    const resp = await fetch('/api/rag/project/clear', { method: 'DELETE' });
                    const data = await resp.json();

                    if (data.status === 'cleared') {
                        alert('Index deleted successfully');
                        this.checkStatus();
                    } else {
                        alert('Failed to delete index: ' + (data.message || 'Unknown error'));
                    }
                } catch (e) {
                    console.error('Failed to delete index:', e);
                    alert('Failed to delete index: ' + e.message);
                }
            },

            startProgressPolling() {
                if (this.progressInterval) return;
                this.progressInterval = setInterval(() => this.pollProgress(), 2000);
                this.pollProgress(); // Immediate first poll
            },

            stopProgressPolling() {
                if (this.progressInterval) {
                    clearInterval(this.progressInterval);
                    this.progressInterval = null;
                }
            },

            async pollProgress() {
                try {
                    const resp = await fetch('/api/rag/project/progress');
                    const data = await resp.json();

                    if (!data.is_indexing) {
                        this.isIndexing = false;
                        this.stopProgressPolling();
                        this.checkStatus();
                        return;
                    }

                    // Update progress display
                    document.getElementById('ragStatFiles').textContent = `${data.files_processed || 0}/${data.files_total || 0}`;
                    document.getElementById('ragStatChunks').textContent = data.chunks_indexed || 0;
                    const percent = data.progress_percent?.toFixed(0) || 0;
                    document.getElementById('ragStatProgress').textContent = percent + '%';
                    document.getElementById('ragProgressFill').style.width = percent + '%';

                    // Elapsed time
                    const elapsed = data.elapsed_seconds || 0;
                    document.getElementById('ragStatTime').textContent = this.formatTime(elapsed);

                    // Estimated time remaining
                    let eta = '-';
                    if (percent > 0 && percent < 100) {
                        const remaining = (elapsed / percent) * (100 - percent);
                        eta = this.formatTime(remaining);
                    }
                    document.getElementById('ragStatEta').textContent = eta;

                    const statusText = document.getElementById('ragStatusText');
                    if (data.current_file) {
                        // Truncate filename to max 40 chars to prevent UI resizing
                        let shortFile = data.current_file.split('/').pop();
                        if (shortFile.length > 40) {
                            shortFile = shortFile.substring(0, 37) + '...';
                        }
                        statusText.textContent = `Indexing: ${shortFile}`;
                    }
                } catch (e) {
                    console.error('Failed to poll progress:', e);
                }
            },

            formatTime(seconds) {
                if (seconds < 60) return `${Math.round(seconds)}s`;
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;
                return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
            },

            // Store search results for file viewer
            searchResults: [],

            async search() {
                const query = document.getElementById('ragQueryInput').value.trim();
                const collection = document.getElementById('ragCollectionSelect').value;

                if (!query) {
                    alert('Please enter a search query');
                    return;
                }

                const resultsDiv = document.getElementById('ragResults');
                resultsDiv.innerHTML = '<p style="color: var(--text-secondary);">Searching...</p>';

                try {
                    const resp = await fetch('/api/rag/project/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query, top_k: 10, collection })
                    });

                    const data = await resp.json();

                    if (data.error) {
                        resultsDiv.innerHTML = `<p style="color: var(--accent-red);">${data.error}</p>`;
                        return;
                    }

                    if (!data.results || data.results.length === 0) {
                        resultsDiv.innerHTML = '<p style="color: var(--text-secondary);">No results found.</p>';
                        this.searchResults = [];
                        return;
                    }

                    // Store results for later use
                    this.searchResults = data.results;

                    resultsDiv.innerHTML = data.results.map((r, idx) => `
                        <div class="rag-result-card" data-result-idx="${idx}" style="cursor: pointer;">
                            <div class="rag-result-header">
                                <span class="rag-result-file">${escapeHtml(r.file_path)}</span>
                                <span class="rag-result-score">Score: ${(r.score * 100).toFixed(1)}%</span>
                                <button class="btn btn-sm btn-view" title="View File"></button>
                            </div>
                            <div class="rag-result-content">${escapeHtml(r.content)}</div>
                            <div class="rag-result-lines">Lines ${r.line_start}-${r.line_end}</div>
                        </div>
                    `).join('');

                    // Attach click handlers - pass search result as chunk
                    resultsDiv.querySelectorAll('.rag-result-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const idx = parseInt(card.dataset.resultIdx);
                            const result = this.searchResults[idx];
                            if (!result) return;

                            // Group all results for the same file as chunks
                            const fileResults = this.searchResults.filter(r => r.file_path === result.file_path);
                            const chunks = fileResults.map(r => ({
                                chunk_id: r.chunk_id || `search-${r.line_start}`,
                                line_start: r.line_start,
                                line_end: r.line_end,
                                content: r.content?.substring(0, 200) || '',
                                concepts: [],
                                score: r.score
                            }));

                            projectRagApp.showFileViewer({
                                path: result.file_path,
                                line_start: result.line_start,
                                line_end: result.line_end,
                                chunks: chunks
                            });
                        });
                    });
                } catch (e) {
                    console.error('Search failed:', e);
                    resultsDiv.innerHTML = `<p style="color: var(--accent-red);">Search failed: ${e.message}</p>`;
                }
            },

            async loadStats() {
                try {
                    const projectPath = dashboardApp.currentProject || '';
                    let url = '/api/rag/project/stats';
                    if (projectPath) {
                        url += `?project_path=${encodeURIComponent(projectPath)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();

                    const statsDiv = document.getElementById('ragStatsDetail');
                    if (!data.initialized) {
                        statsDiv.textContent = 'Project RAG not initialized.';
                        // Reset header badges
                        document.getElementById('ragStatsFiles').textContent = '0 files';
                        document.getElementById('ragStatsChunks').textContent = '0 chunks';
                        document.getElementById('ragStatsCode').textContent = '0 code';
                        document.getElementById('ragStatsDocs').textContent = '0 docs';
                        return;
                    }

                    const metadata = data.metadata || {};
                    const vectorStore = data.vector_store || {};
                    const graph = data.graph || {};

                    // Update header stat badges
                    const totalFiles = metadata.total_files || 0;
                    const totalChunks = metadata.total_chunks || 0;
                    const codeChunks = vectorStore.collections?.code?.count || 0;
                    const docsChunks = vectorStore.collections?.docs?.count || 0;

                    document.getElementById('ragStatsFiles').textContent = `${totalFiles} files`;
                    document.getElementById('ragStatsChunks').textContent = `${totalChunks} chunks`;
                    document.getElementById('ragStatsCode').textContent = `${codeChunks} code`;
                    document.getElementById('ragStatsDocs').textContent = `${docsChunks} docs`;

                    statsDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                            <div>
                                <strong>Files</strong><br>
                                Total: ${totalFiles}<br>
                                ${Object.entries(metadata.files_by_kind || {}).map(([k, v]) => `${k}: ${v}`).join('<br>')}
                            </div>
                            <div>
                                <strong>Chunks</strong><br>
                                Total: ${totalChunks}<br>
                                Metadata: ${((metadata.metadata_size_bytes || 0) / 1024).toFixed(1)} KB
                            </div>
                            <div>
                                <strong>Vector Store</strong><br>
                                Mixed: ${vectorStore.collections?.mixed?.count || 0}<br>
                                Code: ${codeChunks}<br>
                                Docs: ${docsChunks}<br>
                                Size: ${vectorStore.disk_size_mb || 0} MB
                            </div>
                        </div>
                    `;

                    // Also load popular concepts
                    this.loadPopularConcepts();
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            },

            // Pagination state for concepts
            conceptsPage: 0,
            conceptsPerPage: 20,
            allConcepts: [],
            totalConcepts: 0,

            async loadPopularConcepts() {
                try {
                    const projectPath = dashboardApp.currentProject || '';
                    // Use settings for max concepts
                    const maxConcepts = this.settings?.maxConcepts || 200;
                    let url = `/api/rag/project/popular-concepts?top_k=${maxConcepts}`;
                    if (projectPath) {
                        url += `&project_path=${encodeURIComponent(projectPath)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();

                    console.debug('Popular concepts response:', data);

                    const conceptsDiv = document.getElementById('ragConceptsList');
                    const paginationDiv = document.querySelector('.rag-concepts-pagination');
                    if (!conceptsDiv) return;

                    // Handle errors from API
                    if (data.error) {
                        console.error('API error:', data.error);
                        conceptsDiv.innerHTML = `<p style="color: var(--accent-orange);">Error: ${escapeHtml(data.error)}</p>`;
                        if (paginationDiv) paginationDiv.style.display = 'none';
                        return;
                    }

                    if (!data.concepts || data.concepts.length === 0) {
                        conceptsDiv.innerHTML = '<p style="color: var(--text-secondary);">No concepts indexed yet.</p>';
                        if (paginationDiv) paginationDiv.style.display = 'none';
                        return;
                    }

                    // Filter by minimum hits threshold from settings
                    // API returns 'mentions' field, not 'count'
                    const minHits = this.settings?.minHits || 1;
                    const filteredConcepts = data.concepts.filter(c => (c.mentions || c.count || 0) >= minHits);

                    // Store filtered concepts for pagination
                    this.allConcepts = filteredConcepts;
                    this.totalConcepts = filteredConcepts.length;
                    this.conceptsPage = 0;

                    // Update concepts count badge
                    const countBadge = document.getElementById('ragConceptsCount');
                    if (countBadge) {
                        countBadge.textContent = this.totalConcepts;
                    }

                    // Show pagination controls
                    if (paginationDiv) paginationDiv.style.display = 'flex';

                    // Render first page
                    this.renderConceptsPage();
                } catch (e) {
                    console.error('Failed to load popular concepts:', e);
                }
            },

            renderConceptsPage() {
                const conceptsDiv = document.getElementById('ragConceptsList');
                if (!conceptsDiv || this.allConcepts.length === 0) return;

                const start = this.conceptsPage * this.conceptsPerPage;
                const end = Math.min(start + this.conceptsPerPage, this.allConcepts.length);
                const pageConcepts = this.allConcepts.slice(start, end);

                // Update pagination info
                const pageInfo = document.getElementById('conceptsPageInfo');
                if (pageInfo) {
                    pageInfo.textContent = `Showing ${start + 1}-${end} of ${this.allConcepts.length}`;
                }

                // Update button states
                const prevBtn = document.getElementById('conceptsPrevBtn');
                const nextBtn = document.getElementById('conceptsNextBtn');
                if (prevBtn) prevBtn.disabled = this.conceptsPage === 0;
                if (nextBtn) nextBtn.disabled = end >= this.allConcepts.length;

                conceptsDiv.innerHTML = `
                    <div class="rag-concepts-grid">
                        ${pageConcepts.map(c => {
                            const safeConcept = c.concept.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            return `
                            <button class="rag-concept-btn" onclick="projectRagApp.exploreConcept('${safeConcept}')"
                                    title="${c.mentions} mentions">
                                ${escapeHtml(c.concept)}
                                <span class="rag-concept-count">${c.mentions}</span>
                            </button>
                        `}).join('')}
                    </div>
                `;
            },

            changeConceptsPage(delta) {
                const maxPage = Math.ceil(this.allConcepts.length / this.conceptsPerPage) - 1;
                const newPage = this.conceptsPage + delta;

                if (newPage >= 0 && newPage <= maxPage) {
                    this.conceptsPage = newPage;
                    this.renderConceptsPage();
                }
            },

            searchConcept(concept) {
                document.getElementById('ragQueryInput').value = concept;
                this.search();
            },

            // Refresh project cache to get fresh ChromaDB connections
            async refreshCache() {
                try {
                    const projectPath = dashboardApp.currentProject || '';
                    let url = '/api/rag/project/refresh';
                    if (projectPath) {
                        url += `?project_path=${encodeURIComponent(projectPath)}`;
                    }
                    await fetch(url, { method: 'POST' });
                } catch (e) {
                    console.debug('Cache refresh failed (non-critical):', e);
                }
            },

            // Change detection notification
            async checkForChanges() {
                try {
                    const projectPath = dashboardApp.currentProject || '';
                    let url = '/api/rag/project/detect-changes';
                    if (projectPath) {
                        url += `?project_path=${encodeURIComponent(projectPath)}`;
                    }
                    const resp = await fetch(url);
                    const data = await resp.json();

                    const notification = document.getElementById('ragChangeNotification');
                    const summary = document.getElementById('ragChangeSummary');

                    if (data.has_changes && data.initialized) {
                        notification.classList.remove('hidden');
                        summary.textContent = data.summary;
                    } else {
                        notification.classList.add('hidden');
                    }
                } catch (e) {
                    console.error('Failed to check for changes:', e);
                }
            },

            dismissNotification() {
                document.getElementById('ragChangeNotification').classList.add('hidden');
            },

            updateIndex() {
                // Start incremental update (not full reindex)
                this.startIndexing(false);
                this.dismissNotification();
            },

            reindexProject() {
                // Full reindex
                this.startIndexing(true);
                this.dismissNotification();
            },

            // Collapsible sections
            toggleSection(sectionName) {
                const sectionMap = {
                    'search': { content: 'ragSearchSection', toggle: 'ragSearchToggle' },
                    'explorer': { content: 'ragExplorerSection', toggle: 'ragExplorerToggle' },
                    'concepts': { content: 'ragConceptsSection', toggle: 'ragConceptsToggle' },
                    'stats': { content: 'ragStatsSection', toggle: 'ragStatsToggle' },
                    'summarize': { content: 'ragSummarizeSection', toggle: 'ragSummarizeToggle' },
                };

                const section = sectionMap[sectionName];
                if (!section) return;

                const content = document.getElementById(section.content);
                const toggle = document.getElementById(section.toggle);

                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    toggle.textContent = '';
                } else {
                    content.classList.add('hidden');
                    toggle.textContent = '';
                }
            },

            // =================================================================
            // Concept Explorer (v0.33.1)
            // =================================================================
            explorerView: 'files',  // 'files' or 'graph'
            explorerData: null,     // Current exploration data
            graphSimulation: null,  // D3 force simulation
            graphZoom: null,        // D3 zoom behavior

            async exploreConcept(concept = null) {
                const input = document.getElementById('ragExploreInput');
                const query = concept || input.value.trim();

                if (!query) {
                    document.getElementById('ragExplorerFiles').innerHTML = '<p style="color: var(--accent-orange);">Please enter a concept to explore.</p>';
                    return;
                }

                input.value = query;

                // Show loading state
                document.getElementById('ragExplorerFiles').innerHTML = `<p style="color: var(--text-secondary);"><span class="spinner"></span> Exploring "${escapeHtml(query)}"...</p>`;

                try {
                    const projectPath = dashboardApp.currentProject || '';
                    let url = '/api/rag/project/concept-explore';
                    if (projectPath) {
                        url += `?project_path=${encodeURIComponent(projectPath)}`;
                    }

                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query, top_k: 30, collection: 'mixed' })
                    });
                    const data = await resp.json();

                    if (data.error) {
                        document.getElementById('ragExplorerFiles').innerHTML = `<p style="color: var(--accent-red);">Error: ${escapeHtml(data.error)}</p>`;
                        return;
                    }

                    this.explorerData = data;

                    // Show recurring tags
                    if (data.recurring_tags && data.recurring_tags.length > 0) {
                        document.getElementById('ragExplorerTags').style.display = 'block';
                        document.getElementById('ragExplorerTagsList').innerHTML = data.recurring_tags.map(t => `
                            <button class="rag-tag-btn" onclick="projectRagApp.exploreConcept('${escapeHtml(t.tag)}')">
                                ${escapeHtml(t.tag)}
                                <span class="rag-tag-count">${t.count}</span>
                            </button>
                        `).join('');
                    } else {
                        document.getElementById('ragExplorerTags').style.display = 'none';
                    }

                    // Render current view
                    if (this.explorerView === 'files') {
                        this.renderFilesView(data);
                    } else {
                        await this.renderGraphView(query);
                    }

                } catch (e) {
                    console.error('Failed to explore concept:', e);
                    document.getElementById('ragExplorerFiles').innerHTML = `<p style="color: var(--accent-red);">Failed to explore: ${e.message}</p>`;
                }
            },

            renderFilesView(data) {
                const container = document.getElementById('ragExplorerFiles');

                if (!data.files || data.files.length === 0) {
                    container.innerHTML = `<p style="color: var(--text-secondary);">No results found for "${escapeHtml(data.query)}".</p>`;
                    return;
                }

                const getFileIcon = (path) => {
                    if (path.endsWith('.java')) return '';
                    if (path.endsWith('.py')) return '';
                    if (path.endsWith('.js') || path.endsWith('.ts')) return '';
                    if (path.endsWith('.md') || path.endsWith('.txt')) return '';
                    if (path.endsWith('.xml') || path.endsWith('.json')) return '';
                    if (path.endsWith('.docx') || path.endsWith('.doc')) return '';
                    return '';
                };

                container.innerHTML = `
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">
                        Found ${data.total_chunks} chunks in ${data.files.length} files
                    </p>
                    ${data.files.map((f, idx) => `
                        <div class="rag-file-group">
                            <div class="rag-file-header" onclick="projectRagApp.toggleFileChunks(${idx})">
                                <span class="rag-file-icon">${getFileIcon(f.path)}</span>
                                <span class="rag-file-name" title="${escapeHtml(f.path)}">${escapeHtml(f.path.split('/').pop())}</span>
                                <span class="rag-file-score">${f.max_score.toFixed(2)}</span>
                                <span class="rag-file-badge">${f.chunk_count}</span>
                                <button class="btn btn-sm btn-view" onclick="event.stopPropagation(); projectRagApp.openFileFromExplorer('${escapeHtml(f.path)}')" title="View File"></button>
                            </div>
                            <div class="rag-file-chunks" id="fileChunks${idx}">
                                ${f.chunks.map(c => `
                                    <div class="rag-chunk-item" onclick="projectRagApp.showChunkDetail('${escapeHtml(c.chunk_id)}', '${escapeHtml(f.path)}', ${c.line_start}, ${c.line_end})"
                                         title="${escapeHtml(f.path)}:${c.line_start}-${c.line_end}">
                                        <span class="rag-chunk-lines">L${c.line_start}-${c.line_end}</span>
                                        <span class="rag-chunk-preview">${escapeHtml(c.preview)}</span>
                                        <span class="rag-chunk-score">${c.score.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                `;

                // Auto-expand first file
                if (data.files.length > 0) {
                    this.toggleFileChunks(0);
                }
            },

            toggleFileChunks(idx) {
                const chunks = document.getElementById(`fileChunks${idx}`);
                if (chunks) {
                    chunks.classList.toggle('expanded');
                }
            },

            showChunkDetail(chunkId, filePath, lineStart, lineEnd) {
                // Get all chunks for this file from explorer data
                const fileChunks = this.getExplorerChunksForFile(filePath);

                // Open file viewer and scroll to the chunk
                this.showFileViewer({
                    path: filePath,
                    line_start: lineStart,
                    line_end: lineEnd,
                    chunk_id: chunkId,
                    concept: this.explorerData?.query || '',
                    chunks: fileChunks  // Pass chunks directly
                });
            },

            openFileFromExplorer(filePath) {
                // Get all chunks for this file from explorer data
                const fileChunks = this.getExplorerChunksForFile(filePath);

                // Open file viewer from the file list
                this.showFileViewer({
                    path: filePath,
                    concept: this.explorerData?.query || '',
                    chunks: fileChunks  // Pass chunks directly
                });
            },

            // Helper to extract chunks for a file from explorer data
            getExplorerChunksForFile(filePath) {
                if (!this.explorerData?.files) return [];

                const file = this.explorerData.files.find(f => f.path === filePath);
                if (!file?.chunks) return [];

                return file.chunks.map(c => ({
                    chunk_id: c.chunk_id,
                    line_start: c.line_start,
                    line_end: c.line_end,
                    content: c.preview || '',
                    concepts: [],
                    score: c.score || 1.0
                }));
            },

            showToast(message) {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; z-index: 1000; font-size: 13px;';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            },

            toggleExplorerView() {
                const filesView = document.getElementById('ragExplorerFiles');
                const graphView = document.getElementById('ragExplorerGraph');
                const icon = document.getElementById('explorerViewIcon');

                if (this.explorerView === 'files') {
                    this.explorerView = 'graph';
                    filesView.style.display = 'none';
                    graphView.style.display = 'block';
                    icon.textContent = '';

                    // Render graph if we have data
                    if (this.explorerData) {
                        const query = document.getElementById('ragExploreInput').value.trim();
                        this.renderGraphView(query);
                    }
                } else {
                    this.explorerView = 'files';
                    filesView.style.display = 'block';
                    graphView.style.display = 'none';
                    icon.textContent = '';
                }
            },

            async renderGraphView(concept) {
                const container = document.getElementById('ragGraphContainer');
                const svg = document.getElementById('ragGraphSvg');

                // Clear previous graph
                svg.innerHTML = '';

                try {
                    const projectPath = dashboardApp.currentProject || '';
                    let url = '/api/rag/project/concept-graph';
                    if (projectPath) {
                        url += `?project_path=${encodeURIComponent(projectPath)}`;
                    }

                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ concept, depth: 2, max_nodes: 40 })
                    });
                    const data = await resp.json();

                    if (data.error || !data.nodes || data.nodes.length === 0) {
                        svg.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="var(--text-secondary)">No graph data available</text>`;
                        return;
                    }

                    // Show related concepts
                    if (data.related_concepts && data.related_concepts.length > 0) {
                        document.getElementById('ragRelatedConcepts').style.display = 'block';
                        document.getElementById('ragRelatedConceptsList').innerHTML = data.related_concepts.map(c => `
                            <button class="rag-related-btn" onclick="projectRagApp.exploreConcept('${escapeHtml(c.label)}')">
                                ${escapeHtml(c.label)}
                                <span style="font-size: 10px; opacity: 0.7;">(${c.co_occurrences})</span>
                            </button>
                        `).join('');
                    } else {
                        document.getElementById('ragRelatedConcepts').style.display = 'none';
                    }

                    this.renderD3Graph(data, svg, container);

                } catch (e) {
                    console.error('Failed to render graph:', e);
                    svg.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="var(--accent-red)">Failed to load graph</text>`;
                }
            },

            renderD3Graph(data, svgElement, container) {
                // Use D3.js for force-directed layout
                if (typeof d3 === 'undefined') {
                    svgElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="var(--text-secondary)">D3.js not loaded</text>`;
                    return;
                }

                const width = container.clientWidth || 600;
                // Use container height in fullscreen, fallback to 400px
                const section = container.closest('.rag-section');
                const isFullscreen = section && section.classList.contains('fullscreen');
                let height = 400;
                if (isFullscreen) {
                    // Use the legend position to calculate available height
                    // The legend sits at the bottom of the graph area
                    const legend = document.getElementById('ragGraphLegend');
                    const containerRect = container.getBoundingClientRect();
                    if (legend) {
                        const legendRect = legend.getBoundingClientRect();
                        // Graph height = from container top to legend top, minus small padding
                        height = Math.max(400, legendRect.top - containerRect.top - 10);
                    } else {
                        // Fallback: use 85% of viewport height minus header
                        height = Math.max(400, window.innerHeight * 0.85 - 100);
                    }
                }

                const svg = d3.select(svgElement)
                    .attr('width', width)
                    .attr('height', height);

                // Create zoom behavior
                const g = svg.append('g');

                const zoom = d3.zoom()
                    .scaleExtent([0.3, 3])
                    .on('zoom', (event) => {
                        g.attr('transform', event.transform);
                    });

                svg.call(zoom);
                this.graphZoom = zoom;

                // Node colors and sizes by type
                const nodeConfig = {
                    concept: { color: '#9c27b0', radius: 20 },
                    chunk: { color: '#2196f3', radius: 8 },
                    file: { color: '#4caf50', radius: 12 }
                };

                // Create force simulation
                const simulation = d3.forceSimulation(data.nodes)
                    .force('link', d3.forceLink(data.edges).id(d => d.id).distance(d => d.type === 'mentions' ? 80 : 50))
                    .force('charge', d3.forceManyBody().strength(-200))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(d => nodeConfig[d.type]?.radius + 5 || 15));

                this.graphSimulation = simulation;

                // Draw edges
                const link = g.append('g')
                    .selectAll('line')
                    .data(data.edges)
                    .join('line')
                    .attr('class', d => `rag-graph-edge ${d.type}`)
                    .attr('stroke-width', d => Math.max(1, d.value * 2));

                // Draw nodes
                const node = g.append('g')
                    .selectAll('circle')
                    .data(data.nodes)
                    .join('circle')
                    .attr('class', d => `rag-graph-node ${d.type}`)
                    .attr('r', d => nodeConfig[d.type]?.radius || 10)
                    .attr('fill', d => nodeConfig[d.type]?.color || '#999')
                    .call(d3.drag()
                        .on('start', (event, d) => {
                            if (!event.active) simulation.alphaTarget(0.3).restart();
                            d.fx = d.x;
                            d.fy = d.y;
                        })
                        .on('drag', (event, d) => {
                            d.fx = event.x;
                            d.fy = event.y;
                        })
                        .on('end', (event, d) => {
                            if (!event.active) simulation.alphaTarget(0);
                            d.fx = null;
                            d.fy = null;
                        }))
                    .on('click', (event, d) => {
                        if (d.type === 'concept') {
                            // Already exploring this concept
                        } else if (d.type === 'file') {
                            this.showFileViewer(d);
                        } else if (d.type === 'chunk') {
                            this.showFileViewer({ path: d.file, line_start: d.line_start, line_end: d.line_end, chunk_id: d.id });
                        }
                    })
                    .on('mouseover', (event, d) => {
                        this.showGraphTooltip(event, d);
                    })
                    .on('mouseout', () => {
                        this.hideGraphTooltip();
                    })
                    .on('mousemove', (event) => {
                        this.moveGraphTooltip(event);
                    });

                // Add labels
                const label = g.append('g')
                    .selectAll('text')
                    .data(data.nodes)
                    .join('text')
                    .attr('class', 'rag-graph-label')
                    .attr('dy', d => d.type === 'concept' ? 30 : (d.type === 'file' ? 20 : 15))
                    .text(d => d.label.length > 15 ? d.label.substring(0, 15) + '...' : d.label);

                // Update positions on tick
                simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);

                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);

                    label
                        .attr('x', d => d.x)
                        .attr('y', d => d.y);
                });

                // Center the view after simulation stabilizes
                simulation.on('end', () => {
                    const bounds = g.node().getBBox();
                    const fullWidth = bounds.width;
                    const fullHeight = bounds.height;
                    const scale = Math.min(0.9 * width / fullWidth, 0.9 * height / fullHeight, 1);
                    const tx = (width - fullWidth * scale) / 2 - bounds.x * scale;
                    const ty = (height - fullHeight * scale) / 2 - bounds.y * scale;

                    svg.transition().duration(500).call(
                        zoom.transform,
                        d3.zoomIdentity.translate(tx, ty).scale(scale)
                    );
                });
            },

            zoomGraph(factor) {
                if (this.graphZoom) {
                    const svg = d3.select('#ragGraphSvg');
                    svg.transition().duration(300).call(
                        this.graphZoom.scaleBy, factor
                    );
                }
            },

            resetGraph() {
                if (this.graphZoom) {
                    const svg = d3.select('#ragGraphSvg');
                    svg.transition().duration(300).call(
                        this.graphZoom.transform,
                        d3.zoomIdentity
                    );
                }
                // Re-render if we have data
                if (this.explorerData) {
                    const query = document.getElementById('ragExploreInput').value.trim();
                    this.renderGraphView(query);
                }
            },

            // Fullscreen state for sections
            fullscreenSections: {},
            _escHandlers: {},

            // Generic fullscreen toggle for any section
            toggleSectionFullscreen(sectionName) {
                const wrapperIds = {
                    'concepts': 'ragConceptsWrapper',
                    'search': 'ragSearchWrapper',
                    'explorer': 'ragExplorerWrapper',
                    'stats': 'ragStatsWrapper',
                    'summarize': 'ragSummarizeWrapper'
                };
                const iconIds = {
                    'concepts': 'conceptsFullscreenIcon',
                    'search': 'searchFullscreenIcon',
                    'explorer': 'explorerFullscreenIcon',
                    'stats': 'statsFullscreenIcon',
                    'summarize': 'summarizeFullscreenIcon'
                };

                const wrapper = document.getElementById(wrapperIds[sectionName]);
                const icon = document.getElementById(iconIds[sectionName]);
                if (!wrapper) return;

                // Close any other fullscreen section first
                Object.keys(this.fullscreenSections).forEach(name => {
                    if (name !== sectionName && this.fullscreenSections[name]) {
                        this.fullscreenSections[name] = false;
                        const otherWrapper = document.getElementById(wrapperIds[name]);
                        if (otherWrapper) otherWrapper.classList.remove('fullscreen');
                        if (this._escHandlers[name]) {
                            document.removeEventListener('keydown', this._escHandlers[name]);
                        }
                    }
                });

                this.fullscreenSections[sectionName] = !this.fullscreenSections[sectionName];

                if (this.fullscreenSections[sectionName]) {
                    wrapper.classList.add('fullscreen');
                    document.body.style.overflow = 'hidden';

                    // Expand the section if collapsed
                    const sectionContent = wrapper.querySelector('.rag-section-content');
                    if (sectionContent && sectionContent.classList.contains('hidden')) {
                        sectionContent.classList.remove('hidden');
                        const toggle = wrapper.querySelector('.rag-section-toggle');
                        if (toggle) toggle.textContent = '';
                    }

                    // Re-render graph if explorer section in graph view
                    if (sectionName === 'explorer' && this.explorerView === 'graph' && this.explorerData) {
                        // Use requestAnimationFrame + timeout for proper layout calculation
                        requestAnimationFrame(() => {
                            // Force layout calculation
                            const container = document.getElementById('ragGraphContainer');
                            if (container) void container.offsetHeight;
                            setTimeout(() => {
                                const query = document.getElementById('ragExploreInput').value.trim();
                                this.renderGraphView(query);
                            }, 150);
                        });
                    }

                    // Add ESC key listener
                    this._escHandlers[sectionName] = (e) => {
                        if (e.key === 'Escape') this.toggleSectionFullscreen(sectionName);
                    };
                    document.addEventListener('keydown', this._escHandlers[sectionName]);
                } else {
                    wrapper.classList.remove('fullscreen');
                    document.body.style.overflow = '';

                    // Remove ESC key listener
                    if (this._escHandlers[sectionName]) {
                        document.removeEventListener('keydown', this._escHandlers[sectionName]);
                    }

                    // Re-render graph to fit normal size
                    if (sectionName === 'explorer' && this.explorerView === 'graph' && this.explorerData) {
                        setTimeout(() => {
                            const query = document.getElementById('ragExploreInput').value.trim();
                            this.renderGraphView(query);
                        }, 100);
                    }
                }
            },

            // Legacy wrapper for backwards compatibility
            toggleExplorerFullscreen() {
                this.toggleSectionFullscreen('explorer');
            },

            // LLM-powered concept summarization
            async summarizeConcept() {
                const input = document.getElementById('ragSummarizeInput');
                const resultsDiv = document.getElementById('ragSummarizeResults');
                const concept = input.value.trim();

                if (!concept) {
                    resultsDiv.innerHTML = '<p style="color: var(--accent-orange);">Please enter a concept to summarize.</p>';
                    return;
                }

                // Get the model from settings (same as chat tab)
                const modelSelect = document.getElementById('modelInput');
                const model = modelSelect ? modelSelect.value : 'mistral';

                resultsDiv.innerHTML = `<p style="color: var(--text-secondary);"><span class="spinner"></span> Generating summary for "${escapeHtml(concept)}" using ${model}...</p>`;

                try {
                    const projectPath = dashboardApp.currentProject || '';
                    let url = `/api/rag/project/summarize?concept=${encodeURIComponent(concept)}&model=${encodeURIComponent(model)}`;
                    if (projectPath) {
                        url += `&project_path=${encodeURIComponent(projectPath)}`;
                    }
                    const resp = await fetch(url, { method: 'POST' });
                    const data = await resp.json();

                    if (data.error) {
                        resultsDiv.innerHTML = `<p style="color: var(--accent-red);">Error: ${escapeHtml(data.error)}</p>`;
                        return;
                    }

                    // Display summary with citations
                    let html = `<div class="rag-summary-text">${this.formatSummaryText(data.summary || 'No summary generated.')}</div>`;

                    // Show model used
                    if (data.model) {
                        html += `<p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">Generated by: ${escapeHtml(data.model)}</p>`;
                    }

                    if (data.citations && data.citations.length > 0) {
                        html += `
                            <div class="rag-summary-citations">
                                <h4>Sources (${data.citations.length})</h4>
                                ${data.citations.map((c, i) => `
                                    <div class="rag-citation-item" onclick="projectRagApp.searchConcept('${escapeHtml(c.file_path || '')}')">
                                        <span class="rag-citation-num">[${i + 1}]</span>
                                        <span>${escapeHtml(c.file_path || 'Unknown')}:${c.line_start || '?'}-${c.line_end || '?'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    resultsDiv.innerHTML = html;
                } catch (e) {
                    console.error('Failed to summarize concept:', e);
                    resultsDiv.innerHTML = `<p style="color: var(--accent-red);">Failed to generate summary: ${e.message}</p>`;
                }
            },

            // Format summary text with paragraph breaks
            formatSummaryText(text) {
                // Convert newlines to <br> and escape HTML
                return escapeHtml(text).replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // Settings management
            settings: {
                maxConcepts: 200,
                minHits: 1,
                forceStrength: -300,
                nodeSizeFactor: 1.0,
                linkDistance: 80,
                searchLimit: 20
            },

            openSettings() {
                const modal = document.getElementById('ragSettingsModal');
                modal.style.display = 'flex';

                // Populate current settings
                document.getElementById('ragSettingMaxConcepts').value = this.settings.maxConcepts;
                document.getElementById('ragSettingMinHits').value = this.settings.minHits;
                document.getElementById('ragSettingForceStrength').value = this.settings.forceStrength;
                document.getElementById('ragSettingNodeSize').value = this.settings.nodeSizeFactor;
                document.getElementById('ragSettingLinkDistance').value = this.settings.linkDistance;
                document.getElementById('ragSettingSearchLimit').value = this.settings.searchLimit;
            },

            closeSettings() {
                document.getElementById('ragSettingsModal').style.display = 'none';
            },

            resetSettings() {
                document.getElementById('ragSettingMaxConcepts').value = 200;
                document.getElementById('ragSettingMinHits').value = 1;
                document.getElementById('ragSettingForceStrength').value = -300;
                document.getElementById('ragSettingNodeSize').value = 1.0;
                document.getElementById('ragSettingLinkDistance').value = 80;
                document.getElementById('ragSettingSearchLimit').value = 20;
            },

            saveSettings() {
                // Update settings object
                this.settings.maxConcepts = parseInt(document.getElementById('ragSettingMaxConcepts').value) || 200;
                this.settings.minHits = parseInt(document.getElementById('ragSettingMinHits').value) || 1;
                this.settings.forceStrength = parseInt(document.getElementById('ragSettingForceStrength').value) || -300;
                this.settings.nodeSizeFactor = parseFloat(document.getElementById('ragSettingNodeSize').value) || 1.0;
                this.settings.linkDistance = parseInt(document.getElementById('ragSettingLinkDistance').value) || 80;
                this.settings.searchLimit = parseInt(document.getElementById('ragSettingSearchLimit').value) || 20;

                // Close modal
                this.closeSettings();

                // Reload concepts with new settings
                this.loadPopularConcepts();

                // If graph is visible, update it
                if (this.currentGraphData) {
                    this.updateGraphWithSettings();
                }
            },

            updateGraphWithSettings() {
                // Re-create the force simulation with new settings if it exists
                if (this.simulation) {
                    this.simulation
                        .force('charge', d3.forceManyBody().strength(this.settings.forceStrength))
                        .force('link', d3.forceLink().id(d => d.id).distance(this.settings.linkDistance))
                        .alpha(1)
                        .restart();
                }
            },

            // Graph tooltip functions
            showGraphTooltip(event, d) {
                const tooltip = document.getElementById('ragGraphTooltip');
                if (!tooltip) return;

                let content = '';
                if (d.type === 'concept') {
                    content = `<div class="tooltip-title"> Concept</div>
                        <div class="tooltip-path">${escapeHtml(d.label)}</div>
                        <div class="tooltip-meta">Click to explore related files</div>`;
                } else if (d.type === 'file') {
                    const fileName = (d.path || d.label).split('/').pop();
                    content = `<div class="tooltip-title"> ${escapeHtml(fileName)}</div>
                        <div class="tooltip-path">${escapeHtml(d.path || d.label)}</div>
                        ${d.chunks_count ? `<div class="tooltip-lines">${d.chunks_count} chunks</div>` : ''}
                        <div class="tooltip-meta">Click to open file viewer</div>`;
                } else if (d.type === 'chunk') {
                    const fileName = (d.file || '').split('/').pop();
                    content = `<div class="tooltip-title"> Chunk: ${escapeHtml(fileName)}</div>
                        <div class="tooltip-path">${escapeHtml(d.file || '')}</div>
                        <div class="tooltip-lines">Lines ${d.line_start || '?'}-${d.line_end || '?'}</div>
                        <div class="tooltip-meta">Click to view chunk in context</div>`;
                }

                tooltip.innerHTML = content;
                tooltip.style.display = 'block';
                this.moveGraphTooltip(event);
            },

            hideGraphTooltip() {
                const tooltip = document.getElementById('ragGraphTooltip');
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
            },

            moveGraphTooltip(event) {
                const tooltip = document.getElementById('ragGraphTooltip');
                const container = document.getElementById('ragGraphContainer');
                if (!tooltip || !container) return;

                const rect = container.getBoundingClientRect();
                let x = event.clientX - rect.left + 15;
                let y = event.clientY - rect.top + 15;

                // Keep tooltip within container bounds
                if (x + tooltip.offsetWidth > rect.width - 10) {
                    x = event.clientX - rect.left - tooltip.offsetWidth - 15;
                }
                if (y + tooltip.offsetHeight > rect.height - 10) {
                    y = event.clientY - rect.top - tooltip.offsetHeight - 15;
                }

                tooltip.style.left = x + 'px';
                tooltip.style.top = y + 'px';
            },

            // File viewer state
            currentFileData: null,
            currentChunkIndex: 0,
            fileViewerChunks: [],

            async showFileViewer(fileData) {
                const path = fileData.path || fileData.file;
                if (!path) {
                    this.showToast('No file path available');
                    return;
                }

                const modal = document.getElementById('ragFileViewerModal');
                const contentDiv = document.getElementById('fileViewerContent');
                modal.style.display = 'flex';

                // Show loading state
                contentDiv.innerHTML = '<pre><code>Loading file...</code></pre>';

                try {
                    const projectPath = dashboardApp.currentProject || '';
                    const concept = fileData.concept || this.explorerData?.query || '';
                    let url = `/api/rag/project/file-view?file_path=${encodeURIComponent(path)}`;
                    if (projectPath) url += `&project_path=${encodeURIComponent(projectPath)}`;
                    if (concept) url += `&concept=${encodeURIComponent(concept)}`;

                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error(await resp.text());
                    const data = await resp.json();

                    // Priority 1: Use chunks passed directly (from Explorer)
                    if (fileData.chunks && fileData.chunks.length > 0) {
                        data.chunks = fileData.chunks;
                    }
                    // Priority 2: If still no chunks but we have line range, create synthetic chunk
                    else if ((!data.chunks || data.chunks.length === 0) && fileData.line_start && fileData.line_end) {
                        data.chunks = [{
                            chunk_id: fileData.chunk_id || 'search-result',
                            line_start: fileData.line_start,
                            line_end: fileData.line_end,
                            content: 'Search result match',
                            concepts: concept ? [concept] : [],
                            score: 1.0
                        }];
                    }

                    this.currentFileData = data;
                    this.fileViewerChunks = data.chunks || [];
                    this.currentChunkIndex = 0;

                    // If a specific chunk was requested, find its index
                    if (fileData.chunk_id && this.fileViewerChunks.length > 0) {
                        const idx = this.fileViewerChunks.findIndex(c => c.chunk_id === fileData.chunk_id);
                        if (idx >= 0) this.currentChunkIndex = idx;
                    }

                    this.renderFileContent(data, fileData.line_start);

                } catch (e) {
                    console.error('Failed to load file:', e);
                    contentDiv.innerHTML = `<pre><code style="color: var(--accent-red);">Failed to load file: ${escapeHtml(e.message)}</code></pre>`;
                }
            },

            renderFileContent(data, scrollToLine = null) {
                // Update header with format-aware icons
                const iconMap = {
                    'python': '', 'javascript': '', 'typescript': '',
                    'java': '', 'html': '', 'css': '', 'json': '',
                    'markdown': '', 'bash': '', 'sql': ''
                };
                const formatIcons = {
                    'document': '', 'presentation': '', 'spreadsheet': '', 'pdf': ''
                };
                const formatLabels = {
                    'document': 'Document', 'presentation': 'Presentation',
                    'spreadsheet': 'Spreadsheet', 'pdf': 'PDF', 'code': 'Code'
                };

                const icon = data.format_type && data.format_type !== 'code'
                    ? formatIcons[data.format_type] || ''
                    : iconMap[data.language] || '';
                const langLabel = data.format_type && data.format_type !== 'code'
                    ? formatLabels[data.format_type]
                    : data.language;

                const chunks = data.chunks || [];
                const numChunks = chunks.length;

                document.getElementById('fileViewerIcon').textContent = icon;
                document.getElementById('fileViewerName').textContent = data.file_name;
                document.getElementById('fileViewerPath').textContent = data.file_path;
                document.getElementById('fileViewerLines').textContent = `${data.line_count} lines`;
                document.getElementById('fileViewerChunks').textContent = `${numChunks} chunk${numChunks !== 1 ? 's' : ''}`;
                document.getElementById('fileViewerLang').textContent = langLabel;

                // Show/hide chunk navigation
                const chunkNav = document.getElementById('fileViewerChunkNav');
                if (numChunks > 1) {
                    chunkNav.style.display = 'flex';
                    this.updateChunkNavPosition();
                } else {
                    chunkNav.style.display = 'none';
                }

                // Build line-to-chunk map for highlighting
                const lineChunks = {};
                const chunkColors = {};
                chunks.forEach((chunk, idx) => {
                    const colorIdx = idx % 6;
                    chunkColors[chunk.chunk_id] = colorIdx;
                    for (let line = chunk.line_start; line <= chunk.line_end; line++) {
                        if (!lineChunks[line]) lineChunks[line] = [];
                        lineChunks[line].push({ ...chunk, colorIdx });
                    }
                });

                // Determine render mode based on file type
                const isMarkdown = data.language === 'markdown' ||
                                   data.format_type === 'document' ||
                                   data.format_type === 'presentation' ||
                                   data.file_name?.endsWith('.md');
                const isXml = data.language === 'xml' ||
                              data.file_name?.endsWith('.xml') ||
                              data.file_name?.endsWith('.pom') ||
                              data.file_name?.endsWith('.xsd') ||
                              data.file_name?.endsWith('.xsl');
                const isHtml = data.language === 'html' ||
                               data.file_name?.endsWith('.html') ||
                               data.file_name?.endsWith('.htm');

                const contentDiv = document.getElementById('fileViewerContent');
                const lines = data.lines || data.content.split('\n');

                if (isMarkdown && typeof marked !== 'undefined') {
                    // Render as Markdown with chunk highlighting
                    let mdContent = '';
                    let currentChunkIdx = -1;

                    lines.forEach((line, idx) => {
                        const lineNum = idx + 1;
                        const lineChunkList = lineChunks[lineNum] || [];

                        if (lineChunkList.length > 0) {
                            const chunkIdx = lineChunkList[0].colorIdx;
                            if (currentChunkIdx !== chunkIdx) {
                                if (currentChunkIdx >= 0) mdContent += '\n</div>\n';
                                mdContent += `<div class="md-chunk-highlight md-chunk-${chunkIdx}" data-chunk-line="${lineNum}">\n`;
                                currentChunkIdx = chunkIdx;
                            }
                        } else if (currentChunkIdx >= 0) {
                            mdContent += '\n</div>\n';
                            currentChunkIdx = -1;
                        }
                        mdContent += line + '\n';
                    });
                    if (currentChunkIdx >= 0) mdContent += '\n</div>\n';

                    // Render markdown
                    try {
                        const rendered = marked.parse(mdContent);
                        contentDiv.innerHTML = `<div class="markdown-body file-viewer-markdown">${rendered}</div>`;
                    } catch (e) {
                        // Fallback to plain text
                        contentDiv.innerHTML = `<pre><code>${escapeHtml(lines.join('\n'))}</code></pre>`;
                    }
                } else if (isXml || isHtml) {
                    // Render XML/HTML with syntax highlighting and structure
                    const html = this.renderXmlContent(lines, lineChunks, isHtml);
                    contentDiv.innerHTML = html;
                } else {
                    // Render as code with line numbers
                    const html = lines.map((line, idx) => {
                        const lineNum = idx + 1;
                        const lineChunkList = lineChunks[lineNum] || [];
                        const highlightClass = lineChunkList.length > 0 ? `chunk-highlight chunk-highlight-${lineChunkList[0].colorIdx}` : '';

                        return `<div class="file-viewer-line ${highlightClass}" data-line="${lineNum}">
                            <span class="file-viewer-line-num">${lineNum}</span>
                            <span class="file-viewer-line-content">${escapeHtml(line) || ' '}</span>
                        </div>`;
                    }).join('');

                    contentDiv.innerHTML = `<pre><code>${html}</code></pre>`;
                }

                // Render chunk legend
                const legendDiv = document.getElementById('fileViewerLegend');
                const chunkListDiv = document.getElementById('fileViewerChunkList');
                if (numChunks > 0) {
                    legendDiv.style.display = 'flex';
                    chunkListDiv.innerHTML = chunks.map((chunk, idx) => {
                        const colorIdx = idx % 6;
                        const isActive = idx === this.currentChunkIndex;
                        return `<div class="chunk-legend-item ${isActive ? 'active' : ''}" data-chunk-idx="${idx}" onclick="projectRagApp.goToChunk(${idx})">
                            <span class="chunk-legend-dot color-${colorIdx}"></span>
                            <span>L${chunk.line_start}-${chunk.line_end}</span>
                        </div>`;
                    }).join('');
                } else {
                    legendDiv.style.display = 'none';
                }

                // Scroll to line if specified, otherwise scroll to first chunk
                if (scrollToLine) {
                    setTimeout(() => this.scrollToLine(scrollToLine), 100);
                } else if (numChunks > 0) {
                    setTimeout(() => this.scrollToLine(chunks[0].line_start), 100);
                }
            },

            updateChunkNavPosition() {
                const pos = document.getElementById('fileViewerChunkPos');
                const total = this.fileViewerChunks.length;
                pos.textContent = `${this.currentChunkIndex + 1}/${total}`;
            },

            prevChunk() {
                if (this.fileViewerChunks.length === 0) return;
                this.currentChunkIndex = (this.currentChunkIndex - 1 + this.fileViewerChunks.length) % this.fileViewerChunks.length;
                this.goToChunk(this.currentChunkIndex);
            },

            nextChunk() {
                if (this.fileViewerChunks.length === 0) return;
                this.currentChunkIndex = (this.currentChunkIndex + 1) % this.fileViewerChunks.length;
                this.goToChunk(this.currentChunkIndex);
            },

            goToChunk(idx) {
                if (idx < 0 || idx >= this.fileViewerChunks.length) return;
                this.currentChunkIndex = idx;
                this.updateChunkNavPosition();

                // Update legend active state
                document.querySelectorAll('.chunk-legend-item').forEach((el, i) => {
                    el.classList.toggle('active', i === idx);
                });

                // Scroll to chunk
                const chunk = this.fileViewerChunks[idx];
                this.scrollToLine(chunk.line_start);
            },

            // Render XML/HTML with syntax highlighting
            renderXmlContent(lines, lineChunks, isHtml) {
                const highlightXml = (text) => {
                    // Escape HTML first
                    let escaped = escapeHtml(text);

                    // Highlight XML/HTML structure
                    // Comments
                    escaped = escaped.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="xml-comment">$1</span>');
                    // CDATA
                    escaped = escaped.replace(/(&lt;!\[CDATA\[[\s\S]*?\]\]&gt;)/g, '<span class="xml-cdata">$1</span>');
                    // Tags and attributes
                    escaped = escaped.replace(/(&lt;\/?)([\w:-]+)/g, '$1<span class="xml-tag">$2</span>');
                    // Attribute names
                    escaped = escaped.replace(/\s([\w:-]+)(=)/g, ' <span class="xml-attr">$1</span>$2');
                    // Attribute values
                    escaped = escaped.replace(/(=)(&quot;[^&]*&quot;|&#39;[^&]*&#39;)/g, '$1<span class="xml-value">$2</span>');
                    // Self-closing and closing brackets
                    escaped = escaped.replace(/(\/?&gt;)/g, '<span class="xml-bracket">$1</span>');
                    // Opening brackets
                    escaped = escaped.replace(/(&lt;)/g, '<span class="xml-bracket">$1</span>');

                    return escaped;
                };

                const html = lines.map((line, idx) => {
                    const lineNum = idx + 1;
                    const lineChunkList = lineChunks[lineNum] || [];
                    const highlightClass = lineChunkList.length > 0 ? `chunk-highlight chunk-highlight-${lineChunkList[0].colorIdx}` : '';

                    return `<div class="file-viewer-line xml-line ${highlightClass}" data-line="${lineNum}">
                        <span class="file-viewer-line-num">${lineNum}</span>
                        <span class="file-viewer-line-content">${highlightXml(line) || ' '}</span>
                    </div>`;
                }).join('');

                return `<pre><code class="xml-content">${html}</code></pre>`;
            },

            scrollToLine(lineNum) {
                // Try code view first
                const lineEl = document.querySelector(`.file-viewer-line[data-line="${lineNum}"]`);
                if (lineEl) {
                    lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    lineEl.style.animation = 'highlight-flash 1s ease-out';
                    setTimeout(() => lineEl.style.animation = '', 1000);
                    return;
                }

                // Try Markdown chunk view
                const mdChunk = document.querySelector(`.md-chunk-highlight[data-chunk-line="${lineNum}"]`);
                if (mdChunk) {
                    mdChunk.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    mdChunk.style.animation = 'highlight-flash 1s ease-out';
                    setTimeout(() => mdChunk.style.animation = '', 1000);
                }
            },

            closeFileViewer() {
                document.getElementById('ragFileViewerModal').style.display = 'none';
                this.currentFileData = null;
            },

            openFileInNewWindow() {
                if (!this.currentFileData) return;
                const data = this.currentFileData;

                // Create standalone HTML
                const iconMap = {
                    'python': '', 'javascript': '', 'typescript': '',
                    'java': '', 'html': '', 'css': ''
                };
                const icon = iconMap[data.language] || '';

                const lines = data.lines || data.content.split('\n');
                const lineChunks = {};
                (data.chunks || []).forEach((chunk, idx) => {
                    const colorIdx = idx % 6;
                    for (let line = chunk.line_start; line <= chunk.line_end; line++) {
                        if (!lineChunks[line]) lineChunks[line] = colorIdx;
                    }
                });

                const codeHtml = lines.map((line, idx) => {
                    const lineNum = idx + 1;
                    const colorIdx = lineChunks[lineNum];
                    const bg = colorIdx !== undefined ? `background: var(--chunk-${colorIdx});` : '';
                    return `<div style="${bg}"><span style="opacity:0.5;width:50px;display:inline-block;text-align:right;padding-right:16px;">${lineNum}</span>${this.escapeHtmlForNewWindow(line) || ' '}</div>`;
                }).join('');

                const html = `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<title>${icon} ${data.file_name}</title>
<style>
:root {
    --chunk-0: rgba(59, 130, 246, 0.15);
    --chunk-1: rgba(139, 92, 246, 0.15);
    --chunk-2: rgba(34, 197, 94, 0.15);
    --chunk-3: rgba(245, 158, 11, 0.15);
    --chunk-4: rgba(239, 68, 68, 0.15);
    --chunk-5: rgba(236, 72, 153, 0.15);
}
body { margin: 0; padding: 20px; background: #1e1e1e; color: #d4d4d4; font-family: monospace; }
h1 { font-size: 16px; margin: 0 0 8px 0; }
.path { font-size: 12px; color: #888; margin-bottom: 16px; }
pre { margin: 0; font-size: 13px; line-height: 1.5; }
</style>
</head><body>
<h1>${icon} ${data.file_name}</h1>
<div class="path">${data.file_path}</div>
<pre>${codeHtml}</pre>
</body></html>`;

                const newWindow = window.open('', '_blank');
                newWindow.document.write(html);
                newWindow.document.close();
            },

            escapeHtmlForNewWindow(text) {
                return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            },

            copyFilePath() {
                if (!this.currentFileData) return;
                navigator.clipboard.writeText(this.currentFileData.absolute_path || this.currentFileData.file_path);
                this.showToast('Path copied to clipboard');
            }
        };

        // Initialize Project RAG app
        projectRagApp.init();

        // Auto-refresh RAG status when switching to RAG tab
        document.querySelector('.nav-tab[data-tab="rag"]').addEventListener('click', async () => {
            // Refresh cache first to get fresh ChromaDB connections
            await projectRagApp.refreshCache();
            projectRagApp.checkStatus();
            projectRagApp.loadStats();
            projectRagApp.checkForChanges();
        });

        // Auto-refresh logs when switching to logs tab
        document.querySelector('.nav-tab[data-tab="logs"]').addEventListener('click', () => {
            logsApp.refresh();
        });

        // Auto-refresh reasoning when switching to reasoning tab
        document.querySelector('.nav-tab[data-tab="reasoning"]').addEventListener('click', () => {
            reasoningApp.refresh();
            // Also refresh agent config to update Planner/Worker/Verifier display
            agentSettingsApp.loadConfig();
        });

        // Override app.saveSettings to handle unified model configuration
        // Model hierarchy: Session  Agent Config  Reasoning (all inherit)
        if (typeof app !== 'undefined') {
            const originalSaveSettings = app.saveSettings.bind(app);
            app.saveSettings = async function() {
                // Get the session model from the Session tab (single source of truth)
                const sessionModel = document.getElementById('modelInput').value;

                // First, call original saveSettings which creates the new session
                await originalSaveSettings();

                // Update sessionIdInput to the new session ID so config loads use correct session
                const sessionIdInput = document.getElementById('sessionIdInput');
                if (sessionIdInput && app.sessionId) {
                    sessionIdInput.value = app.sessionId;
                }

                // Wait a moment for WebSocket to connect and agent to initialize
                await new Promise(resolve => setTimeout(resolve, 500));

                // Now that session exists, the agent will be created with session model
                // The agent config in MINIMAL mode automatically inherits from session
                // No need to save agent config separately - it inherits from session

                // Refresh all displays to show the new model
                await agentSettingsApp.loadConfig();
                await reasoningSettingsApp.loadConfig();

                // Update the reasoning panel display
                const modelDisplay = document.getElementById('reasoningModelDisplay');
                if (modelDisplay) {
                    modelDisplay.textContent = sessionModel || 'Not set';
                }
            };

            // Also override openSettings to load agent config
            const originalOpenSettings = app.openSettings.bind(app);
            app.openSettings = async function() {
                if (originalOpenSettings) {
                    await originalOpenSettings();
                }
                // Load agent and reasoning configs after session info is loaded
                await agentSettingsApp.loadConfig();
                await reasoningSettingsApp.loadConfig();
                // v0.33: Load context limits
                memoryApp.loadContextLimits();
            };
        }

        // Sidebar toggle functions
        // v0.33: Sidebar state management
        const sidebarState = {
            width: 280,
            minWidth: 200,
            maxWidth: 600,
            collapsed: false
        };

        function toggleSidebar() {
            const sidebar = document.getElementById('chatSidebar');
            const toggle = document.getElementById('sidebarToggle');
            sidebarState.collapsed = sidebar.classList.toggle('collapsed');
            toggle.innerHTML = sidebarState.collapsed ? '&#9654;' : '&#9664;';
            toggle.style.left = sidebarState.collapsed ? '0px' : sidebarState.width + 'px';
        }

        function toggleSidebarSection(headerEl) {
            const section = headerEl.closest('.sidebar-section');
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        // v0.33: Sidebar resize functionality
        function initSidebarResize() {
            const sidebar = document.getElementById('chatSidebar');
            const handle = document.getElementById('sidebarResizeHandle');
            const toggle = document.getElementById('sidebarToggle');

            if (!sidebar || !handle) return;

            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            handle.addEventListener('mousedown', (e) => {
                if (sidebarState.collapsed) return;
                isResizing = true;
                startX = e.clientX;
                startWidth = sidebar.offsetWidth;
                sidebar.classList.add('resizing');
                handle.classList.add('active');
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const diff = e.clientX - startX;
                let newWidth = startWidth + diff;

                // Clamp to min/max
                newWidth = Math.max(sidebarState.minWidth, Math.min(sidebarState.maxWidth, newWidth));

                sidebar.style.width = newWidth + 'px';
                sidebarState.width = newWidth;

                // Update toggle position
                if (toggle) {
                    toggle.style.left = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    sidebar.classList.remove('resizing');
                    handle.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // Save to localStorage
                    localStorage.setItem('ragix_sidebar_width', sidebarState.width);
                }
            });

            // Restore saved width
            const savedWidth = localStorage.getItem('ragix_sidebar_width');
            if (savedWidth) {
                const width = parseInt(savedWidth, 10);
                if (width >= sidebarState.minWidth && width <= sidebarState.maxWidth) {
                    sidebarState.width = width;
                    sidebar.style.width = width + 'px';
                    if (toggle) {
                        toggle.style.left = width + 'px';
                    }
                }
            }
        }

        // Initialize sidebar toggle position and resize
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('sidebarToggle');
            if (toggle) {
                toggle.style.left = sidebarState.width + 'px';
            }
            initSidebarResize();
        });

        // =============================================================================
        // Single-Page Export Utility (reusable for all reports)
        // =============================================================================

        /**
         * Save any iframe content as a self-contained HTML file.
         * Works with AST reports, Audit reports, and any other HTML content.
         *
         * @param {HTMLIFrameElement} iframe - The iframe containing the content
         * @param {string} filename - The filename for download
         */
        function saveIframeAsHtml(iframe, filename) {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                if (!doc) {
                    alert('Cannot access iframe content. Try using the Save button in the report itself.');
                    return;
                }

                // Clone the document
                const html = doc.documentElement.cloneNode(true);

                // Remove any no-print elements and export bars
                html.querySelectorAll('.no-print, .export-bar').forEach(el => el.remove());

                // Remove scripts (they won't work in saved file anyway)
                html.querySelectorAll('script').forEach(s => s.remove());

                // Get full HTML
                const fullHtml = '<!DOCTYPE html>\n' + html.outerHTML;

                // Download
                const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'report.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (e) {
                console.error('Failed to save iframe:', e);
                alert('Failed to save: ' + e.message + '. Try using Print to PDF instead.');
            }
        }

        /**
         * Convert current page section to self-contained HTML and download.
         * Useful for saving dashboard sections as reports.
         *
         * @param {string} selector - CSS selector for the content to save
         * @param {string} filename - The filename for download
         * @param {object} options - Optional styling/title overrides
         */
        function saveElementAsHtml(selector, filename, options = {}) {
            const element = document.querySelector(selector);
            if (!element) {
                alert('Content not found: ' + selector);
                return;
            }

            // Get computed styles
            const styles = document.querySelectorAll('style');
            let cssText = '';
            styles.forEach(s => { cssText += s.textContent + '\n'; });

            // Build standalone HTML
            const title = options.title || document.title;
            const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        ${cssText}
        body { background: #0d1117; color: #e6edf3; padding: 20px; }
    </style>
</head>
<body>
    ${element.outerHTML}
    <footer style="text-align: center; margin-top: 30px; color: #8b949e; font-size: 12px;">
        <p>Generated by RAGIX | ${new Date().toLocaleString()}</p>
        <p>Olivier Vitrac, PhD, HDR | Adservio</p>
    </footer>
</body>
</html>`;

            // Download
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename || 'export.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Add export buttons to a visualization container.
         * Call this after loading content into an iframe.
         *
         * @param {string} containerId - ID of the container element
         * @param {string} iframeId - ID of the iframe
         * @param {string} baseName - Base filename for exports
         */
        function addExportButtons(containerId, iframeId, baseName) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Check if buttons already exist
            if (container.querySelector('.export-buttons')) return;

            const iframe = document.getElementById(iframeId);
            const exportDiv = document.createElement('div');
            exportDiv.className = 'export-buttons';
            exportDiv.style.cssText = 'position: absolute; top: 10px; right: 60px; display: flex; gap: 8px; z-index: 100;';

            exportDiv.innerHTML = `
                <button class="btn btn-sm" onclick="window.frames['${iframeId}'].print()" title="Print / PDF">
                    &#128424; Print
                </button>
                <button class="btn btn-sm" onclick="saveIframeAsHtml(document.getElementById('${iframeId}'), '${baseName}-${new Date().toISOString().slice(0,10)}.html')" title="Save as HTML">
                    &#128190; Save
                </button>
            `;

            container.appendChild(exportDiv);
        }
    </script>

    <!-- Author Footer -->
    <footer class="author-footer">
        <span>Olivier Vitrac, PhD, HDR</span>
        <span class="separator">|</span>
        <span>Adservio</span>
        <span class="separator">|</span>
        <a href="mailto:olivier.vitrac@adservio.fr" title="Contact">olivier.vitrac@adservio.fr</a>
    </footer>
</body>
</html>
